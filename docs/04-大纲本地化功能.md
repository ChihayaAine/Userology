# 大纲本地化功能

> **版本**: 1.4.5
> **实现日期**: 2025-10-23
> **最后更新**: 2025-10-31
> **优先级**: P1
> **状态**: ✅ 已完成

---

## 📋 功能概述

### 问题背景

在跨语言用户研究场景中，研究员面临以下挑战：

1. **语言障碍**: 研究员可能不熟悉访谈目标语言，难以直接用该语言设计和优化访谈大纲
2. **质量保证**: 简单的机器翻译无法满足文化适配需求，容易产生不地道的表达
3. **效率问题**: 需要在熟悉的语言下快速迭代大纲，最后再转换为目标语言

### 解决方案

实现**两步走大纲创建流程**：

```
初版生成（调试语言） → 调试优化 → 一键本地化（访谈语言）
```

**核心价值**:
- ✅ 研究员用熟悉的语言调试大纲
- ✅ AI 深度本地化到目标语言
- ✅ 保留两个版本便于对比和审查
- ✅ 提升跨语言研究的效率和质量

---

## 🎯 功能特性

### 1. 调试语言选择

**位置**: 创建研究页面（仅 Deep Dive 模式）

**功能**:
- 选择用于生成和调试大纲的语言
- 支持所有主流语言（中文、英文、日文、法文等）
- 独立于访谈语言设置

**使用场景**:
```
访谈语言: 英文
调试语言: 中文
→ 用中文生成和调试大纲，最后本地化为英文
```

### 2. 初稿生成

**功能**:
- 使用调试语言生成初版大纲
- 生成的 sessions 完全使用调试语言
- 便于研究员理解和优化

**技术实现**:
```typescript
// 优先使用 outline_debug_language
const debugLanguage = body.outline_debug_language || body.language || 'en-US';

const promptBody = {
  ...body,
  language: debugLanguage
};
```

### 3. 一键本地化

**位置**: 大纲编辑页面

**功能**:
- 点击"一键本地化"按钮
- AI 深度本地化到访谈语言
- 保持原有结构和逻辑
- 文化适配而非简单翻译

**本地化策略**:
1. **语言真实性**: 使用目标语言的地道表达
2. **文化敏感性**: 考虑文化差异（礼貌程度、敏感话题等）
3. **专业性**: 保持访谈员的专业形象
4. **自然度**: 符合目标语言的对话习惯

**API 接口**:
```
POST /api/questions/localize-outline

Request:
{
  "draftOutline": [...],
  "targetLanguage": "en-US",
  "researchObjective": "...",
  "studyName": "..."
}

Response:
{
  "response": "{\"questions\": [...]}"
}
```

### 4. 版本切换

**功能**:
- 在初稿和本地化版本之间切换查看
- 实时切换，无需重新加载
- 本地化版本为只读，防止误编辑

**UI 设计**:
```
[初稿 (zh-CN)] [本地化版本 (en-US)] [一键本地化]
     ↑ 选中           未选中              按钮
```

### 5. 分离存储

**数据库设计**:
```sql
-- 初稿大纲（调试语言版本）
draft_outline JSONB

-- 本地化大纲（访谈语言版本）
localized_outline JSONB

-- 调试语言代码
outline_debug_language TEXT

-- 访谈语言代码
outline_interview_language TEXT
```

**保存逻辑**:
```typescript
// 优先使用本地化版本
interviewData.questions = localizedQuestions || questions;

// 分别保存两个版本
sanitizedInterviewData.draft_outline = questions;
sanitizedInterviewData.localized_outline = localizedQuestions || null;
```

---

## 🔧 技术实现

### 后端实现

#### 1. 本地化 Prompt

**文件**: `backend/src/lib/prompts/localize-outline.ts`

**设计理念**:
- 结合素材G（基础本地化）和素材G1（专业优化）
- 针对不同语言的文化特性配置
- 强调"本土化"而非"翻译"

**核心 Prompt**:
```typescript
export const SYSTEM_PROMPT_LOCALIZATION = `
You are a world-class localization expert and cross-cultural communication specialist.

Your task is to localize interview session outlines from one language to another, 
ensuring they sound natural, culturally appropriate, and professionally crafted 
by a native speaker of the target language.

Key principles:
1. Language Authenticity: Use native expressions, not literal translations
2. Cultural Sensitivity: Adapt to cultural norms and communication styles
3. Professional Tone: Maintain interviewer credibility
4. Conversational Naturalness: Sound like a real conversation
...
`;
```

**语言特定配置**:
```typescript
const languageConfigs = {
  'zh-CN': {
    politeness: '适度礼貌，避免过于正式',
    sensitivity: '避免直接询问收入、年龄等敏感话题',
    tone: '亲切、专业、不卑不亢'
  },
  'en-US': {
    politeness: 'Professional but friendly',
    sensitivity: 'Direct but respectful',
    tone: 'Conversational and engaging'
  },
  // ...
};
```

#### 2. 本地化 Controller

**文件**: `backend/src/controllers/questions.controller.ts`

**核心逻辑**:
```typescript
export const localizeOutline = async (req: Request, res: Response) => {
  const { draftOutline, targetLanguage, researchObjective, studyName } = req.body;
  
  // 验证参数
  if (!draftOutline || !targetLanguage) {
    return res.status(400).json({
      error: "Missing required parameters"
    });
  }
  
  // 调用 OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    messages: [
      { role: "system", content: SYSTEM_PROMPT_LOCALIZATION },
      { role: "user", content: generateLocalizeOutlinePrompt({...}) }
    ],
    response_format: { type: "json_object" },
    temperature: 0.7  // 更自然的表达
  });
  
  res.status(200).json({ response: content });
};
```

#### 3. 生成逻辑修改

**修改**: 优先使用 `outline_debug_language`

```typescript
// 修改前
const language = body.language || 'en-US';

// 修改后
const debugLanguage = body.outline_debug_language || body.language || 'en-US';
const promptBody = {
  ...body,
  language: debugLanguage
};
```

### 前端实现

#### 1. 调试语言选择器

**文件**: `frontend/src/components/dashboard/interview/create-popup/details.tsx`

**实现**:
```tsx
{isDeepDiveMode && (
  <div className="flex flex-row justify-between items-center">
    <h3>Outline Debug Language:</h3>
    <select
      value={outlineDebugLanguage}
      onChange={(e) => setOutlineDebugLanguage(e.target.value)}
    >
      <option value="">Select Debug Language</option>
      {Object.entries(SUPPORTED_LANGUAGES).map(([code, lang]) => (
        <option key={code} value={code}>
          {lang.flag} {lang.name}
        </option>
      ))}
    </select>
  </div>
)}
```

#### 2. 本地化按钮和版本切换

**文件**: `frontend/src/components/dashboard/interview/create-popup/questions.tsx`

**状态管理**:
```typescript
const [questions, setQuestions] = useState<Question[]>([]);
const [localizedQuestions, setLocalizedQuestions] = useState<Question[] | null>(null);
const [showLocalized, setShowLocalized] = useState(false);
const [isLocalizing, setIsLocalizing] = useState(false);
```

**本地化逻辑**:
```typescript
const onLocalize = async () => {
  if (selectedLanguage === outlineDebugLanguage) {
    toast.info("访谈语言和调试语言相同，无需本地化");
    return;
  }

  setIsLocalizing(true);
  try {
    const response = await apiClient.post('/questions/localize-outline', {
      draftOutline: questions,
      targetLanguage: selectedLanguage,
      researchObjective: interviewData.objective,
      studyName: interviewData.name
    });

    const localizedData = JSON.parse(response.data.response);
    setLocalizedQuestions(localizedData.questions);
    setShowLocalized(true);
    toast.success("本地化完成！");
  } catch (error) {
    toast.error("本地化失败");
  } finally {
    setIsLocalizing(false);
  }
};
```

**UI 渲染**:
```tsx
{/* 版本切换按钮 */}
<Button
  variant={!showLocalized ? "default" : "outline"}
  onClick={() => setShowLocalized(false)}
>
  初稿 ({outlineDebugLanguage})
</Button>

{localizedQuestions && (
  <Button
    variant={showLocalized ? "default" : "outline"}
    onClick={() => setShowLocalized(true)}
  >
    本地化版本 ({selectedLanguage})
  </Button>
)}

{/* 本地化按钮 */}
{!localizedQuestions && (
  <Button onClick={onLocalize} disabled={isLocalizing}>
    <Globe className="w-4 h-4 mr-2" />
    {isLocalizing ? "本地化中..." : "一键本地化"}
  </Button>
)}

{/* 显示对应版本的问题 */}
{(showLocalized && localizedQuestions ? localizedQuestions : questions).map(...)}
```

---

## 📊 使用流程

### 完整示例：中文调试 → 英文访谈

#### Step 1: 创建研究
```
Interview Name: "产品用户体验研究"
Interviewer: David (Deep Dive)
Interview Language: 🇺🇸 English (US)
Outline Debug Language: 🇨🇳 简体中文
```

#### Step 2: 生成初稿
点击 "Generate Sessions" → 生成中文 sessions

```json
[
  {
    "id": "1",
    "question": "产品使用体验探索",
    "follow_up_count": 3
  },
  {
    "id": "2",
    "question": "痛点和改进建议",
    "follow_up_count": 2
  }
]
```

#### Step 3: 调试优化
在中文环境下编辑和优化问题

#### Step 4: 一键本地化
点击 "一键本地化" → AI 本地化为英文

```json
[
  {
    "id": "1",
    "question": "Exploring Your Product Experience",
    "follow_up_count": 3
  },
  {
    "id": "2",
    "question": "Pain Points and Improvement Suggestions",
    "follow_up_count": 2
  }
]
```

#### Step 5: 切换查看
- 点击 "初稿 (zh-CN)" → 查看中文版本
- 点击 "本地化版本 (en-US)" → 查看英文版本

#### Step 6: 保存
保存后数据库存储：
```
questions: [...英文版本]
draft_outline: [...中文版本]
localized_outline: [...英文版本]
outline_debug_language: "zh-CN"
outline_interview_language: "en-US"
```

---

## ✅ 测试验证

详细测试计划见：`docs/TESTING_OUTLINE_LOCALIZATION.md`

### 核心测试场景
1. ✅ 完整流程测试（中文调试 → 英文访谈）
2. ✅ 相同语言测试（无需本地化）
3. ✅ 标准模式测试（不显示调试语言选择器）
4. ✅ 边界情况测试（失败处理、只读保护等）

---

## 🎉 功能价值

### 对研究员
- ✅ 用熟悉的语言快速迭代大纲
- ✅ 无需担心目标语言表达问题
- ✅ 提升工作效率和质量

### 对访谈质量
- ✅ 地道的目标语言表达
- ✅ 文化适配而非简单翻译
- ✅ 保持专业性和自然度

### 对团队协作
- ✅ 保留初稿便于审查
- ✅ 支持跨语言团队协作
- ✅ 清晰的版本管理

---

**维护者**: Userology 开发团队
**创建日期**: 2025-10-23
**最后更新**: 2025-10-31

---

## 🔗 与两步大纲生成系统的关系

**注意**: 本地化功能与 v1.4.0 引入的两步大纲生成系统是**互补关系**：

- **两步大纲生成系统** (v1.4.0+): 骨架生成 → 用户编辑 → 完整大纲生成
- **大纲本地化功能** (v1.1.0+): 初稿语言 → 一键本地化 → 访谈语言

**使用场景**:
1. 用户使用两步大纲生成系统创建大纲（使用初稿语言）
2. 生成完整大纲后，使用本地化功能转换为访谈语言
3. 两个版本分别存储在 `draft_outline` 和 `localized_outline`

详见: [大纲生成系统文档](./03-大纲生成系统.md)

