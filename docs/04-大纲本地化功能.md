# å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½

> **ç‰ˆæœ¬**: 1.4.5
> **å®ç°æ—¥æœŸ**: 2025-10-23
> **æœ€åæ›´æ–°**: 2025-10-31
> **ä¼˜å…ˆçº§**: P1
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### é—®é¢˜èƒŒæ™¯

åœ¨è·¨è¯­è¨€ç”¨æˆ·ç ”ç©¶åœºæ™¯ä¸­ï¼Œç ”ç©¶å‘˜é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **è¯­è¨€éšœç¢**: ç ”ç©¶å‘˜å¯èƒ½ä¸ç†Ÿæ‚‰è®¿è°ˆç›®æ ‡è¯­è¨€ï¼Œéš¾ä»¥ç›´æ¥ç”¨è¯¥è¯­è¨€è®¾è®¡å’Œä¼˜åŒ–è®¿è°ˆå¤§çº²
2. **è´¨é‡ä¿è¯**: ç®€å•çš„æœºå™¨ç¿»è¯‘æ— æ³•æ»¡è¶³æ–‡åŒ–é€‚é…éœ€æ±‚ï¼Œå®¹æ˜“äº§ç”Ÿä¸åœ°é“çš„è¡¨è¾¾
3. **æ•ˆç‡é—®é¢˜**: éœ€è¦åœ¨ç†Ÿæ‚‰çš„è¯­è¨€ä¸‹å¿«é€Ÿè¿­ä»£å¤§çº²ï¼Œæœ€åå†è½¬æ¢ä¸ºç›®æ ‡è¯­è¨€

### è§£å†³æ–¹æ¡ˆ

å®ç°**ä¸¤æ­¥èµ°å¤§çº²åˆ›å»ºæµç¨‹**ï¼š

```
åˆç‰ˆç”Ÿæˆï¼ˆè°ƒè¯•è¯­è¨€ï¼‰ â†’ è°ƒè¯•ä¼˜åŒ– â†’ ä¸€é”®æœ¬åœ°åŒ–ï¼ˆè®¿è°ˆè¯­è¨€ï¼‰
```

**æ ¸å¿ƒä»·å€¼**:
- âœ… ç ”ç©¶å‘˜ç”¨ç†Ÿæ‚‰çš„è¯­è¨€è°ƒè¯•å¤§çº²
- âœ… AI æ·±åº¦æœ¬åœ°åŒ–åˆ°ç›®æ ‡è¯­è¨€
- âœ… ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬ä¾¿äºå¯¹æ¯”å’Œå®¡æŸ¥
- âœ… æå‡è·¨è¯­è¨€ç ”ç©¶çš„æ•ˆç‡å’Œè´¨é‡

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è°ƒè¯•è¯­è¨€é€‰æ‹©

**ä½ç½®**: åˆ›å»ºç ”ç©¶é¡µé¢ï¼ˆä»… Deep Dive æ¨¡å¼ï¼‰

**åŠŸèƒ½**:
- é€‰æ‹©ç”¨äºç”Ÿæˆå’Œè°ƒè¯•å¤§çº²çš„è¯­è¨€
- æ”¯æŒæ‰€æœ‰ä¸»æµè¯­è¨€ï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ã€æ³•æ–‡ç­‰ï¼‰
- ç‹¬ç«‹äºè®¿è°ˆè¯­è¨€è®¾ç½®

**ä½¿ç”¨åœºæ™¯**:
```
è®¿è°ˆè¯­è¨€: è‹±æ–‡
è°ƒè¯•è¯­è¨€: ä¸­æ–‡
â†’ ç”¨ä¸­æ–‡ç”Ÿæˆå’Œè°ƒè¯•å¤§çº²ï¼Œæœ€åæœ¬åœ°åŒ–ä¸ºè‹±æ–‡
```

### 2. åˆç¨¿ç”Ÿæˆ

**åŠŸèƒ½**:
- ä½¿ç”¨è°ƒè¯•è¯­è¨€ç”Ÿæˆåˆç‰ˆå¤§çº²
- ç”Ÿæˆçš„ sessions å®Œå…¨ä½¿ç”¨è°ƒè¯•è¯­è¨€
- ä¾¿äºç ”ç©¶å‘˜ç†è§£å’Œä¼˜åŒ–

**æŠ€æœ¯å®ç°**:
```typescript
// ä¼˜å…ˆä½¿ç”¨ outline_debug_language
const debugLanguage = body.outline_debug_language || body.language || 'en-US';

const promptBody = {
  ...body,
  language: debugLanguage
};
```

### 3. ä¸€é”®æœ¬åœ°åŒ–

**ä½ç½®**: å¤§çº²ç¼–è¾‘é¡µé¢

**åŠŸèƒ½**:
- ç‚¹å‡»"ä¸€é”®æœ¬åœ°åŒ–"æŒ‰é’®
- AI æ·±åº¦æœ¬åœ°åŒ–åˆ°è®¿è°ˆè¯­è¨€
- ä¿æŒåŸæœ‰ç»“æ„å’Œé€»è¾‘
- æ–‡åŒ–é€‚é…è€Œéç®€å•ç¿»è¯‘

**æœ¬åœ°åŒ–ç­–ç•¥**:
1. **è¯­è¨€çœŸå®æ€§**: ä½¿ç”¨ç›®æ ‡è¯­è¨€çš„åœ°é“è¡¨è¾¾
2. **æ–‡åŒ–æ•æ„Ÿæ€§**: è€ƒè™‘æ–‡åŒ–å·®å¼‚ï¼ˆç¤¼è²Œç¨‹åº¦ã€æ•æ„Ÿè¯é¢˜ç­‰ï¼‰
3. **ä¸“ä¸šæ€§**: ä¿æŒè®¿è°ˆå‘˜çš„ä¸“ä¸šå½¢è±¡
4. **è‡ªç„¶åº¦**: ç¬¦åˆç›®æ ‡è¯­è¨€çš„å¯¹è¯ä¹ æƒ¯

**API æ¥å£**:
```
POST /api/questions/localize-outline

Request:
{
  "draftOutline": [...],
  "targetLanguage": "en-US",
  "researchObjective": "...",
  "studyName": "..."
}

Response:
{
  "response": "{\"questions\": [...]}"
}
```

### 4. ç‰ˆæœ¬åˆ‡æ¢

**åŠŸèƒ½**:
- åœ¨åˆç¨¿å’Œæœ¬åœ°åŒ–ç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢æŸ¥çœ‹
- å®æ—¶åˆ‡æ¢ï¼Œæ— éœ€é‡æ–°åŠ è½½
- æœ¬åœ°åŒ–ç‰ˆæœ¬ä¸ºåªè¯»ï¼Œé˜²æ­¢è¯¯ç¼–è¾‘

**UI è®¾è®¡**:
```
[åˆç¨¿ (zh-CN)] [æœ¬åœ°åŒ–ç‰ˆæœ¬ (en-US)] [ä¸€é”®æœ¬åœ°åŒ–]
     â†‘ é€‰ä¸­           æœªé€‰ä¸­              æŒ‰é’®
```

### 5. åˆ†ç¦»å­˜å‚¨

**æ•°æ®åº“è®¾è®¡**:
```sql
-- åˆç¨¿å¤§çº²ï¼ˆè°ƒè¯•è¯­è¨€ç‰ˆæœ¬ï¼‰
draft_outline JSONB

-- æœ¬åœ°åŒ–å¤§çº²ï¼ˆè®¿è°ˆè¯­è¨€ç‰ˆæœ¬ï¼‰
localized_outline JSONB

-- è°ƒè¯•è¯­è¨€ä»£ç 
outline_debug_language TEXT

-- è®¿è°ˆè¯­è¨€ä»£ç 
outline_interview_language TEXT
```

**ä¿å­˜é€»è¾‘**:
```typescript
// ä¼˜å…ˆä½¿ç”¨æœ¬åœ°åŒ–ç‰ˆæœ¬
interviewData.questions = localizedQuestions || questions;

// åˆ†åˆ«ä¿å­˜ä¸¤ä¸ªç‰ˆæœ¬
sanitizedInterviewData.draft_outline = questions;
sanitizedInterviewData.localized_outline = localizedQuestions || null;
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯å®ç°

#### 1. æœ¬åœ°åŒ– Prompt

**æ–‡ä»¶**: `backend/src/lib/prompts/localize-outline.ts`

**è®¾è®¡ç†å¿µ**:
- ç»“åˆç´ æGï¼ˆåŸºç¡€æœ¬åœ°åŒ–ï¼‰å’Œç´ æG1ï¼ˆä¸“ä¸šä¼˜åŒ–ï¼‰
- é’ˆå¯¹ä¸åŒè¯­è¨€çš„æ–‡åŒ–ç‰¹æ€§é…ç½®
- å¼ºè°ƒ"æœ¬åœŸåŒ–"è€Œé"ç¿»è¯‘"

**æ ¸å¿ƒ Prompt**:
```typescript
export const SYSTEM_PROMPT_LOCALIZATION = `
You are a world-class localization expert and cross-cultural communication specialist.

Your task is to localize interview session outlines from one language to another, 
ensuring they sound natural, culturally appropriate, and professionally crafted 
by a native speaker of the target language.

Key principles:
1. Language Authenticity: Use native expressions, not literal translations
2. Cultural Sensitivity: Adapt to cultural norms and communication styles
3. Professional Tone: Maintain interviewer credibility
4. Conversational Naturalness: Sound like a real conversation
...
`;
```

**è¯­è¨€ç‰¹å®šé…ç½®**:
```typescript
const languageConfigs = {
  'zh-CN': {
    politeness: 'é€‚åº¦ç¤¼è²Œï¼Œé¿å…è¿‡äºæ­£å¼',
    sensitivity: 'é¿å…ç›´æ¥è¯¢é—®æ”¶å…¥ã€å¹´é¾„ç­‰æ•æ„Ÿè¯é¢˜',
    tone: 'äº²åˆ‡ã€ä¸“ä¸šã€ä¸å‘ä¸äº¢'
  },
  'en-US': {
    politeness: 'Professional but friendly',
    sensitivity: 'Direct but respectful',
    tone: 'Conversational and engaging'
  },
  // ...
};
```

#### 2. æœ¬åœ°åŒ– Controller

**æ–‡ä»¶**: `backend/src/controllers/questions.controller.ts`

**æ ¸å¿ƒé€»è¾‘**:
```typescript
export const localizeOutline = async (req: Request, res: Response) => {
  const { draftOutline, targetLanguage, researchObjective, studyName } = req.body;
  
  // éªŒè¯å‚æ•°
  if (!draftOutline || !targetLanguage) {
    return res.status(400).json({
      error: "Missing required parameters"
    });
  }
  
  // è°ƒç”¨ OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    messages: [
      { role: "system", content: SYSTEM_PROMPT_LOCALIZATION },
      { role: "user", content: generateLocalizeOutlinePrompt({...}) }
    ],
    response_format: { type: "json_object" },
    temperature: 0.7  // æ›´è‡ªç„¶çš„è¡¨è¾¾
  });
  
  res.status(200).json({ response: content });
};
```

#### 3. ç”Ÿæˆé€»è¾‘ä¿®æ”¹

**ä¿®æ”¹**: ä¼˜å…ˆä½¿ç”¨ `outline_debug_language`

```typescript
// ä¿®æ”¹å‰
const language = body.language || 'en-US';

// ä¿®æ”¹å
const debugLanguage = body.outline_debug_language || body.language || 'en-US';
const promptBody = {
  ...body,
  language: debugLanguage
};
```

### å‰ç«¯å®ç°

#### 1. è°ƒè¯•è¯­è¨€é€‰æ‹©å™¨

**æ–‡ä»¶**: `frontend/src/components/dashboard/interview/create-popup/details.tsx`

**å®ç°**:
```tsx
{isDeepDiveMode && (
  <div className="flex flex-row justify-between items-center">
    <h3>Outline Debug Language:</h3>
    <select
      value={outlineDebugLanguage}
      onChange={(e) => setOutlineDebugLanguage(e.target.value)}
    >
      <option value="">Select Debug Language</option>
      {Object.entries(SUPPORTED_LANGUAGES).map(([code, lang]) => (
        <option key={code} value={code}>
          {lang.flag} {lang.name}
        </option>
      ))}
    </select>
  </div>
)}
```

#### 2. æœ¬åœ°åŒ–æŒ‰é’®å’Œç‰ˆæœ¬åˆ‡æ¢

**æ–‡ä»¶**: `frontend/src/components/dashboard/interview/create-popup/questions.tsx`

**çŠ¶æ€ç®¡ç†**:
```typescript
const [questions, setQuestions] = useState<Question[]>([]);
const [localizedQuestions, setLocalizedQuestions] = useState<Question[] | null>(null);
const [showLocalized, setShowLocalized] = useState(false);
const [isLocalizing, setIsLocalizing] = useState(false);
```

**æœ¬åœ°åŒ–é€»è¾‘**:
```typescript
const onLocalize = async () => {
  if (selectedLanguage === outlineDebugLanguage) {
    toast.info("è®¿è°ˆè¯­è¨€å’Œè°ƒè¯•è¯­è¨€ç›¸åŒï¼Œæ— éœ€æœ¬åœ°åŒ–");
    return;
  }

  setIsLocalizing(true);
  try {
    const response = await apiClient.post('/questions/localize-outline', {
      draftOutline: questions,
      targetLanguage: selectedLanguage,
      researchObjective: interviewData.objective,
      studyName: interviewData.name
    });

    const localizedData = JSON.parse(response.data.response);
    setLocalizedQuestions(localizedData.questions);
    setShowLocalized(true);
    toast.success("æœ¬åœ°åŒ–å®Œæˆï¼");
  } catch (error) {
    toast.error("æœ¬åœ°åŒ–å¤±è´¥");
  } finally {
    setIsLocalizing(false);
  }
};
```

**UI æ¸²æŸ“**:
```tsx
{/* ç‰ˆæœ¬åˆ‡æ¢æŒ‰é’® */}
<Button
  variant={!showLocalized ? "default" : "outline"}
  onClick={() => setShowLocalized(false)}
>
  åˆç¨¿ ({outlineDebugLanguage})
</Button>

{localizedQuestions && (
  <Button
    variant={showLocalized ? "default" : "outline"}
    onClick={() => setShowLocalized(true)}
  >
    æœ¬åœ°åŒ–ç‰ˆæœ¬ ({selectedLanguage})
  </Button>
)}

{/* æœ¬åœ°åŒ–æŒ‰é’® */}
{!localizedQuestions && (
  <Button onClick={onLocalize} disabled={isLocalizing}>
    <Globe className="w-4 h-4 mr-2" />
    {isLocalizing ? "æœ¬åœ°åŒ–ä¸­..." : "ä¸€é”®æœ¬åœ°åŒ–"}
  </Button>
)}

{/* æ˜¾ç¤ºå¯¹åº”ç‰ˆæœ¬çš„é—®é¢˜ */}
{(showLocalized && localizedQuestions ? localizedQuestions : questions).map(...)}
```

---

## ğŸ“Š ä½¿ç”¨æµç¨‹

### å®Œæ•´ç¤ºä¾‹ï¼šä¸­æ–‡è°ƒè¯• â†’ è‹±æ–‡è®¿è°ˆ

#### Step 1: åˆ›å»ºç ”ç©¶
```
Interview Name: "äº§å“ç”¨æˆ·ä½“éªŒç ”ç©¶"
Interviewer: David (Deep Dive)
Interview Language: ğŸ‡ºğŸ‡¸ English (US)
Outline Debug Language: ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡
```

#### Step 2: ç”Ÿæˆåˆç¨¿
ç‚¹å‡» "Generate Sessions" â†’ ç”Ÿæˆä¸­æ–‡ sessions

```json
[
  {
    "id": "1",
    "question": "äº§å“ä½¿ç”¨ä½“éªŒæ¢ç´¢",
    "follow_up_count": 3
  },
  {
    "id": "2",
    "question": "ç—›ç‚¹å’Œæ”¹è¿›å»ºè®®",
    "follow_up_count": 2
  }
]
```

#### Step 3: è°ƒè¯•ä¼˜åŒ–
åœ¨ä¸­æ–‡ç¯å¢ƒä¸‹ç¼–è¾‘å’Œä¼˜åŒ–é—®é¢˜

#### Step 4: ä¸€é”®æœ¬åœ°åŒ–
ç‚¹å‡» "ä¸€é”®æœ¬åœ°åŒ–" â†’ AI æœ¬åœ°åŒ–ä¸ºè‹±æ–‡

```json
[
  {
    "id": "1",
    "question": "Exploring Your Product Experience",
    "follow_up_count": 3
  },
  {
    "id": "2",
    "question": "Pain Points and Improvement Suggestions",
    "follow_up_count": 2
  }
]
```

#### Step 5: åˆ‡æ¢æŸ¥çœ‹
- ç‚¹å‡» "åˆç¨¿ (zh-CN)" â†’ æŸ¥çœ‹ä¸­æ–‡ç‰ˆæœ¬
- ç‚¹å‡» "æœ¬åœ°åŒ–ç‰ˆæœ¬ (en-US)" â†’ æŸ¥çœ‹è‹±æ–‡ç‰ˆæœ¬

#### Step 6: ä¿å­˜
ä¿å­˜åæ•°æ®åº“å­˜å‚¨ï¼š
```
questions: [...è‹±æ–‡ç‰ˆæœ¬]
draft_outline: [...ä¸­æ–‡ç‰ˆæœ¬]
localized_outline: [...è‹±æ–‡ç‰ˆæœ¬]
outline_debug_language: "zh-CN"
outline_interview_language: "en-US"
```

---

## âœ… æµ‹è¯•éªŒè¯

è¯¦ç»†æµ‹è¯•è®¡åˆ’è§ï¼š`docs/TESTING_OUTLINE_LOCALIZATION.md`

### æ ¸å¿ƒæµ‹è¯•åœºæ™¯
1. âœ… å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆä¸­æ–‡è°ƒè¯• â†’ è‹±æ–‡è®¿è°ˆï¼‰
2. âœ… ç›¸åŒè¯­è¨€æµ‹è¯•ï¼ˆæ— éœ€æœ¬åœ°åŒ–ï¼‰
3. âœ… æ ‡å‡†æ¨¡å¼æµ‹è¯•ï¼ˆä¸æ˜¾ç¤ºè°ƒè¯•è¯­è¨€é€‰æ‹©å™¨ï¼‰
4. âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆå¤±è´¥å¤„ç†ã€åªè¯»ä¿æŠ¤ç­‰ï¼‰

---

## ğŸ‰ åŠŸèƒ½ä»·å€¼

### å¯¹ç ”ç©¶å‘˜
- âœ… ç”¨ç†Ÿæ‚‰çš„è¯­è¨€å¿«é€Ÿè¿­ä»£å¤§çº²
- âœ… æ— éœ€æ‹…å¿ƒç›®æ ‡è¯­è¨€è¡¨è¾¾é—®é¢˜
- âœ… æå‡å·¥ä½œæ•ˆç‡å’Œè´¨é‡

### å¯¹è®¿è°ˆè´¨é‡
- âœ… åœ°é“çš„ç›®æ ‡è¯­è¨€è¡¨è¾¾
- âœ… æ–‡åŒ–é€‚é…è€Œéç®€å•ç¿»è¯‘
- âœ… ä¿æŒä¸“ä¸šæ€§å’Œè‡ªç„¶åº¦

### å¯¹å›¢é˜Ÿåä½œ
- âœ… ä¿ç•™åˆç¨¿ä¾¿äºå®¡æŸ¥
- âœ… æ”¯æŒè·¨è¯­è¨€å›¢é˜Ÿåä½œ
- âœ… æ¸…æ™°çš„ç‰ˆæœ¬ç®¡ç†

---

**ç»´æŠ¤è€…**: Userology å¼€å‘å›¢é˜Ÿ
**åˆ›å»ºæ—¥æœŸ**: 2025-10-23
**æœ€åæ›´æ–°**: 2025-10-31

---

## ğŸ”— ä¸ä¸¤æ­¥å¤§çº²ç”Ÿæˆç³»ç»Ÿçš„å…³ç³»

**æ³¨æ„**: æœ¬åœ°åŒ–åŠŸèƒ½ä¸ v1.4.0 å¼•å…¥çš„ä¸¤æ­¥å¤§çº²ç”Ÿæˆç³»ç»Ÿæ˜¯**äº’è¡¥å…³ç³»**ï¼š

- **ä¸¤æ­¥å¤§çº²ç”Ÿæˆç³»ç»Ÿ** (v1.4.0+): éª¨æ¶ç”Ÿæˆ â†’ ç”¨æˆ·ç¼–è¾‘ â†’ å®Œæ•´å¤§çº²ç”Ÿæˆ
- **å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½** (v1.1.0+): åˆç¨¿è¯­è¨€ â†’ ä¸€é”®æœ¬åœ°åŒ– â†’ è®¿è°ˆè¯­è¨€

**ä½¿ç”¨åœºæ™¯**:
1. ç”¨æˆ·ä½¿ç”¨ä¸¤æ­¥å¤§çº²ç”Ÿæˆç³»ç»Ÿåˆ›å»ºå¤§çº²ï¼ˆä½¿ç”¨åˆç¨¿è¯­è¨€ï¼‰
2. ç”Ÿæˆå®Œæ•´å¤§çº²åï¼Œä½¿ç”¨æœ¬åœ°åŒ–åŠŸèƒ½è½¬æ¢ä¸ºè®¿è°ˆè¯­è¨€
3. ä¸¤ä¸ªç‰ˆæœ¬åˆ†åˆ«å­˜å‚¨åœ¨ `draft_outline` å’Œ `localized_outline`

è¯¦è§: [å¤§çº²ç”Ÿæˆç³»ç»Ÿæ–‡æ¡£](./03-å¤§çº²ç”Ÿæˆç³»ç»Ÿ.md)

