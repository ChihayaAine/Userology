# è®¿è°ˆé—®é¢˜ç”Ÿæˆç³»ç»Ÿ

> **ç‰ˆæœ¬**: 1.3.5  
> **æœ€åæ›´æ–°**: 2025-10-24

---

## ğŸ“– ç³»ç»Ÿæ¦‚è¿°

è®¿è°ˆé—®é¢˜ç”Ÿæˆç³»ç»Ÿæ˜¯ Userology çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œè´Ÿè´£æ ¹æ®ç ”ç©¶ç›®æ ‡è‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡çš„è®¿è°ˆé—®é¢˜æˆ–æ·±åº¦è®¿è°ˆå¤§çº²ã€‚ç³»ç»Ÿæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

1. **æ ‡å‡†é—®é¢˜æ¨¡å¼** (Lisa/Bob)ï¼šç”Ÿæˆå›ºå®šé—®é¢˜åˆ—è¡¨
2. **æ·±åº¦è®¿è°ˆæ¨¡å¼** (David)ï¼šç”Ÿæˆå¤šé˜¶æ®µ Session å¤§çº²

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
å‰ç«¯åˆ›å»ºç•Œé¢
    â†“
API è·¯ç”±å±‚
    â†“
Questions Controller
    â†“
OpenAI GPT-4o
    â†“
è¿”å›ç”Ÿæˆçš„é—®é¢˜/Sessions
```

### æŠ€æœ¯æ ˆ

- **AI æ¨¡å‹**: OpenAI GPT-4o
- **API ä»£ç†**: tu-zi.com
- **Prompt å·¥ç¨‹**: ä¸“ä¸šåŒ–çš„ System Prompt å’Œ User Prompt
- **è¾“å‡ºæ ¼å¼**: JSON (ç»“æ„åŒ–æ•°æ®)

---

## ğŸ¯ åŠŸèƒ½æ¨¡å¼

### æ¨¡å¼ 1: æ ‡å‡†é—®é¢˜ç”Ÿæˆ (Lisa/Bob)

**é€‚ç”¨åœºæ™¯**ï¼š
- å¿«é€Ÿç”¨æˆ·è°ƒç ”
- æ ‡å‡†åŒ–è®¿è°ˆæµç¨‹
- éœ€è¦å›ºå®šé—®é¢˜åˆ—è¡¨çš„åœºæ™¯

**API ç«¯ç‚¹**ï¼š
```
POST /api/generate-interview-questions
```

**è¯·æ±‚å‚æ•°**ï¼š
```typescript
{
  name: string;              // ç ”ç©¶åç§°
  objective: string;         // ç ”ç©¶ç›®æ ‡
  number: number;            // é—®é¢˜æ•°é‡
  context: string;           // ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
  researchType: string;      // ç ”ç©¶ç±»å‹
  customInstructions: string; // ä¸ªæ€§åŒ–å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
  language: string;          // è®¿è°ˆè¯­è¨€ï¼ˆå¯é€‰ï¼‰
  outline_debug_language: string; // å¤§çº²è°ƒè¯•è¯­è¨€ï¼ˆå¯é€‰ï¼‰
}
```

**å“åº”æ ¼å¼**ï¼š
```typescript
{
  questions: Array<{
    id: string;
    question: string;
    follow_up_count: number;
  }>;
  description: string; // ç ”ç©¶æè¿°
}
```

**Prompt æ–‡ä»¶**ï¼š
- `backend/src/lib/prompts/generate-questions.ts`

---

### æ¨¡å¼ 2: æ·±åº¦è®¿è°ˆ Sessions (David)

**é€‚ç”¨åœºæ™¯**ï¼š
- æ·±åº¦ç”¨æˆ·ç ”ç©¶
- éœ€æ±‚æ¢ç´¢
- äº§å“è°ƒç ”

**API ç«¯ç‚¹**ï¼š
```
POST /api/generate-interview-sessions
```

**è¯·æ±‚å‚æ•°**ï¼šåŒæ ‡å‡†æ¨¡å¼

**å“åº”æ ¼å¼**ï¼š
```typescript
{
  sessions: Array<{
    session_number: number;
    session_title: string;
    session_objective: string;
    questions: Array<{
      id: string;
      question: string;
      follow_up_count: number;
    }>;
  }>;
  description: string;
}
```

**Prompt æ–‡ä»¶**ï¼š
- å¸‚åœºè°ƒç ”ï¼š`backend/src/lib/prompts/generate-market-research-sessions.ts`
- äº§å“è°ƒç ”ï¼š`backend/src/lib/prompts/generate-product-research-sessions.ts`
- é€šç”¨ï¼š`backend/src/lib/prompts/generate-sessions.ts`

---

## ğŸ”§ å®ç°ç»†èŠ‚

### Controller å±‚

**æ–‡ä»¶**: `backend/src/controllers/questions.controller.ts`

**æ ¸å¿ƒå‡½æ•°**ï¼š

#### 1. `generateInterviewQuestions`

```typescript
export const generateInterviewQuestions = async (req: Request, res: Response) => {
  const { name, objective, number, context, researchType, customInstructions, language, outline_debug_language } = req.body;
  
  // 1. æ„å»º Prompt
  const prompt = generateQuestionsPrompt({
    name,
    objective,
    number,
    context,
    customInstructions,
    language: outline_debug_language || language
  });
  
  // 2. è°ƒç”¨ OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: prompt }
    ],
    response_format: { type: "json_object" }
  });
  
  // 3. è§£æå¹¶è¿”å›
  const content = completion.choices[0].message?.content;
  res.status(200).json({ response: content });
};
```

#### 2. `generateInterviewSessions`

```typescript
export const generateInterviewSessions = async (req: Request, res: Response) => {
  const { researchType } = req.body;
  
  // æ ¹æ®ç ”ç©¶ç±»å‹é€‰æ‹©ä¸åŒçš„ Prompt
  const promptConfig = researchType === 'market_research' 
    ? { system: SYSTEM_PROMPT_MARKET_RESEARCH, generator: generateMarketResearchSessionsPrompt }
    : { system: SYSTEM_PROMPT_PRODUCT_RESEARCH, generator: generateProductResearchSessionsPrompt };
  
  // ç”Ÿæˆ Sessions...
};
```

---

## ğŸ“ Prompt å·¥ç¨‹

### System Prompt è®¾è®¡åŸåˆ™

1. **è§’è‰²å®šä½æ˜ç¡®**ï¼šå®šä¹‰ AI ä¸ºä¸“ä¸šç”¨æˆ·ç ”ç©¶ä¸“å®¶
2. **è¾“å‡ºæ ¼å¼è§„èŒƒ**ï¼šæ˜ç¡® JSON ç»“æ„è¦æ±‚
3. **è´¨é‡æ ‡å‡†**ï¼šå¼ºè°ƒé—®é¢˜çš„å¼€æ”¾æ€§ã€æ·±åº¦å’Œç›¸å…³æ€§

### User Prompt ç»“æ„

```
ç ”ç©¶æ ‡é¢˜: ${name}
ç ”ç©¶ç›®æ ‡: ${objective}
é—®é¢˜æ•°é‡: ${number}

[å¯é€‰] ä¸Šä¸‹æ–‡ä¿¡æ¯: ${context}
[å¯é€‰] ä¸ªæ€§åŒ–å¤‡æ³¨: ${customInstructions}
[å¯é€‰] è¯­è¨€è¦æ±‚: ${language}

è¾“å‡ºè¦æ±‚:
- JSON æ ¼å¼
- åŒ…å«é—®é¢˜åˆ—è¡¨å’Œç ”ç©¶æè¿°
- é—®é¢˜éœ€è¦å¼€æ”¾å¼ã€æ·±å…¥ã€ç›¸å…³
```

---

## ğŸŒ å¤šè¯­è¨€æ”¯æŒ

### è¯­è¨€å‚æ•°

- `language`: è®¿è°ˆè¯­è¨€ï¼ˆæœ€ç»ˆè®¿è°ˆä½¿ç”¨çš„è¯­è¨€ï¼‰
- `outline_debug_language`: å¤§çº²è°ƒè¯•è¯­è¨€ï¼ˆç ”ç©¶è€…è°ƒè¯•ç”¨ï¼‰

### è¯­è¨€ä¼˜å…ˆçº§

```
outline_debug_language > language > 'en-US' (é»˜è®¤)
```

### æ”¯æŒçš„è¯­è¨€

- `zh-CN`: ç®€ä½“ä¸­æ–‡
- `zh-TW`: ç¹ä½“ä¸­æ–‡
- `en-US`: è‹±è¯­
- `ja-JP`: æ—¥è¯­

---

## ğŸ”„ ä¸å¤§çº²æœ¬åœ°åŒ–çš„é›†æˆ

ç”Ÿæˆçš„é—®é¢˜å¯ä»¥é€šè¿‡å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½è¿›è¡Œè¯­è¨€è½¬æ¢ï¼š

```
1. ä½¿ç”¨ outline_debug_language ç”Ÿæˆåˆç¨¿
   â†“
2. ç ”ç©¶è€…å®¡æ ¸å’Œè°ƒæ•´
   â†“
3. è°ƒç”¨ /api/localize-outline æœ¬åœ°åŒ–åˆ°ç›®æ ‡è¯­è¨€
   â†“
4. ç”Ÿæˆæœ€ç»ˆè®¿è°ˆå¤§çº²
```

è¯¦è§ï¼š[å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½æ–‡æ¡£](./03-å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½.md)

---

## ğŸ¨ å‰ç«¯é›†æˆ

### åˆ›å»ºè®¿è°ˆæµç¨‹

**æ–‡ä»¶**: `frontend/src/components/dashboard/interview/create-popup/details.tsx`

**æµç¨‹**ï¼š

1. ç”¨æˆ·å¡«å†™ç ”ç©¶ä¿¡æ¯
2. é€‰æ‹©é¢è¯•å®˜ï¼ˆLisa/Bob/Davidï¼‰
3. ç‚¹å‡»"Generate with AI"
4. è°ƒç”¨å¯¹åº”çš„ API
5. æ˜¾ç¤ºç”Ÿæˆçš„é—®é¢˜
6. è¿›å…¥é—®é¢˜ç¼–è¾‘ç•Œé¢

### å…³é”®ä»£ç 

```typescript
const onGenerate = async () => {
  const data = {
    name, objective, number: numQuestions,
    context, researchType, customInstructions,
    language: selectedLanguage,
    outline_debug_language: outlineDebugLanguage
  };
  
  const apiEndpoint = isDeepDiveMode 
    ? "/generate-interview-sessions"
    : "/generate-interview-questions";
  
  const response = await apiClient.post(apiEndpoint, data, {
    timeout: 120000 // 2åˆ†é’Ÿè¶…æ—¶
  });
  
  // å¤„ç†å“åº”...
};
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### è¶…æ—¶è®¾ç½®

- **æ ‡å‡†é—®é¢˜ç”Ÿæˆ**: 120ç§’
- **æ·±åº¦ Sessions ç”Ÿæˆ**: 120ç§’

### é”™è¯¯å¤„ç†

```typescript
try {
  // ç”Ÿæˆé—®é¢˜...
} catch (error) {
  if (error.code === 'ECONNABORTED') {
    // è¶…æ—¶é”™è¯¯
  } else if (error.response?.status === 429) {
    // API é…é¢é™åˆ¶
  } else {
    // å…¶ä»–é”™è¯¯
  }
}
```

---

## ğŸ“Š æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥
  â†“
å‰ç«¯éªŒè¯
  â†“
API è¯·æ±‚ (POST /api/generate-interview-questions)
  â†“
Controller æ¥æ”¶å‚æ•°
  â†“
æ„å»º Prompt
  â†“
è°ƒç”¨ OpenAI GPT-4o
  â†“
è§£æ JSON å“åº”
  â†“
è¿”å›å‰ç«¯
  â†“
æ˜¾ç¤ºé—®é¢˜åˆ—è¡¨
  â†“
ç”¨æˆ·ç¼–è¾‘å’Œä¿å­˜
```

---

## ğŸ” è°ƒè¯•å’Œæ—¥å¿—

### å…³é”®æ—¥å¿—ç‚¹

```typescript
console.log('ğŸš€ Generating questions with data:', data);
console.log('ğŸ“ OpenAI Response:', content);
console.log('âœ… Questions generated successfully');
```

### å¸¸è§é—®é¢˜

1. **ç”Ÿæˆçš„é—®é¢˜ä¸ç¬¦åˆé¢„æœŸ**
   - æ£€æŸ¥ Prompt æ˜¯å¦æ¸…æ™°
   - è°ƒæ•´ `customInstructions`
   - å¢åŠ  `context` ä¿¡æ¯

2. **API è¶…æ—¶**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æ£€æŸ¥ OpenAI API çŠ¶æ€
   - å¢åŠ è¶…æ—¶æ—¶é—´

3. **è¯­è¨€ä¸æ­£ç¡®**
   - æ£€æŸ¥ `outline_debug_language` å‚æ•°
   - æ£€æŸ¥ Prompt ä¸­çš„è¯­è¨€æŒ‡ä»¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½](./03-å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½.md)
- [æŠ€æœ¯æ¶æ„](./01-æŠ€æœ¯æ¶æ„.md)
- [æ•°æ®åº“è®¾è®¡](./02-æ•°æ®åº“è®¾è®¡.md)

---

**ç»´æŠ¤è€…**: Userology å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-24

