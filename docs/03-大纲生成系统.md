# 访谈问题生成系统

> **版本**: 1.3.5  
> **最后更新**: 2025-10-24

---

## 📖 系统概述

访谈问题生成系统是 Userology 的核心功能之一，负责根据研究目标自动生成高质量的访谈问题或深度访谈大纲。系统支持两种模式：

1. **标准问题模式** (Lisa/Bob)：生成固定问题列表
2. **深度访谈模式** (David)：生成多阶段 Session 大纲

---

## 🏗️ 系统架构

### 核心组件

```
前端创建界面
    ↓
API 路由层
    ↓
Questions Controller
    ↓
OpenAI GPT-4o
    ↓
返回生成的问题/Sessions
```

### 技术栈

- **AI 模型**: OpenAI GPT-4o
- **API 代理**: tu-zi.com
- **Prompt 工程**: 专业化的 System Prompt 和 User Prompt
- **输出格式**: JSON (结构化数据)

---

## 🎯 功能模式

### 模式 1: 标准问题生成 (Lisa/Bob)

**适用场景**：
- 快速用户调研
- 标准化访谈流程
- 需要固定问题列表的场景

**API 端点**：
```
POST /api/generate-interview-questions
```

**请求参数**：
```typescript
{
  name: string;              // 研究名称
  objective: string;         // 研究目标
  number: number;            // 问题数量
  context: string;           // 上下文（可选）
  researchType: string;      // 研究类型
  customInstructions: string; // 个性化备注（可选）
  language: string;          // 访谈语言（可选）
  outline_debug_language: string; // 大纲调试语言（可选）
}
```

**响应格式**：
```typescript
{
  questions: Array<{
    id: string;
    question: string;
    follow_up_count: number;
  }>;
  description: string; // 研究描述
}
```

**Prompt 文件**：
- `backend/src/lib/prompts/generate-questions.ts`

---

### 模式 2: 深度访谈 Sessions (David)

**适用场景**：
- 深度用户研究
- 需求探索
- 产品调研

**API 端点**：
```
POST /api/generate-interview-sessions
```

**请求参数**：同标准模式

**响应格式**：
```typescript
{
  sessions: Array<{
    session_number: number;
    session_title: string;
    session_objective: string;
    questions: Array<{
      id: string;
      question: string;
      follow_up_count: number;
    }>;
  }>;
  description: string;
}
```

**Prompt 文件**：
- 市场调研：`backend/src/lib/prompts/generate-market-research-sessions.ts`
- 产品调研：`backend/src/lib/prompts/generate-product-research-sessions.ts`
- 通用：`backend/src/lib/prompts/generate-sessions.ts`

---

## 🔧 实现细节

### Controller 层

**文件**: `backend/src/controllers/questions.controller.ts`

**核心函数**：

#### 1. `generateInterviewQuestions`

```typescript
export const generateInterviewQuestions = async (req: Request, res: Response) => {
  const { name, objective, number, context, researchType, customInstructions, language, outline_debug_language } = req.body;
  
  // 1. 构建 Prompt
  const prompt = generateQuestionsPrompt({
    name,
    objective,
    number,
    context,
    customInstructions,
    language: outline_debug_language || language
  });
  
  // 2. 调用 OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: prompt }
    ],
    response_format: { type: "json_object" }
  });
  
  // 3. 解析并返回
  const content = completion.choices[0].message?.content;
  res.status(200).json({ response: content });
};
```

#### 2. `generateInterviewSessions`

```typescript
export const generateInterviewSessions = async (req: Request, res: Response) => {
  const { researchType } = req.body;
  
  // 根据研究类型选择不同的 Prompt
  const promptConfig = researchType === 'market_research' 
    ? { system: SYSTEM_PROMPT_MARKET_RESEARCH, generator: generateMarketResearchSessionsPrompt }
    : { system: SYSTEM_PROMPT_PRODUCT_RESEARCH, generator: generateProductResearchSessionsPrompt };
  
  // 生成 Sessions...
};
```

---

## 📝 Prompt 工程

### System Prompt 设计原则

1. **角色定位明确**：定义 AI 为专业用户研究专家
2. **输出格式规范**：明确 JSON 结构要求
3. **质量标准**：强调问题的开放性、深度和相关性

### User Prompt 结构

```
研究标题: ${name}
研究目标: ${objective}
问题数量: ${number}

[可选] 上下文信息: ${context}
[可选] 个性化备注: ${customInstructions}
[可选] 语言要求: ${language}

输出要求:
- JSON 格式
- 包含问题列表和研究描述
- 问题需要开放式、深入、相关
```

---

## 🌐 多语言支持

### 语言参数

- `language`: 访谈语言（最终访谈使用的语言）
- `outline_debug_language`: 大纲调试语言（研究者调试用）

### 语言优先级

```
outline_debug_language > language > 'en-US' (默认)
```

### 支持的语言

- `zh-CN`: 简体中文
- `zh-TW`: 繁体中文
- `en-US`: 英语
- `ja-JP`: 日语

---

## 🔄 与大纲本地化的集成

生成的问题可以通过大纲本地化功能进行语言转换：

```
1. 使用 outline_debug_language 生成初稿
   ↓
2. 研究者审核和调整
   ↓
3. 调用 /api/localize-outline 本地化到目标语言
   ↓
4. 生成最终访谈大纲
```

详见：[大纲本地化功能文档](./03-大纲本地化功能.md)

---

## 🎨 前端集成

### 创建访谈流程

**文件**: `frontend/src/components/dashboard/interview/create-popup/details.tsx`

**流程**：

1. 用户填写研究信息
2. 选择面试官（Lisa/Bob/David）
3. 点击"Generate with AI"
4. 调用对应的 API
5. 显示生成的问题
6. 进入问题编辑界面

### 关键代码

```typescript
const onGenerate = async () => {
  const data = {
    name, objective, number: numQuestions,
    context, researchType, customInstructions,
    language: selectedLanguage,
    outline_debug_language: outlineDebugLanguage
  };
  
  const apiEndpoint = isDeepDiveMode 
    ? "/generate-interview-sessions"
    : "/generate-interview-questions";
  
  const response = await apiClient.post(apiEndpoint, data, {
    timeout: 120000 // 2分钟超时
  });
  
  // 处理响应...
};
```

---

## 🚀 性能优化

### 超时设置

- **标准问题生成**: 120秒
- **深度 Sessions 生成**: 120秒

### 错误处理

```typescript
try {
  // 生成问题...
} catch (error) {
  if (error.code === 'ECONNABORTED') {
    // 超时错误
  } else if (error.response?.status === 429) {
    // API 配额限制
  } else {
    // 其他错误
  }
}
```

---

## 📊 数据流

```
用户输入
  ↓
前端验证
  ↓
API 请求 (POST /api/generate-interview-questions)
  ↓
Controller 接收参数
  ↓
构建 Prompt
  ↓
调用 OpenAI GPT-4o
  ↓
解析 JSON 响应
  ↓
返回前端
  ↓
显示问题列表
  ↓
用户编辑和保存
```

---

## 🔍 调试和日志

### 关键日志点

```typescript
console.log('🚀 Generating questions with data:', data);
console.log('📝 OpenAI Response:', content);
console.log('✅ Questions generated successfully');
```

### 常见问题

1. **生成的问题不符合预期**
   - 检查 Prompt 是否清晰
   - 调整 `customInstructions`
   - 增加 `context` 信息

2. **API 超时**
   - 检查网络连接
   - 检查 OpenAI API 状态
   - 增加超时时间

3. **语言不正确**
   - 检查 `outline_debug_language` 参数
   - 检查 Prompt 中的语言指令

---

## 📚 相关文档

- [大纲本地化功能](./03-大纲本地化功能.md)
- [技术架构](./01-技术架构.md)
- [数据库设计](./02-数据库设计.md)

---

**维护者**: Userology 开发团队  
**最后更新**: 2025-10-24

