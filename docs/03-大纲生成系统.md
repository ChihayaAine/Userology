# 访谈大纲生成系统

> **版本**: 1.4.5
> **最后更新**: 2025-10-31
> **重要更新**: 两步大纲生成系统 + Session Depth Level 系统

---

## 📖 系统概述

访谈大纲生成系统是 Userology 的核心功能之一，负责根据研究目标自动生成高质量的访谈大纲。系统支持两种模式：

1. **标准问题模式** (Lisa/Bob)：生成固定问题列表（传统模式）
2. **两步大纲生成模式** (David)：生成可编辑的 Session 骨架 → 生成完整大纲（**推荐**）

---

## 🏗️ 系统架构

### 两步大纲生成流程（v1.4.0+）

```
用户输入研究目标
    ↓
Step 1: 生成骨架
    ↓
AI 生成 Session 框架
（主题、目标、背景信息、深度等级）
    ↓
Step 2: 用户 Review & 编辑
    ↓
用户编辑骨架
（调整主题、添加必问问题、调整深度等级）
    ↓
Step 3: 生成完整大纲
    ↓
AI 基于骨架生成具体问题
（4-6 个问题 + 多层次追问策略）
    ↓
完整访谈大纲
```

### 技术栈

- **AI 模型**: OpenAI GPT-4o
- **API 代理**: tu-zi.com
- **Prompt 工程**: 两阶段 Prompt（骨架生成 + 完整大纲生成）
- **输出格式**: JSON (结构化数据)
- **状态管理**: Zustand Store（前端骨架编辑）

---

## 🎯 功能模式

### 模式 1: 两步大纲生成（推荐）

**适用场景**：
- 深度用户研究
- 需求探索
- 产品调研
- 需要精确控制访谈流程的场景

**核心优势**：
- ✅ 用户可预设 Session 主题
- ✅ 用户可添加必问问题
- ✅ 用户可调整 Session 深度等级
- ✅ AI 和用户协作生成大纲
- ✅ 生成结果可控、可预测

---

#### Step 1: 生成骨架

**API 端点**：
```
POST /api/outlines/skeleton
```

**请求参数**：
```typescript
{
  name: string;              // 研究名称
  objective: string;         // 研究目标
  context: string;           // 上下文
  session_count: number;     // Session 数量
  duration_minutes: number;  // 访谈时长（分钟）
  draft_language: string;    // 初稿语言（如 'zh-CN', 'en-US'）
  researchType: 'market' | 'product'; // 研究类型
  manualSessions?: Array<{   // 用户预设的 Session 主题（可选）
    session_number: number;
    theme: string;
  }>;
}
```

**响应格式**：
```typescript
{
  skeleton: {
    sessions: Array<{
      session_number: number;
      session_title: string;
      session_goal: string;
      background_information: string[];
      must_ask_questions: string[];
      depth_level: 'high' | 'medium' | 'low';
      ai_suggested_depth_level: 'high' | 'medium' | 'low';
    }>;
    metadata: {
      total_sessions: number;
      estimated_duration_minutes: number;
      draft_language: string;
    };
  };
  status: 'skeleton_generated';
}
```

**Prompt 文件**：
- `backend/src/lib/prompts/generate-outline-skeleton.ts`

**核心功能**：
1. **Session 主题生成**：AI 根据研究目标生成 Session 主题
2. **用户主题遵循**：如果用户预设了 Session 主题，AI 严格遵循
3. **背景信息生成**：为每个 Session 生成 5-8 条具体、可操作的背景信息
4. **深度等级分配**：AI 自动判断每个 Session 的深度等级（high/medium/low）

---

#### Step 2: 用户 Review & 编辑

**前端组件**：
- `frontend/src/components/dashboard/interview/create-popup/SessionCard.tsx`

**可编辑内容**：
1. **Session 标题**：修改 AI 生成的标题
2. **Session 目标**：调整 Session 的目标描述
3. **背景信息**：添加、编辑、删除背景信息
4. **必问问题**：添加用户指定的必问问题
5. **深度等级**：调整 Session 的深度等级（high/medium/low）

**API 端点**：
```
PATCH /api/outlines/:id/skeleton
```

**请求参数**：
```typescript
{
  skeleton: OutlineSkeleton; // 更新后的骨架
}
```

---

#### Step 3: 生成完整大纲

**API 端点**：
```
POST /api/outlines/:id/full-outline
```

**响应格式**：
```typescript
{
  draft_outline: Array<{
    session_text: string;    // 完整的 Session 文本（Markdown 格式）
    depth_level: 'high' | 'medium' | 'low';
  }>;
  description: string;       // 研究描述（50 字以内）
}
```

**Prompt 文件**：
- `backend/src/lib/prompts/generate-full-outline-from-skeleton.ts`

**核心功能**：
1. **问题数量分配**：根据 depth_level 分配问题数量
   - high: 5-6 个问题
   - medium: 4-5 个问题
   - low: 2-4 个问题
2. **多层次追问策略**：为关键问题生成 L1→L2→L3 追问
3. **必问问题融入**：将用户指定的必问问题自然融入访谈流程
4. **Session Opening**：为第一个 Session 生成 6 元素开场白
5. **结束提示**：在最后一个 Session 添加"点击结束访谈按钮"提示

---

### 模式 2: 标准问题生成（传统模式）

**适用场景**：
- 快速用户调研
- 标准化访谈流程
- 需要固定问题列表的场景

**API 端点**：
```
POST /api/generate-interview-questions
POST /api/generate-interview-sessions
```

**说明**：此模式为向后兼容保留，推荐使用两步大纲生成模式。

---

## 🎯 Session Depth Level 系统（v1.4.2+）

### 核心概念

Session Depth Level（会话深度等级）是一个用于控制访谈 Session 重要性和深度的系统。它影响：
- 问题数量
- 追问深度
- 时间分配
- AI 优先级

### 三个深度等级

| 等级 | 问题数量 | 追问深度 | 时间分配 | 适用场景 |
|------|---------|---------|---------|---------|
| **High** | 5-6 个 | 3-4 层 (L1→L2→L3) | 8-10 分钟 | 核心目标、痛点分析、竞品研究、功能验证 |
| **Medium** | 4-5 个 | 2-3 层 | 6-8 分钟 | 上下文构建、行为探索、一般体验 |
| **Low** | 2-4 个 | 1-2 层 | 4-5 分钟 | 暖场、收尾 |

### AI 判断逻辑

AI 在生成骨架时，会根据以下规则自动分配 depth_level：

1. **分析研究目标**：识别哪些 Session 直接解决核心研究问题
2. **问题类型判断**：
   - 探索"why"、"pain points"、"alternatives"的 Session → **high**
   - 探索"what"、"how"、"when"的 Session → **medium**
   - 第一个和最后一个 Session 通常 → **low**（除非研究专注于 onboarding/offboarding）
3. **典型分配**：2-3 high, 2-3 medium, 1-2 low

### 用户调整

用户可以在骨架 review 界面手动调整每个 Session 的 depth_level：

**UI 设计**：
- 三个按钮：Low (2-4 Qs) / Medium (4-5 Qs) / High (5-6 Qs)
- 颜色编码：灰色（Low）/ 蓝色（Medium）/ 紫色（High）
- 显示 AI 建议："(AI suggested: high)"
- 信息按钮（ℹ️）展开详细说明

**数据结构**：
```typescript
export type SessionDepthLevel = 'high' | 'medium' | 'low';

export interface SkeletonSession {
  session_number: number;
  session_title: string;
  session_goal: string;
  background_information: string[];
  must_ask_questions: string[];
  depth_level: SessionDepthLevel;           // 当前设置
  ai_suggested_depth_level: SessionDepthLevel; // AI 建议（不变）
}
```

### 影响维度

#### 1. 问题数量

生成完整大纲时，严格按照 depth_level 分配问题数量：

```typescript
// Prompt 中的逻辑
if (depth_level === 'high') {
  // 生成 5-6 个问题
} else if (depth_level === 'medium') {
  // 生成 4-5 个问题
} else {
  // 生成 2-4 个问题
}
```

#### 2. 追问深度

**High Depth Level**:
```
Q1.1 [Main Question]
  L1: [Initial clarification]
  L2: [If L1 reveals Y] → [Specific example]
  L3: [If L2 reveals Z] → [Impact/root cause]
```

**Medium Depth Level**:
```
Q1.1 [Main Question]
  L1: [Initial clarification]
  L2: [If L1 reveals Y] → [Specific example]
```

**Low Depth Level**:
```
Q1.1 [Main Question]
  L1: [Basic follow-up if needed]
```

#### 3. 时间分配（传递到 Retell AI）

在访谈执行时，depth_level 会传递到 Retell AI 的系统提示词：

```typescript
// backend/src/controllers/call.controller.ts
const dynamicVariables = {
  depth_level_1: session1.depth_level,
  depth_level_2: session2.depth_level,
  // ...
};
```

Retell AI 会根据 depth_level 调整时间分配：
- **high**: 8-10 分钟，深度追问
- **medium**: 6-8 分钟，标准追问
- **low**: 4-5 分钟，简洁高效

#### 4. AI 优先级

在生成完整大纲时，AI 会优先为 high depth level 的 Session 生成：
- 更详细的 Interviewer Notes
- 更具体的 Background Information 引用
- 更深入的追问策略

---

## 🔧 多层次追问策略（v1.4.1+）

### 设计理念

**问题背景**：
- 传统追问只有一层，无法深挖关键信息
- 例如：用户提到"使用不便"，追问后得到"无法在学校使用"，但没有继续追问"为什么"

**解决方案**：
设计分层追问机制（L1 → L2 → L3），从表面回答深挖到可执行洞察

### 三层追问

#### L1 (Surface Exploration)
**目标**：澄清模糊陈述，获取初步细节

**示例**：
- "What makes it inconvenient?"
- "Why can't it be used at school?"
- "What do you mean by 'not user-friendly'?"

#### L2 (Concrete Examples)
**目标**：请求具体场景，揭示真实行为

**示例**：
- "Can you walk me through a specific time when this happened?"
- "What exactly did you do when you encountered this issue?"
- "Can you describe the last time you used this feature?"

#### L3 (Impact & Root Cause)
**目标**：理解后果，识别潜在需求

**示例**：
- "How did that affect your study plan?"
- "What would an ideal solution look like?"
- "What did you do instead?"

### 应用场景

多层次追问主要应用于：
- 痛点分析
- 竞品分析
- 功能验证
- 需求探索

### Prompt 实现

```markdown
**Follow-up Directions (Multi-Level):**
[If user mentions X] →
  L1: [Initial clarification]
  L2: [If L1 reveals Y] → [Specific example]
  L3: [If L2 reveals Z] → [Impact/root cause]
**Skip if:** [Conditions]
```

---

## 📊 数据库设计

### 新增字段（v1.4.0）

```sql
-- interview 表
ALTER TABLE interview ADD COLUMN outline_skeleton JSONB;
ALTER TABLE interview ADD COLUMN outline_generation_status VARCHAR(50);
ALTER TABLE interview ADD COLUMN skeleton_generated_at TIMESTAMP WITH TIME ZONE;
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `outline_skeleton` | JSONB | 存储骨架数据（sessions + metadata） |
| `outline_generation_status` | VARCHAR | 生成状态（'skeleton_generated', 'full_outline_generated'） |
| `skeleton_generated_at` | TIMESTAMP | 骨架生成时间 |
| `draft_outline` | JSONB | 完整大纲（Array<{session_text, depth_level}>） |
| `outline_debug_language` | TEXT | 初稿语言代码（如 'zh-CN'） |

### 数据流向

```
1. 生成骨架 → outline_skeleton (包含 metadata.draft_language)
2. 用户编辑 → 更新 outline_skeleton
3. 生成完整大纲 → draft_outline (包含 depth_level)
4. 本地化（可选）→ localized_outline
5. 保存 → questions = localized_outline || draft_outline
```

---

## 🔧 实现细节

### Controller 层

**文件**: `backend/src/controllers/questions.controller.ts`

**核心函数**：

#### 1. `generateOutlineSkeleton` (v1.4.0+)

生成骨架（Step 1）

```typescript
export const generateOutlineSkeleton = async (req: Request, res: Response) => {
  const {
    name,
    objective,
    context,
    session_count,
    duration_minutes,
    draft_language,
    researchType,
    manualSessions
  } = req.body;

  // 1. 调用骨架生成 Prompt
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    temperature: 0.7,
    messages: [
      { role: "system", content: SYSTEM_PROMPT_SKELETON },
      { role: "user", content: generateSkeletonPrompt({
        objective,
        context,
        session_count,
        duration_minutes,
        language: draft_language,
        researchType,
        manualSessions
      })}
    ],
    response_format: { type: "json_object" }
  });

  // 2. 解析骨架
  const skeleton = JSON.parse(completion.choices[0].message?.content);

  // 3. 为每个 session 添加 ai_suggested_depth_level
  skeleton.sessions = skeleton.sessions.map(session => ({
    ...session,
    ai_suggested_depth_level: session.depth_level || 'medium'
  }));

  // 4. 确保 metadata.draft_language 存在
  if (!skeleton.metadata) skeleton.metadata = {};
  if (!skeleton.metadata.draft_language) {
    skeleton.metadata.draft_language = draft_language;
  }

  res.status(200).json({ skeleton, status: 'skeleton_generated' });
};
```

#### 2. `updateOutlineSkeleton` (v1.4.0+)

更新骨架（Step 2）

```typescript
export const updateOutlineSkeleton = async (req: Request, res: Response) => {
  const { id } = req.params;
  const { skeleton } = req.body;

  // 更新 interview 的 outline_skeleton 字段
  await InterviewService.updateInterview({
    outline_skeleton: skeleton
  }, id);

  res.status(200).json({ skeleton, status: 'skeleton_generated' });
};
```

#### 3. `generateFullOutlineFromSkeleton` (v1.4.0+)

生成完整大纲（Step 3）

```typescript
export const generateFullOutlineFromSkeleton = async (req: Request, res: Response) => {
  const { id } = req.params;

  // 1. 获取 interview 和 skeleton
  const interview = await InterviewService.getInterviewById(id);
  const skeleton = interview.outline_skeleton;

  // 2. 调用完整大纲生成 Prompt
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    temperature: 0.7,
    messages: [
      { role: "system", content: SYSTEM_PROMPT_FULL_OUTLINE },
      { role: "user", content: generateFullOutlinePrompt({
        skeleton,
        objective: interview.objective,
        context: interview.context,
        researchType: interview.researchType
      })}
    ],
    response_format: { type: "json_object" }
  });

  // 3. 解析完整大纲
  const result = JSON.parse(completion.choices[0].message?.content);

  // 4. 保存到数据库
  await InterviewService.updateInterview({
    draft_outline: result.questions,
    description: result.description,
    outline_generation_status: 'full_outline_generated'
  }, id);

  res.status(200).json(result);
};
```

---

## 📝 Prompt 工程

### Prompt 文件结构

**骨架生成**:
- `backend/src/lib/prompts/generate-outline-skeleton.ts`
  - `SYSTEM_PROMPT_SKELETON`: System Prompt
  - `generateSkeletonPrompt()`: User Prompt 生成函数

**完整大纲生成**:
- `backend/src/lib/prompts/generate-full-outline-from-skeleton.ts`
  - `SYSTEM_PROMPT_FULL_OUTLINE_PRODUCT`: 产品调研 System Prompt
  - `SYSTEM_PROMPT_FULL_OUTLINE_MARKET`: 市场调研 System Prompt
  - `generateFullOutlinePrompt()`: User Prompt 生成函数

### 骨架生成 Prompt 设计

#### System Prompt

```typescript
export const SYSTEM_PROMPT_SKELETON =
  "You are a world-class research expert and interview structure designer. " +
  "Your specialty is creating well-structured interview session frameworks " +
  "with SPECIFIC, ACTIONABLE background information.";
```

#### User Prompt 核心部分

1. **研究目标和上下文**
2. **Session 数量和时长**
3. **用户预设的 Session 主题**（如果有）
4. **Session Depth Level Assignment**（AI 判断逻辑）
5. **Background Information Requirements**（5-8 条，多视角、深度场景化）
6. **Output Format**（包含 depth_level 字段）
7. **Quality Checklist**

**关键部分示例**:

```markdown
## Session Depth Level Assignment

Analyze the research objective and assign a depth level to each session:

- **high**: Sessions that directly address core research questions
  - Exploring "why", "pain points", "alternatives"
  - Competitive analysis, feature validation
  - Typically: 2-3 sessions

- **medium**: Sessions that provide necessary context
  - Exploring "what", "how", "when"
  - Background building, behavior exploration
  - Typically: 2-3 sessions

- **low**: Sessions for warm-up or wrap-up
  - First and last sessions (unless research focuses on onboarding/offboarding)
  - Typically: 1-2 sessions
```

### 完整大纲生成 Prompt 设计

#### System Prompt

```typescript
export const SYSTEM_PROMPT_FULL_OUTLINE_PRODUCT =
  "You are a world-class user research expert specializing in product research interviews. " +
  "Your specialty is creating in-depth, open-ended interview questions with multi-level follow-up strategies.";
```

#### User Prompt 核心部分

1. **研究目标和上下文**
2. **Skeleton Summary**（显示每个 Session 的 depth_level）
3. **Your Task**（生成完整大纲的要求）
4. **Question Depth and Quantity Requirements**（根据 depth_level 分配问题数量）
5. **Multi-Level Follow-up Strategy**（L1→L2→L3）
6. **Output Format**（包含 session_text 和 depth_level）
7. **Quality Checklist**

**关键部分示例**:

```markdown
## Question Depth and Quantity Requirements

STRICTLY follow the `depth_level` from the skeleton:

- **high** (5-6 questions):
  - Deep reference to Study Objective
  - Fully utilize Background Information
  - Multi-level follow-ups (L1→L2→L3)

- **medium** (4-5 questions):
  - Moderate reference to Study Objective
  - Basic follow-ups (L1→L2)

- **low** (2-4 questions):
  - Simple conversation
  - Minimal follow-ups (L1 only)
```

### Temperature 设置

- **骨架生成**: 0.7（需要创造性，生成多样化的 Session 主题）
- **完整大纲生成**: 0.7（需要自然表达，生成流畅的问题）

### 输出格式

**骨架生成**:
```json
{
  "sessions": [
    {
      "session_number": 1,
      "session_title": "...",
      "session_goal": "...",
      "background_information": ["...", "..."],
      "must_ask_questions": [],
      "depth_level": "high"
    }
  ],
  "metadata": {
    "total_sessions": 6,
    "estimated_duration_minutes": 60,
    "draft_language": "zh-CN"
  }
}
```

**完整大纲生成**:
```json
{
  "questions": [
    {
      "session_text": "### **Session 1: ...**\n\n...",
      "depth_level": "high"
    }
  ],
  "description": "50-word description"
}
```

---

## 🌐 多语言支持

### 语言参数

- `draft_language`: 初稿语言（骨架和完整大纲生成时使用）
- `language`: 访谈语言（最终访谈使用的语言，可通过本地化转换）

### 语言流程

```
1. 用户选择 draft_language（如 'zh-CN'）
2. 生成骨架 → skeleton.metadata.draft_language = 'zh-CN'
3. 生成完整大纲 → 使用 skeleton.metadata.draft_language
4. （可选）本地化 → 转换为 language（如 'en-US'）
```

### 支持的语言

- `zh-CN`: 简体中文
- `zh-TW`: 繁体中文
- `en-US`: 英语
- `ja-JP`: 日语
- `fr-FR`: 法语
- `de-DE`: 德语
- `es-ES`: 西班牙语
- `ko-KR`: 韩语

### 语言一致性保证（v1.4.5）

**问题**：用户重新生成骨架（改变语言）后，生成的初稿依然使用旧语言

**解决方案**：
1. **后端**：确保 `skeleton.metadata.draft_language` 存在（如果 AI 没生成，手动添加）
2. **前端**：当 `interviewId` 已存在时，先更新 skeleton 再生成完整大纲

---

## 🔄 与大纲本地化的集成

生成的大纲可以通过大纲本地化功能进行语言转换：

```
1. 使用 outline_debug_language 生成初稿
   ↓
2. 研究者审核和调整
   ↓
3. 调用 /api/localize-outline 本地化到目标语言
   ↓
4. 生成最终访谈大纲
```

详见：[大纲本地化功能文档](./03-大纲本地化功能.md)

---

## 🎨 前端集成

### 两步大纲生成流程（v1.4.0+）

**主文件**: `frontend/src/components/dashboard/interview/create-popup/questions.tsx`

**流程**：

1. **用户配置**：
   - 填写研究信息（name, objective, context）
   - 选择 Session 数量和时长
   - 选择初稿语言（draft_language）
   - （可选）预设 Session 主题

2. **生成骨架**：
   - 点击"生成骨架"按钮
   - 调用 `POST /api/outlines/skeleton`
   - 显示骨架 review 界面

3. **编辑骨架**：
   - 使用 `SessionCard` 组件编辑每个 Session
   - 调整 Session 标题、目标、背景信息
   - 添加必问问题
   - 调整深度等级（depth_level）
   - 实时保存到 Zustand Store

4. **生成完整大纲**：
   - 点击"生成完整大纲"按钮
   - 如果 `interviewId` 已存在，先调用 `PATCH /api/outlines/:id/skeleton` 更新骨架
   - 调用 `POST /api/outlines/:id/full-outline`
   - 显示生成的完整大纲

### 核心组件

#### 1. SessionCard 组件

**文件**: `frontend/src/components/dashboard/interview/create-popup/SessionCard.tsx`

**功能**：
- 显示和编辑 Session 信息
- Depth Level 选择器（Low/Medium/High）
- 背景信息编辑（添加、删除）
- 必问问题编辑（添加、删除）

**关键代码**：

```typescript
const SessionCard = ({ session, onUpdate }) => {
  const [localSession, setLocalSession] = useState(session);

  const handleDepthLevelChange = (newLevel: SessionDepthLevel) => {
    const updated = { ...localSession, depth_level: newLevel };
    setLocalSession(updated);
    onUpdate(updated);
  };

  return (
    <div className="session-card">
      {/* Session 标题和目标 */}
      <input value={localSession.session_title} onChange={...} />
      <textarea value={localSession.session_goal} onChange={...} />

      {/* Depth Level 选择器 */}
      <div className="depth-level-selector">
        <button onClick={() => handleDepthLevelChange('low')}>
          Low (2-4 Qs)
        </button>
        <button onClick={() => handleDepthLevelChange('medium')}>
          Medium (4-5 Qs)
        </button>
        <button onClick={() => handleDepthLevelChange('high')}>
          High (5-6 Qs)
        </button>
      </div>

      {/* 背景信息和必问问题 */}
      {/* ... */}
    </div>
  );
};
```

#### 2. 骨架生成逻辑

```typescript
const onGenerateSkeleton = async () => {
  setIsGeneratingSkeleton(true);

  try {
    // 准备用户预设的 Session 主题
    const filledManualSessions = manualSessions
      .filter(s => s.content.trim())
      .map((s, idx) => ({
        session_number: idx + 1,
        theme: s.content.trim()
      }));

    // 生成骨架
    const result = await OutlineService.generateSkeleton({
      name: interviewData.name,
      objective: interviewData.objective,
      context: interviewData.context,
      session_count: Number(numQuestions),
      duration_minutes: Number(duration),
      draft_language: localOutlineDebugLanguage,
      researchType: researchType,
      manualSessions: filledManualSessions.length > 0 ? filledManualSessions : undefined
    });

    setSkeleton(result.skeleton);
    setShowSkeletonReview(true);
  } catch (error) {
    console.error('❌ Error generating skeleton:', error);
  } finally {
    setIsGeneratingSkeleton(false);
  }
};
```

#### 3. 完整大纲生成逻辑

```typescript
const onConfirmSkeletonAndGenerateFullOutline = async () => {
  if (!skeleton) return;

  setIsGeneratingFullOutline(true);

  try {
    // 如果还没有 interviewId，先创建 interview
    let currentInterviewId = interviewId;
    if (!currentInterviewId) {
      const createResponse = await apiClient.post("/interviews", {
        organizationName: organization?.name,
        interviewData: {
          ...interviewData,
          outline_skeleton: skeleton,
          outline_debug_language: localOutlineDebugLanguage
        }
      });
      currentInterviewId = createResponse.data.id;
      setInterviewId(currentInterviewId);
    } else {
      // 如果 interviewId 已存在，先更新 skeleton
      await OutlineService.updateSkeleton(currentInterviewId, skeleton);
    }

    // 生成完整大纲
    const result = await OutlineService.generateFullOutline(currentInterviewId);

    // 解析生成的问题
    const generatedQuestions = result.draft_outline.map((item, index) => ({
      id: uuidv4(),
      question: item.session_text,
      follow_up_count: 1,
      depth_level: item.depth_level || 'medium'
    }));

    setDraftQuestions(generatedQuestions);
    setInterviewData({
      ...interviewData,
      questions: generatedQuestions,
      description: result.description
    });

    setShowSkeletonReview(false);
  } catch (error) {
    console.error('❌ Error generating full outline:', error);
  } finally {
    setIsGeneratingFullOutline(false);
  }
};
```

---

## 🚀 性能优化

### 超时设置

- **骨架生成**: 120秒
- **完整大纲生成**: 120秒

### 错误处理

```typescript
try {
  // 生成骨架或完整大纲...
} catch (error) {
  if (error.code === 'ECONNABORTED') {
    // 超时错误
    toast.error('生成超时，请重试');
  } else if (error.response?.status === 429) {
    // API 配额限制
    toast.error('API 配额已用完，请稍后重试');
  } else if (error.response?.status === 403) {
    // 余额不足
    toast.error('API 余额不足，请充值');
  } else {
    // 其他错误
    toast.error('生成失败，请重试');
  }
}
```

---

## 📊 数据流

### 两步大纲生成数据流

```
用户输入（研究目标、Session 数量、语言）
  ↓
前端验证
  ↓
API 请求 (POST /api/outlines/skeleton)
  ↓
Controller 接收参数
  ↓
构建骨架生成 Prompt
  ↓
调用 OpenAI GPT-4o
  ↓
解析 JSON 响应（skeleton）
  ↓
添加 ai_suggested_depth_level
  ↓
确保 metadata.draft_language 存在
  ↓
返回前端
  ↓
显示骨架 review 界面
  ↓
用户编辑骨架（调整 depth_level、添加必问问题）
  ↓
保存到 Zustand Store
  ↓
用户点击"生成完整大纲"
  ↓
API 请求 (PATCH /api/outlines/:id/skeleton) - 更新骨架
  ↓
API 请求 (POST /api/outlines/:id/full-outline)
  ↓
Controller 读取 skeleton
  ↓
构建完整大纲生成 Prompt
  ↓
调用 OpenAI GPT-4o
  ↓
解析 JSON 响应（draft_outline）
  ↓
保存到数据库（draft_outline, description）
  ↓
返回前端
  ↓
显示完整大纲
  ↓
用户编辑和保存
```

---

## 🔍 调试和日志

### 关键日志点

**骨架生成**:
```typescript
console.log('🚀 Generating skeleton with data:', {
  session_count,
  draft_language,
  manualSessions
});
console.log('✅ Skeleton generated successfully:', {
  total_sessions: skeleton.metadata?.total_sessions,
  draft_language: skeleton.metadata?.draft_language
});
```

**完整大纲生成**:
```typescript
console.log('📝 Generating full outline from skeleton:', {
  total_sessions: skeleton.metadata.total_sessions,
  draft_language: skeleton.metadata.draft_language
});
console.log('✅ Full outline generated successfully:', {
  question_count: result.draft_outline.length
});
```

---

## 💡 最佳实践

### 1. Session 主题预设

**推荐做法**：
- 对于明确的研究目标，预设 Session 主题可以提高生成质量
- 例如：产品调研 → "产品发现"、"使用体验"、"痛点分析"、"竞品对比"

**不推荐做法**：
- 预设过于宽泛的主题（如"了解用户"）
- 预设过于具体的问题（应该在"必问问题"中添加）

### 2. Depth Level 调整

**推荐做法**：
- 信任 AI 的建议，只在必要时调整
- 确保至少有 2-3 个 high depth level 的 Session
- 第一个和最后一个 Session 通常设为 low

**不推荐做法**：
- 所有 Session 都设为 high（会导致访谈过长）
- 核心 Session 设为 low（会导致信息不足）

### 3. 必问问题添加

**推荐做法**：
- 添加关键的验证性问题（如"你会推荐给朋友吗？"）
- 添加特定的产品功能验证问题
- 保持简洁（每个 Session 1-2 个必问问题）

**不推荐做法**：
- 添加过多必问问题（会限制 AI 的灵活性）
- 添加过于开放的问题（应该让 AI 生成）

### 4. 背景信息编辑

**推荐做法**：
- 保留 AI 生成的多视角背景信息
- 添加特定的产品信息或竞品信息
- 确保背景信息具体、可操作

**不推荐做法**：
- 删除所有 AI 生成的背景信息
- 添加过于宽泛的背景信息

---

## 🐛 常见问题和解决方案

### 问题 1: AI 只生成首尾 Session（已修复 v1.4.5）

**现象**: 创建 6 个 sessions，只生成 session 1 和 session 6

**原因**: Prompt 的输出格式示例只显示了 Session 1 和最后一个 Session

**解决方案**:
- 在 Prompt 中添加 "CRITICAL: You MUST generate EXACTLY N sessions" 警告
- 添加 Session 2 示例

### 问题 2: 重新生成初稿时语言不更新（已修复 v1.4.5）

**现象**: 重新生成骨架（改变语言）后，初稿依然使用旧语言

**原因**: 前端没有更新数据库中的 skeleton

**解决方案**:
- 前端：当 `interviewId` 已存在时，先调用 `updateSkeleton` 再生成完整大纲
- 后端：确保 `skeleton.metadata.draft_language` 存在

### 问题 3: API 余额不足

**现象**: 错误信息 "预扣费额度失败, 用户剩余额度: $X, 需要预扣费额度: $Y"

**原因**: tu-zi.com API 账户余额不足

**解决方案**:
- 登录 https://tu-zi.com 充值
- 建议充值 $5-10，避免频繁充值

### 问题 4: 生成的问题数量不符合 depth_level

**现象**: high depth level 的 Session 只生成了 3 个问题

**原因**: Prompt 中的要求不够明确

**解决方案**:
- 检查 Prompt 中的 "Question Depth and Quantity Requirements" 部分
- 确保使用 "STRICTLY follow the `depth_level`" 等强调性语言

### 问题 5: 必问问题没有被融入

**现象**: 用户添加的必问问题没有出现在完整大纲中

**原因**: Prompt 中没有正确传递 `must_ask_questions`

**解决方案**:
- 检查 `generateFullOutlinePrompt` 函数
- 确保 skeleton 中的 `must_ask_questions` 被正确传递到 Prompt
   - 增加超时时间

---

## � 版本历史

### v1.4.5 (2025-10-31)
- 🐛 修复 AI 只生成首尾 session 的问题
- 🐛 修复重新生成初稿时语言不更新的问题
- 📝 添加详细调试日志

### v1.4.4 (2025-10-30)
- 🎨 骨架生成 Context 深度强化
- 🐛 修复 AI suggested depth level 显示问题

### v1.4.3 (2025-10-30)
- 🎨 Depth Level 语义增强
- 🔧 数据结构优化

### v1.4.2 (2025-10-30)
- 🚀 Session Depth Level 系统实现
- 🎨 Depth Level 选择器 UI

### v1.4.1 (2025-10-30)
- 🚀 多层次追问策略（L1→L2→L3）
- 🚀 智能问题数量分配

### v1.4.0 (2025-10-30)
- 🚀 两步大纲生成系统完整实现
- 🚀 Session 配置传导
- 🚀 必问问题功能
- 📊 数据库字段添加（outline_skeleton, outline_generation_status）

### v1.3.8 (2025-10-26)
- 🎯 追问生成逻辑优化（方向性指示、Session 抽象化）

### v1.3.7 (2025-10-25)
- 🎨 深度访谈 Prompt 优化（开放性问题、Study Objective 必问项）

### v1.3.6 (2025-10-24)
- 🔧 智能补全机制（已废弃，v1.4.0+ 使用新流程）

---

## �🔧 旧版本功能（v1.3.x）

以下功能在 v1.4.0 之前使用，现已被两步大纲生成系统取代：

### 智能补全机制 (v1.3.6)

### 问题背景

在深度访谈模式（David）中，GPT 有时会生成错误数量的 Sessions：
- 用户请求 10 个 Sessions，GPT 可能只生成 8 个
- 用户请求 5 个 Sessions，GPT 可能生成 6 个

### 解决方案

**三层保障机制**：

#### 1. Prompt 强化（预防）

在 User Prompt 中添加严格的数量要求：

```typescript
⚠️ **STRICT SESSION COUNT REQUIREMENT** ⚠️:
You MUST generate EXACTLY ${requestedCount} sessions - no more, no less.
- ❌ Do NOT generate ${requestedCount + 1} sessions
- ❌ Do NOT generate ${requestedCount - 1} sessions
- ✅ Generate EXACTLY ${requestedCount} complete sessions
- If you generate the wrong number, the system will malfunction
```

#### 2. 智能补全（修复）

如果 GPT 生成的数量不足，自动调用 GPT 补全：

```typescript
// 检测数量不匹配
if (actualCount < requestedCount) {
  const missing = requestedCount - actualCount;

  // 调用 GPT 补全剩余 Sessions
  const complementPrompt = `
    You previously generated ${actualCount} sessions.
    Now generate EXACTLY ${missing} MORE sessions.
    Continue from Session ${actualCount + 1} to Session ${requestedCount}.
  `;

  // 合并原始和补全的 Sessions
  allSessions = [...originalSessions, ...complementSessions];
}
```

#### 3. 智能截断（修复）

如果 GPT 生成的数量过多，自动截断：

```typescript
if (actualCount > requestedCount) {
  sessions = sessions.slice(0, requestedCount);
}
```

### 技术实现

**位置**: `backend/src/controllers/questions.controller.ts`

**核心逻辑**：

```typescript
// 1. 验证生成的数量
const actualCount = parsedContent.questions?.length || 0;
const requestedCount = Math.min(body.number, 10);

// 2. 记录详细日志
console.log('📊 Session Count Verification:', {
  requested: requestedCount,
  actualGenerated: actualCount,
  match: actualCount === requestedCount ? '✅' : '❌'
});

// 3. 智能补全或截断
if (actualCount < requestedCount) {
  // 调用 GPT 补全
  const complementResponse = await openaiClient.chat.completions.create({...});
  parsedContent.questions = [...original, ...complement];
} else if (actualCount > requestedCount) {
  // 截断多余的
  parsedContent.questions = parsedContent.questions.slice(0, requestedCount);
}
```

### 效果

- ✅ **准确性**: 100% 保证生成正确数量的 Sessions
- ✅ **质量**: 补全的 Sessions 与原始 Sessions 质量一致
- ✅ **连贯性**: 补全的 Sessions 自然衔接原始内容
- ✅ **可追溯**: 详细的日志记录，便于调试

### 相关 Prompt 更新

**文件**:
- `backend/src/lib/prompts/generate-sessions.ts`
- `backend/src/lib/prompts/generate-market-research-sessions.ts`
- `backend/src/lib/prompts/generate-product-research-sessions.ts`

**更新内容**: 添加严格的数量要求警告

---

## 🎨 深度访谈 Prompt 优化 (v1.3.7)

### 优化目标

针对深度访谈模式（David）的 Prompt 进行全面优化，提升生成的访谈大纲质量：

1. **强化开放性问题设计原则**
2. **添加 Study Objective 必问项识别逻辑**
3. **优化追问设计策略**（关键问题 vs 即兴追问）
4. **清理本地化相关内容**（已拆分到独立函数）

### 1. 开放性问题设计原则 🎯

**核心理念**: 让参与者定义自己的体验，不预设立场或假设。

#### ❌ 避免的问题类型

**引导性问题**（假设问题存在）:
```
❌ "How difficult is it to manage your tasks?"
❌ "How often do you struggle with [task]?"
❌ "What challenges do you face when..."
```

**暗示性问题**（假设需求存在）:
```
❌ "What features would you like to see?"
❌ "What improvements would you suggest?"
❌ "Don't you think X would be helpful?"
```

**假设性问题**（假设体验是正面或负面的）:
```
❌ "What do you like about [Feature]?"
❌ "How useful is [Feature]?"
❌ "What frustrates you about..."
```

#### ✅ 推荐的问题类型

**行为探索问题**:
```
✅ "Tell me about how you currently manage your tasks."
✅ "Walk me through your typical workflow for [scenario]."
✅ "Can you describe a recent time when you [did X]?"
```

**体验描述问题**:
```
✅ "What's your experience been like with [topic]?"
✅ "How does [Product] fit into your daily routine?"
✅ "Tell me about your experience using [Feature]."
```

**具体案例问题**:
```
✅ "Can you walk me through a specific recent example?"
✅ "What happened the last time you [did X]?"
✅ "Tell me about a time when..."
```

#### 关键原则

1. **聚焦行为**：问人们做什么，而非想什么
2. **避免判断词**：不使用 "difficult", "struggle", "problem", "useful" 等词（除非用户先提到）
3. **中性探索**：使用 "tell me about", "walk me through", "describe", "what's your experience"
4. **具体案例**：要求具体的过去行为，而非假设或意见

### 2. Study Objective 必问项识别 🔑

**功能**: 自动识别研究目标中明确要求的必问问题或数据收集项。

#### 识别逻辑

Prompt 会分析 Research Objective，识别：
- 明确要求的问题
- 必须收集的数据点
- 特定的功能或主题验证需求
- 关键的用户群体或场景

#### 融入策略

**战略性放置**:
- 人口统计问题 → Session 1（破冰环节）
- 特定功能验证 → Session 3（核心功能深挖）
- 竞品对比 → Session 5（竞品对比环节）

**明确标记**:
```
Q3.2 [Interviewer notes: [MUST-ASK per Study Objective] This question validates
the new feature mentioned in research objective...]
Question: "Tell me about your experience with [specific feature]."
```

#### 效果

- ✅ 确保关键研究目标不会被遗漏
- ✅ 必问项自然融入访谈流程
- ✅ 面试官清楚知道哪些问题是必须问的

### 3. 智能追问策略 🎯

**核心理念**: 关键问题深挖，一般问题灵活。

#### A. 硬编码追问（仅用于关键问题）

**使用条件**（必须同时满足）:
- ✅ 问题直接关联核心研究目标
- ✅ 问题是 Study Objective 的必问项
- ✅ 缺失追问会导致关键洞察缺失
- ✅ 追问探索的维度不会自然涌现

**格式**:
```
**Follow-up Strategy:**
[Condition 1: If user mentions X] "Follow-up question..."
[Condition 2: If user describes Y] "Follow-up question..."
**Skip Conditions:** If context is awkward or user has already answered, skip
```

**示例**:
```
Q3.1 [MUST-ASK] Question: "Tell me about your experience with [new feature]."

**Follow-up Strategy:**
[If user describes usage] "Can you walk me through a specific recent example?"
[If user mentions any friction] "Tell me more about that - what happened?"
**Skip Conditions:** If user has already provided detailed examples, skip follow-ups
```

#### B. 即兴追问（用于一般问题）

**使用条件**:
- 问题不是核心研究目标的关键部分
- 追问可以根据用户回答灵活调整
- 不需要特定维度的深挖

**标记方式**:
```
Q2.3 [Interviewer notes: [Rely on impromptu follow-ups based on user response]]
Question: "What else happens in this process?"
```

**优势**:
- 避免过度脚本化
- 访谈更自然、更像真实对话
- 充分利用 Retell AI 的即兴追问能力

#### C. 标准即兴追问指令

每个 Session 都包含标准指导：

```
**Impromptu Follow-up Guidance**:
If the user shares any new information relevant to our research goals,
conduct 1-2 follow-up questions to understand deeply (why/what/how/impact).
If irrelevant, briefly acknowledge and continue. For questions with set
follow-ups, skip if user has already answered in main response. When
acknowledging responses, vary your expressions: 'okay,' 'I see,'
'understood,' 'that makes sense,' 'got it,' 'right,' etc.
```

### 4. 本地化内容清理 🧹

**变更**:
- ❌ 移除详细的文化适配指令
- ❌ 移除 "Localization Reminders" 章节
- ✅ 简化语言配置（仅保留基本语言要求）
- ✅ 添加说明：文化适配在独立步骤中处理

**原因**:
- 本地化功能已拆分到 `backend/src/lib/prompts/localize-outline.ts`
- 大纲生成聚焦内容质量，本地化聚焦文化适配
- 职责分离，提升各自质量

### 5. 市场调研特定优化

#### 痛点发现（而非假设）

**旧方法**（假设痛点存在）:
```
❌ "What frustrates you the most when dealing with [scenario]?"
```

**新方法**（让痛点自然涌现）:
```
✅ "Tell me about your current process for [scenario]."
→ [If user mentions friction] "Tell me more about that - what happened?"
```

#### 理想解决方案探索

**旧方法**（直接问功能需求）:
```
❌ "What features would you like to see?"
```

**新方法**（探索理想状态）:
```
✅ "If you could wave a magic wand, how would this process work ideally?"
→ "What's most important in that ideal scenario?"
```

### 6. 产品调研特定优化

#### 功能发现（而非假设）

**旧方法**（假设用户已发现功能）:
```
❌ "How useful is [Feature]?"
```

**新方法**（探索实际使用）:
```
✅ "Tell me about your experience using [Product]."
→ [If user mentions feature] "How did you first come across this feature?"
→ "What's your understanding of what it does?"
→ "How often do you use it? In what situations?"
```

#### 竞品对比策略

**旧方法**（直接问竞品）:
```
❌ "Which competitors have you used?"
```

**新方法**（自然引出对比）:
```
✅ "Before using [Product], what tools or methods did you use for [task]?"
→ [If they mention alternatives] "What's different about your experience
   with [Product] compared to [Alternative]?"
```

### 优化效果

**质量提升**:
- ✅ 生成的问题更加开放、无偏见
- ✅ 减少引导性问题导致的数据偏差
- ✅ 访谈流程更自然、更像真实对话

**目标达成**:
- ✅ 关键研究目标的必问项不会遗漏
- ✅ 核心问题得到深度挖掘
- ✅ 一般问题保持灵活性

**用户体验**:
- ✅ 参与者感觉更舒适，愿意分享真实体验
- ✅ 面试官有清晰的指导，知道何时深挖、何时灵活
- ✅ 访谈节奏更自然，不会感觉机械

### 影响的文件

- `backend/src/lib/prompts/generate-market-research-sessions.ts` (248 lines → 279 lines)
- `backend/src/lib/prompts/generate-product-research-sessions.ts` (241 lines → 274 lines)

---

## 🎯 追问生成逻辑优化 (v1.3.8)

### 优化目标

进一步优化追问生成逻辑，使访谈执行更灵活、更自然：

1. **移除即兴追问相关内容**（系统自动处理）
2. **追问改为方向性指示**（而非固定句子）
3. **Session 案例抽象化**（避免过度具象）
4. **删除过拟合规则**（如 AI collection）

### 核心变更

#### 1. 移除即兴追问指导 🧹

**删除内容**:
- ❌ "Standard Impromptu Instructions" 章节
- ❌ "Impromptu Follow-up Guidance" 内容

**原因**: 访谈执行系统（Retell AI）已内置即兴追问能力，在大纲生成阶段重复指导是冗余的。

#### 2. 追问改为方向性指示 🎯

**旧格式**（固定句子）:
```
[If user mentions friction] "Can you tell me more? What happened?"
```

**新格式**（方向性指示）:
```
[If user mentions friction] → Probe for: specific examples, impact, solutions
```

**优势**: Agent 可根据语境灵活措辞，访谈更自然。

#### 3. Session 案例抽象化 📋

**旧格式**（过于具象）:
```
- Session 1: Ice-breaking + Current behavior
- Session 2: Pain points deep dive
- Session 5: AI/Technology expectations
```

**新格式**（抽象原则）:
```
Session Flow: Intro → Open Exploration → Targeted Collection → Closure
Session Themes: Early (context) → Middle (deep dive) → Later (synthesis)
```

#### 4. 删除过拟合规则 🧹

**删除**: "AI/Technology Expectations" 章节（逆向工程时过拟合的特定案例）

### 优化效果

- ✅ 访谈更灵活、更自然
- ✅ 大纲更适配具体研究目标
- ✅ 职责分离：大纲聚焦关键问题，执行聚焦灵活措辞

### 影响的文件

- `backend/src/lib/prompts/generate-market-research-sessions.ts` (279 lines → 272 lines)
- `backend/src/lib/prompts/generate-product-research-sessions.ts` (279 lines → 272 lines)

---

## 📚 相关文档

- [Session Depth Level 完整实现总结](./Session-Depth-Level-完整实现总结.md)
- [大纲本地化功能](./04-大纲本地化功能.md)
- [访谈执行 - Retell AI 语音交互](./05-访谈执行-Retell AI语音交互.md)
- [技术架构](./01-技术架构.md)
- [数据库设计](./02-数据库设计.md)
- [CHANGELOG](./CHANGELOG.md)

---

## 🎓 学习资源

### 推荐阅读

1. **用户研究方法论**:
   - [The Mom Test](http://momtestbook.com/) - 如何问出真实答案
   - [Just Enough Research](https://abookapart.com/products/just-enough-research) - 用户研究基础

2. **访谈技巧**:
   - [Interviewing Users](https://rosenfeldmedia.com/books/interviewing-users/) - 访谈用户指南
   - [The User Interview](https://www.nngroup.com/articles/user-interviews/) - Nielsen Norman Group

3. **Prompt 工程**:
   - [OpenAI Prompt Engineering Guide](https://platform.openai.com/docs/guides/prompt-engineering)
   - [Anthropic Prompt Engineering](https://docs.anthropic.com/claude/docs/prompt-engineering)

### 内部文档

- [Augment-Memories.md](./Augment-Memories.md) - 项目核心记忆
- [任务清单.md](./任务清单.md) - 当前任务跟踪

---

**维护者**: Userology 开发团队
**最后更新**: 2025-10-31
**版本**: 1.4.5

