# 访谈问题生成系统

> **版本**: 1.3.8
> **最后更新**: 2025-10-26
> **重要更新**: 追问生成逻辑优化（方向性指示、Session 抽象化、移除冗余指导）

---

## 📖 系统概述

访谈问题生成系统是 Userology 的核心功能之一，负责根据研究目标自动生成高质量的访谈问题或深度访谈大纲。系统支持两种模式：

1. **标准问题模式** (Lisa/Bob)：生成固定问题列表
2. **深度访谈模式** (David)：生成多阶段 Session 大纲

---

## 🏗️ 系统架构

### 核心组件

```
前端创建界面
    ↓
API 路由层
    ↓
Questions Controller
    ↓
OpenAI GPT-4o
    ↓
返回生成的问题/Sessions
```

### 技术栈

- **AI 模型**: OpenAI GPT-4o
- **API 代理**: tu-zi.com
- **Prompt 工程**: 专业化的 System Prompt 和 User Prompt
- **输出格式**: JSON (结构化数据)

---

## 🎯 功能模式

### 模式 1: 标准问题生成 (Lisa/Bob)

**适用场景**：
- 快速用户调研
- 标准化访谈流程
- 需要固定问题列表的场景

**API 端点**：
```
POST /api/generate-interview-questions
```

**请求参数**：
```typescript
{
  name: string;              // 研究名称
  objective: string;         // 研究目标
  number: number;            // 问题数量
  context: string;           // 上下文（可选）
  researchType: string;      // 研究类型
  customInstructions: string; // 个性化备注（可选）
  language: string;          // 访谈语言（可选）
  outline_debug_language: string; // 大纲调试语言（可选）
}
```

**响应格式**：
```typescript
{
  questions: Array<{
    id: string;
    question: string;
    follow_up_count: number;
  }>;
  description: string; // 研究描述
}
```

**Prompt 文件**：
- `backend/src/lib/prompts/generate-questions.ts`

---

### 模式 2: 深度访谈 Sessions (David)

**适用场景**：
- 深度用户研究
- 需求探索
- 产品调研

**API 端点**：
```
POST /api/generate-interview-sessions
```

**请求参数**：同标准模式

**响应格式**：
```typescript
{
  sessions: Array<{
    session_number: number;
    session_title: string;
    session_objective: string;
    questions: Array<{
      id: string;
      question: string;
      follow_up_count: number;
    }>;
  }>;
  description: string;
}
```

**Prompt 文件**：
- 市场调研：`backend/src/lib/prompts/generate-market-research-sessions.ts`
- 产品调研：`backend/src/lib/prompts/generate-product-research-sessions.ts`
- 通用：`backend/src/lib/prompts/generate-sessions.ts`

---

## 🔧 实现细节

### Controller 层

**文件**: `backend/src/controllers/questions.controller.ts`

**核心函数**：

#### 1. `generateInterviewQuestions`

```typescript
export const generateInterviewQuestions = async (req: Request, res: Response) => {
  const { name, objective, number, context, researchType, customInstructions, language, outline_debug_language } = req.body;
  
  // 1. 构建 Prompt
  const prompt = generateQuestionsPrompt({
    name,
    objective,
    number,
    context,
    customInstructions,
    language: outline_debug_language || language
  });
  
  // 2. 调用 OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: prompt }
    ],
    response_format: { type: "json_object" }
  });
  
  // 3. 解析并返回
  const content = completion.choices[0].message?.content;
  res.status(200).json({ response: content });
};
```

#### 2. `generateInterviewSessions`

```typescript
export const generateInterviewSessions = async (req: Request, res: Response) => {
  const { researchType } = req.body;
  
  // 根据研究类型选择不同的 Prompt
  const promptConfig = researchType === 'market_research' 
    ? { system: SYSTEM_PROMPT_MARKET_RESEARCH, generator: generateMarketResearchSessionsPrompt }
    : { system: SYSTEM_PROMPT_PRODUCT_RESEARCH, generator: generateProductResearchSessionsPrompt };
  
  // 生成 Sessions...
};
```

---

## 📝 Prompt 工程

### System Prompt 设计原则

1. **角色定位明确**：定义 AI 为专业用户研究专家
2. **输出格式规范**：明确 JSON 结构要求
3. **质量标准**：强调问题的开放性、深度和相关性

### User Prompt 结构

```
研究标题: ${name}
研究目标: ${objective}
问题数量: ${number}

[可选] 上下文信息: ${context}
[可选] 个性化备注: ${customInstructions}
[可选] 语言要求: ${language}

输出要求:
- JSON 格式
- 包含问题列表和研究描述
- 问题需要开放式、深入、相关
```

---

## 🌐 多语言支持

### 语言参数

- `language`: 访谈语言（最终访谈使用的语言）
- `outline_debug_language`: 大纲调试语言（研究者调试用）

### 语言优先级

```
outline_debug_language > language > 'en-US' (默认)
```

### 支持的语言

- `zh-CN`: 简体中文
- `zh-TW`: 繁体中文
- `en-US`: 英语
- `ja-JP`: 日语

---

## 🔄 与大纲本地化的集成

生成的问题可以通过大纲本地化功能进行语言转换：

```
1. 使用 outline_debug_language 生成初稿
   ↓
2. 研究者审核和调整
   ↓
3. 调用 /api/localize-outline 本地化到目标语言
   ↓
4. 生成最终访谈大纲
```

详见：[大纲本地化功能文档](./03-大纲本地化功能.md)

---

## 🎨 前端集成

### 创建访谈流程

**文件**: `frontend/src/components/dashboard/interview/create-popup/details.tsx`

**流程**：

1. 用户填写研究信息
2. 选择面试官（Lisa/Bob/David）
3. 点击"Generate with AI"
4. 调用对应的 API
5. 显示生成的问题
6. 进入问题编辑界面

### 关键代码

```typescript
const onGenerate = async () => {
  const data = {
    name, objective, number: numQuestions,
    context, researchType, customInstructions,
    language: selectedLanguage,
    outline_debug_language: outlineDebugLanguage
  };
  
  const apiEndpoint = isDeepDiveMode 
    ? "/generate-interview-sessions"
    : "/generate-interview-questions";
  
  const response = await apiClient.post(apiEndpoint, data, {
    timeout: 120000 // 2分钟超时
  });
  
  // 处理响应...
};
```

---

## 🚀 性能优化

### 超时设置

- **标准问题生成**: 120秒
- **深度 Sessions 生成**: 120秒

### 错误处理

```typescript
try {
  // 生成问题...
} catch (error) {
  if (error.code === 'ECONNABORTED') {
    // 超时错误
  } else if (error.response?.status === 429) {
    // API 配额限制
  } else {
    // 其他错误
  }
}
```

---

## 📊 数据流

```
用户输入
  ↓
前端验证
  ↓
API 请求 (POST /api/generate-interview-questions)
  ↓
Controller 接收参数
  ↓
构建 Prompt
  ↓
调用 OpenAI GPT-4o
  ↓
解析 JSON 响应
  ↓
返回前端
  ↓
显示问题列表
  ↓
用户编辑和保存
```

---

## 🔍 调试和日志

### 关键日志点

```typescript
console.log('🚀 Generating questions with data:', data);
console.log('📝 OpenAI Response:', content);
console.log('✅ Questions generated successfully');
```

### 常见问题

1. **生成的问题不符合预期**
   - 检查 Prompt 是否清晰
   - 调整 `customInstructions`
   - 增加 `context` 信息

2. **API 超时**
   - 检查网络连接
   - 检查 OpenAI API 状态
   - 增加超时时间

3. **语言不正确**
   - 检查 `outline_debug_language` 参数
   - 检查 Prompt 中的语言指令

4. **生成的 Session 数量不正确** (v1.3.6 已修复)
   - 问题：GPT 有时会生成错误数量的 Sessions
   - 解决方案：智能补全机制（自动检测并补全缺失的 Sessions）

---

## 🔧 智能补全机制 (v1.3.6)

### 问题背景

在深度访谈模式（David）中，GPT 有时会生成错误数量的 Sessions：
- 用户请求 10 个 Sessions，GPT 可能只生成 8 个
- 用户请求 5 个 Sessions，GPT 可能生成 6 个

### 解决方案

**三层保障机制**：

#### 1. Prompt 强化（预防）

在 User Prompt 中添加严格的数量要求：

```typescript
⚠️ **STRICT SESSION COUNT REQUIREMENT** ⚠️:
You MUST generate EXACTLY ${requestedCount} sessions - no more, no less.
- ❌ Do NOT generate ${requestedCount + 1} sessions
- ❌ Do NOT generate ${requestedCount - 1} sessions
- ✅ Generate EXACTLY ${requestedCount} complete sessions
- If you generate the wrong number, the system will malfunction
```

#### 2. 智能补全（修复）

如果 GPT 生成的数量不足，自动调用 GPT 补全：

```typescript
// 检测数量不匹配
if (actualCount < requestedCount) {
  const missing = requestedCount - actualCount;

  // 调用 GPT 补全剩余 Sessions
  const complementPrompt = `
    You previously generated ${actualCount} sessions.
    Now generate EXACTLY ${missing} MORE sessions.
    Continue from Session ${actualCount + 1} to Session ${requestedCount}.
  `;

  // 合并原始和补全的 Sessions
  allSessions = [...originalSessions, ...complementSessions];
}
```

#### 3. 智能截断（修复）

如果 GPT 生成的数量过多，自动截断：

```typescript
if (actualCount > requestedCount) {
  sessions = sessions.slice(0, requestedCount);
}
```

### 技术实现

**位置**: `backend/src/controllers/questions.controller.ts`

**核心逻辑**：

```typescript
// 1. 验证生成的数量
const actualCount = parsedContent.questions?.length || 0;
const requestedCount = Math.min(body.number, 10);

// 2. 记录详细日志
console.log('📊 Session Count Verification:', {
  requested: requestedCount,
  actualGenerated: actualCount,
  match: actualCount === requestedCount ? '✅' : '❌'
});

// 3. 智能补全或截断
if (actualCount < requestedCount) {
  // 调用 GPT 补全
  const complementResponse = await openaiClient.chat.completions.create({...});
  parsedContent.questions = [...original, ...complement];
} else if (actualCount > requestedCount) {
  // 截断多余的
  parsedContent.questions = parsedContent.questions.slice(0, requestedCount);
}
```

### 效果

- ✅ **准确性**: 100% 保证生成正确数量的 Sessions
- ✅ **质量**: 补全的 Sessions 与原始 Sessions 质量一致
- ✅ **连贯性**: 补全的 Sessions 自然衔接原始内容
- ✅ **可追溯**: 详细的日志记录，便于调试

### 相关 Prompt 更新

**文件**:
- `backend/src/lib/prompts/generate-sessions.ts`
- `backend/src/lib/prompts/generate-market-research-sessions.ts`
- `backend/src/lib/prompts/generate-product-research-sessions.ts`

**更新内容**: 添加严格的数量要求警告

---

## 🎨 深度访谈 Prompt 优化 (v1.3.7)

### 优化目标

针对深度访谈模式（David）的 Prompt 进行全面优化，提升生成的访谈大纲质量：

1. **强化开放性问题设计原则**
2. **添加 Study Objective 必问项识别逻辑**
3. **优化追问设计策略**（关键问题 vs 即兴追问）
4. **清理本地化相关内容**（已拆分到独立函数）

### 1. 开放性问题设计原则 🎯

**核心理念**: 让参与者定义自己的体验，不预设立场或假设。

#### ❌ 避免的问题类型

**引导性问题**（假设问题存在）:
```
❌ "How difficult is it to manage your tasks?"
❌ "How often do you struggle with [task]?"
❌ "What challenges do you face when..."
```

**暗示性问题**（假设需求存在）:
```
❌ "What features would you like to see?"
❌ "What improvements would you suggest?"
❌ "Don't you think X would be helpful?"
```

**假设性问题**（假设体验是正面或负面的）:
```
❌ "What do you like about [Feature]?"
❌ "How useful is [Feature]?"
❌ "What frustrates you about..."
```

#### ✅ 推荐的问题类型

**行为探索问题**:
```
✅ "Tell me about how you currently manage your tasks."
✅ "Walk me through your typical workflow for [scenario]."
✅ "Can you describe a recent time when you [did X]?"
```

**体验描述问题**:
```
✅ "What's your experience been like with [topic]?"
✅ "How does [Product] fit into your daily routine?"
✅ "Tell me about your experience using [Feature]."
```

**具体案例问题**:
```
✅ "Can you walk me through a specific recent example?"
✅ "What happened the last time you [did X]?"
✅ "Tell me about a time when..."
```

#### 关键原则

1. **聚焦行为**：问人们做什么，而非想什么
2. **避免判断词**：不使用 "difficult", "struggle", "problem", "useful" 等词（除非用户先提到）
3. **中性探索**：使用 "tell me about", "walk me through", "describe", "what's your experience"
4. **具体案例**：要求具体的过去行为，而非假设或意见

### 2. Study Objective 必问项识别 🔑

**功能**: 自动识别研究目标中明确要求的必问问题或数据收集项。

#### 识别逻辑

Prompt 会分析 Research Objective，识别：
- 明确要求的问题
- 必须收集的数据点
- 特定的功能或主题验证需求
- 关键的用户群体或场景

#### 融入策略

**战略性放置**:
- 人口统计问题 → Session 1（破冰环节）
- 特定功能验证 → Session 3（核心功能深挖）
- 竞品对比 → Session 5（竞品对比环节）

**明确标记**:
```
Q3.2 [Interviewer notes: [MUST-ASK per Study Objective] This question validates
the new feature mentioned in research objective...]
Question: "Tell me about your experience with [specific feature]."
```

#### 效果

- ✅ 确保关键研究目标不会被遗漏
- ✅ 必问项自然融入访谈流程
- ✅ 面试官清楚知道哪些问题是必须问的

### 3. 智能追问策略 🎯

**核心理念**: 关键问题深挖，一般问题灵活。

#### A. 硬编码追问（仅用于关键问题）

**使用条件**（必须同时满足）:
- ✅ 问题直接关联核心研究目标
- ✅ 问题是 Study Objective 的必问项
- ✅ 缺失追问会导致关键洞察缺失
- ✅ 追问探索的维度不会自然涌现

**格式**:
```
**Follow-up Strategy:**
[Condition 1: If user mentions X] "Follow-up question..."
[Condition 2: If user describes Y] "Follow-up question..."
**Skip Conditions:** If context is awkward or user has already answered, skip
```

**示例**:
```
Q3.1 [MUST-ASK] Question: "Tell me about your experience with [new feature]."

**Follow-up Strategy:**
[If user describes usage] "Can you walk me through a specific recent example?"
[If user mentions any friction] "Tell me more about that - what happened?"
**Skip Conditions:** If user has already provided detailed examples, skip follow-ups
```

#### B. 即兴追问（用于一般问题）

**使用条件**:
- 问题不是核心研究目标的关键部分
- 追问可以根据用户回答灵活调整
- 不需要特定维度的深挖

**标记方式**:
```
Q2.3 [Interviewer notes: [Rely on impromptu follow-ups based on user response]]
Question: "What else happens in this process?"
```

**优势**:
- 避免过度脚本化
- 访谈更自然、更像真实对话
- 充分利用 Retell AI 的即兴追问能力

#### C. 标准即兴追问指令

每个 Session 都包含标准指导：

```
**Impromptu Follow-up Guidance**:
If the user shares any new information relevant to our research goals,
conduct 1-2 follow-up questions to understand deeply (why/what/how/impact).
If irrelevant, briefly acknowledge and continue. For questions with set
follow-ups, skip if user has already answered in main response. When
acknowledging responses, vary your expressions: 'okay,' 'I see,'
'understood,' 'that makes sense,' 'got it,' 'right,' etc.
```

### 4. 本地化内容清理 🧹

**变更**:
- ❌ 移除详细的文化适配指令
- ❌ 移除 "Localization Reminders" 章节
- ✅ 简化语言配置（仅保留基本语言要求）
- ✅ 添加说明：文化适配在独立步骤中处理

**原因**:
- 本地化功能已拆分到 `backend/src/lib/prompts/localize-outline.ts`
- 大纲生成聚焦内容质量，本地化聚焦文化适配
- 职责分离，提升各自质量

### 5. 市场调研特定优化

#### 痛点发现（而非假设）

**旧方法**（假设痛点存在）:
```
❌ "What frustrates you the most when dealing with [scenario]?"
```

**新方法**（让痛点自然涌现）:
```
✅ "Tell me about your current process for [scenario]."
→ [If user mentions friction] "Tell me more about that - what happened?"
```

#### 理想解决方案探索

**旧方法**（直接问功能需求）:
```
❌ "What features would you like to see?"
```

**新方法**（探索理想状态）:
```
✅ "If you could wave a magic wand, how would this process work ideally?"
→ "What's most important in that ideal scenario?"
```

### 6. 产品调研特定优化

#### 功能发现（而非假设）

**旧方法**（假设用户已发现功能）:
```
❌ "How useful is [Feature]?"
```

**新方法**（探索实际使用）:
```
✅ "Tell me about your experience using [Product]."
→ [If user mentions feature] "How did you first come across this feature?"
→ "What's your understanding of what it does?"
→ "How often do you use it? In what situations?"
```

#### 竞品对比策略

**旧方法**（直接问竞品）:
```
❌ "Which competitors have you used?"
```

**新方法**（自然引出对比）:
```
✅ "Before using [Product], what tools or methods did you use for [task]?"
→ [If they mention alternatives] "What's different about your experience
   with [Product] compared to [Alternative]?"
```

### 优化效果

**质量提升**:
- ✅ 生成的问题更加开放、无偏见
- ✅ 减少引导性问题导致的数据偏差
- ✅ 访谈流程更自然、更像真实对话

**目标达成**:
- ✅ 关键研究目标的必问项不会遗漏
- ✅ 核心问题得到深度挖掘
- ✅ 一般问题保持灵活性

**用户体验**:
- ✅ 参与者感觉更舒适，愿意分享真实体验
- ✅ 面试官有清晰的指导，知道何时深挖、何时灵活
- ✅ 访谈节奏更自然，不会感觉机械

### 影响的文件

- `backend/src/lib/prompts/generate-market-research-sessions.ts` (248 lines → 279 lines)
- `backend/src/lib/prompts/generate-product-research-sessions.ts` (241 lines → 274 lines)

---

## 🎯 追问生成逻辑优化 (v1.3.8)

### 优化目标

进一步优化追问生成逻辑，使访谈执行更灵活、更自然：

1. **移除即兴追问相关内容**（系统自动处理）
2. **追问改为方向性指示**（而非固定句子）
3. **Session 案例抽象化**（避免过度具象）
4. **删除过拟合规则**（如 AI collection）

### 核心变更

#### 1. 移除即兴追问指导 🧹

**删除内容**:
- ❌ "Standard Impromptu Instructions" 章节
- ❌ "Impromptu Follow-up Guidance" 内容

**原因**: 访谈执行系统（Retell AI）已内置即兴追问能力，在大纲生成阶段重复指导是冗余的。

#### 2. 追问改为方向性指示 🎯

**旧格式**（固定句子）:
```
[If user mentions friction] "Can you tell me more? What happened?"
```

**新格式**（方向性指示）:
```
[If user mentions friction] → Probe for: specific examples, impact, solutions
```

**优势**: Agent 可根据语境灵活措辞，访谈更自然。

#### 3. Session 案例抽象化 📋

**旧格式**（过于具象）:
```
- Session 1: Ice-breaking + Current behavior
- Session 2: Pain points deep dive
- Session 5: AI/Technology expectations
```

**新格式**（抽象原则）:
```
Session Flow: Intro → Open Exploration → Targeted Collection → Closure
Session Themes: Early (context) → Middle (deep dive) → Later (synthesis)
```

#### 4. 删除过拟合规则 🧹

**删除**: "AI/Technology Expectations" 章节（逆向工程时过拟合的特定案例）

### 优化效果

- ✅ 访谈更灵活、更自然
- ✅ 大纲更适配具体研究目标
- ✅ 职责分离：大纲聚焦关键问题，执行聚焦灵活措辞

### 影响的文件

- `backend/src/lib/prompts/generate-market-research-sessions.ts` (279 lines → 272 lines)
- `backend/src/lib/prompts/generate-product-research-sessions.ts` (279 lines → 272 lines)

---

## 📚 相关文档

- [大纲本地化功能](./04-大纲本地化功能.md)
- [技术架构](./01-技术架构.md)
- [数据库设计](./02-数据库设计.md)

---

**维护者**: Userology 开发团队
**最后更新**: 2025-10-26

