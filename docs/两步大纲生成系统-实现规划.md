# 两步大纲生成系统 - 完整实现规划

> **版本**: 1.0.0  
> **创建日期**: 2025-10-28  
> **状态**: 规划中

---

## 🎯 目标

将当前的一步大纲生成流程拆分为两步：

1. **Step 1: 生成骨架** - 生成 Session 主题、目标、背景信息
2. **Step 2: 生成完整大纲** - 基于骨架生成具体问题和追问策略

**核心改进**：
- ✅ 解决 Prompt 信息过载问题（350 行 → 拆分为两个 150 行的 Prompt）
- ✅ 生成更具体、可操作的背景信息（而非抽象描述）
- ✅ 为关键问题生成追问策略
- ✅ 允许用户在骨架阶段 review 和编辑

---

## 📊 数据库架构设计

### 新增字段

```sql
-- 在 interview 表中添加字段
ALTER TABLE interview 
ADD COLUMN IF NOT EXISTS outline_skeleton JSONB,
ADD COLUMN IF NOT EXISTS outline_generation_status VARCHAR(50) DEFAULT 'draft',
ADD COLUMN IF NOT EXISTS skeleton_generated_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS skeleton_reviewed_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS draft_generated_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS localized_at TIMESTAMP;

-- 添加注释
COMMENT ON COLUMN interview.outline_skeleton IS '大纲骨架（Session 主题、目标、背景信息）';
COMMENT ON COLUMN interview.outline_generation_status IS '大纲生成状态：draft, skeleton_generated, skeleton_reviewed, draft_generated, localized';
COMMENT ON COLUMN interview.skeleton_generated_at IS '骨架生成时间';
COMMENT ON COLUMN interview.skeleton_reviewed_at IS '骨架审核时间';
COMMENT ON COLUMN interview.draft_generated_at IS '初稿大纲生成时间';
COMMENT ON COLUMN interview.localized_at IS '本地化完成时间';
```

### 数据结构

```typescript
// OutlineSkeleton 结构
interface OutlineSkeleton {
  sessions: SkeletonSession[];
  metadata: {
    total_sessions: number;
    estimated_duration_minutes: number;
    draft_language: string;
  };
}

interface SkeletonSession {
  session_number: number;
  session_title: string;
  session_goal: string;
  background_information: string[];
}

// 生成状态枚举
type OutlineGenerationStatus = 
  | 'draft'                // 初始状态
  | 'skeleton_generated'   // 骨架已生成
  | 'skeleton_reviewed'    // 骨架已审核
  | 'draft_generated'      // 初稿大纲已生成
  | 'localized';           // 已本地化
```

---

## 🔄 完整数据流程

```
用户填写 Study Objective 和 Context
  ↓
点击"生成大纲骨架"
  ↓
调用 POST /api/outlines/skeleton
  ↓
保存骨架到 interview.outline_skeleton
  ↓
在同一页面显示骨架（Session 卡片）
  ↓
用户 Review 和编辑骨架
  ↓
调用 PATCH /api/outlines/:id/skeleton（保存编辑）
  ↓
用户点击"确认并生成完整大纲"
  ↓
调用 POST /api/outlines/:id/confirm-skeleton
  ↓
调用 POST /api/outlines/:id/full-outline
  ↓
保存完整大纲到 interview.draft_outline
  ↓
跳转到编辑大纲页面
```

---

## 📝 Prompt 设计

### Step 1: 生成骨架 Prompt

**文件**: `backend/src/lib/prompts/generate-outline-skeleton.ts`

**核心要求**：
1. 生成 Session 主题和目标
2. 生成**具体、可操作**的背景信息（带数据、事实、洞察）
3. 识别必问项（内部使用，不显示给用户）

**输出格式**：
```json
{
  "sessions": [
    {
      "session_number": 1,
      "session_title": "破冰与背景建立",
      "session_goal": "建立访谈关系并收集用户英语学习背景...",
      "background_information": [
        "法国主要英语考试包括TOEIC（职场认可度最高）、TOEFL/IELTS（留学必备）",
        "法国学生英语实际应用能力普遍偏弱，约50%初中毕业生未达A2等级",
        "英语能力存在显著地域差异，巴黎地区42%具备沟通能力，乡村地区仅18%"
      ]
    }
  ]
}
```

### Step 2: 生成完整大纲 Prompt

**文件**: `backend/src/lib/prompts/generate-full-outline-from-skeleton.ts`

**核心要求**：
1. 基于骨架生成 4-6 个具体问题（使用漏斗方法）
2. 为关键问题生成追问策略
3. 生成 Session 1 Opening（6 个元素）
4. 生成 Session 之间的过渡

**输入**：
- 用户审核后的骨架
- 原始的 Study Objective 和 Context

**输出格式**：
```json
{
  "questions": [
    "### **Session 1: 破冰与背景建立**\n\n**Session Goal:** ...\n\n**Section Notes:**\n- **Interviewer Instructions:** ...\n- **Background Information:** [使用骨架中的背景信息]\n\n**Interview Outline:**\n\n**[Opening]**\n[6 个元素的完整 Opening]\n\nQ1.1 ...\nQ1.2 ...\n...\n\n**[Transition to Next Session]**\n..."
  ],
  "description": "50-word description"
}
```

---

## 🛠️ Backend API 实现

### 1. POST /api/outlines/skeleton

**文件**: `backend/src/controllers/questions.controller.ts`

**功能**: 生成大纲骨架

**请求**:
```typescript
{
  interview_id: string;
  session_count: number;
  duration_minutes: number;
  draft_language: string;
}
```

**响应**:
```typescript
{
  skeleton: OutlineSkeleton;
  status: 'skeleton_generated';
}
```

**实现逻辑**:
```typescript
export const generateOutlineSkeleton = async (req: Request, res: Response) => {
  const { interview_id, session_count, duration_minutes, draft_language } = req.body;
  
  // 1. 获取 interview 的 objective 和 context
  const interview = await InterviewService.getInterviewById(interview_id);
  
  // 2. 调用 Step 1 Prompt 生成骨架
  const skeleton = await callOpenAI({
    prompt: generateSkeletonPrompt({
      objective: interview.objective,
      context: interview.context,
      session_count,
      duration_minutes,
      language: draft_language
    })
  });
  
  // 3. 保存骨架到数据库
  await InterviewService.updateInterview({
    outline_skeleton: skeleton,
    outline_generation_status: 'skeleton_generated',
    skeleton_generated_at: new Date(),
    outline_debug_language: draft_language
  }, interview_id);
  
  res.json({ skeleton, status: 'skeleton_generated' });
};
```

### 2. PATCH /api/outlines/:id/skeleton

**功能**: 更新骨架（用户编辑后）

**请求**:
```typescript
{
  skeleton: OutlineSkeleton;
}
```

### 3. POST /api/outlines/:id/confirm-skeleton

**功能**: 确认骨架（标记为已审核）

**实现**:
```typescript
await InterviewService.updateInterview({
  outline_generation_status: 'skeleton_reviewed',
  skeleton_reviewed_at: new Date()
}, interview_id);
```

### 4. POST /api/outlines/:id/full-outline

**功能**: 基于骨架生成完整大纲

**实现逻辑**:
```typescript
export const generateFullOutlineFromSkeleton = async (req: Request, res: Response) => {
  const { id } = req.params;
  
  // 1. 获取骨架和 interview 信息
  const interview = await InterviewService.getInterviewById(id);
  
  if (interview.outline_generation_status !== 'skeleton_reviewed') {
    throw new Error('Skeleton must be reviewed before generating full outline');
  }
  
  // 2. 调用 Step 2 Prompt 生成完整大纲
  const fullOutline = await callOpenAI({
    prompt: generateFullOutlinePrompt({
      skeleton: interview.outline_skeleton,
      objective: interview.objective,
      context: interview.context
    })
  });
  
  // 3. 保存完整大纲
  await InterviewService.updateInterview({
    draft_outline: fullOutline.questions,
    description: fullOutline.description,
    outline_generation_status: 'draft_generated',
    draft_generated_at: new Date()
  }, id);
  
  res.json({ draft_outline: fullOutline.questions, status: 'draft_generated' });
};
```

---

## 🎨 Frontend UI 重构

### 页面流程变化

**旧流程**:
```
生成大纲页面 (outline/page.tsx)
  ↓ 点击"生成大纲"
  ↓ 直接生成完整大纲
  ↓ 跳转到编辑大纲页面 (edit-outline/page.tsx)
```

**新流程**:
```
生成大纲页面 (outline/page.tsx)
  ↓ 点击"生成大纲骨架"
  ↓ 在同一页面显示骨架（Session 卡片）
  ↓ 用户 Review 和编辑
  ↓ 点击"确认并生成完整大纲"
  ↓ 生成完整大纲
  ↓ 跳转到编辑大纲页面 (edit-outline/page.tsx)
```

### 组件设计

#### 1. SessionCard 组件

**文件**: `frontend/src/components/dashboard/interview/create-popup/SessionCard.tsx`

**功能**: 显示和编辑单个 Session 的骨架

**Props**:
```typescript
interface SessionCardProps {
  session: SkeletonSession;
  onEdit: (updates: Partial<SkeletonSession>) => void;
  onDelete: () => void;
}
```

**UI 结构**:
```tsx
<div className="border rounded-lg p-6 bg-white shadow-sm">
  {/* Session 编号和标题 */}
  <div className="flex items-center justify-between mb-4">
    <div className="flex items-center gap-3">
      <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center">
        {session.session_number}
      </div>
      <input 
        value={session.session_title}
        onChange={(e) => onEdit({ session_title: e.target.value })}
        className="text-lg font-semibold"
      />
    </div>
    <button onClick={onDelete}>删除</button>
  </div>
  
  {/* Session 目标 */}
  <div className="mb-4">
    <label className="text-sm font-medium text-gray-700">🎯 Session 目标</label>
    <textarea 
      value={session.session_goal}
      onChange={(e) => onEdit({ session_goal: e.target.value })}
      className="w-full mt-2"
    />
  </div>
  
  {/* 背景信息 */}
  <div>
    <div className="flex items-center justify-between mb-2">
      <label className="text-sm font-medium text-gray-700">
        📚 背景信息 ({session.background_information.length} 条)
      </label>
      <button onClick={toggleExpand}>
        {isExpanded ? '收起' : '展开编辑'}
      </button>
    </div>
    
    {isExpanded && (
      <div className="space-y-2">
        {session.background_information.map((info, index) => (
          <div key={index} className="flex gap-2">
            <input 
              value={info}
              onChange={(e) => handleEditBackground(index, e.target.value)}
              className="flex-1"
            />
            <button onClick={() => handleDeleteBackground(index)}>删除</button>
          </div>
        ))}
        <button onClick={handleAddBackground}>+ 添加背景</button>
      </div>
    )}
  </div>
</div>
```

---

## 📱 前端状态管理

### Zustand Store 扩展

**文件**: `frontend/src/store/interview-store.ts`

**新增状态**:
```typescript
interface InterviewStore {
  // ... 现有字段

  // 骨架相关
  outlineSkeleton: OutlineSkeleton | null;
  setOutlineSkeleton: (skeleton: OutlineSkeleton | null) => void;
  outlineGenerationStatus: OutlineGenerationStatus;
  setOutlineGenerationStatus: (status: OutlineGenerationStatus) => void;
}
```

---

## 🎨 详细 UI 流程设计

### 生成大纲页面 (outline/page.tsx)

**当前状态**: 用户填写完 Study Objective 后，点击"生成大纲"直接生成完整大纲并跳转

**新流程**:

#### 阶段 1: 填写基本信息
```
┌─────────────────────────────────────────────────────────────┐
│  生成访谈大纲                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  Session 数量: [6]                                            │
│  访谈时长: [45] 分钟                                          │
│  初稿语言: [中文 ▼]                                           │
│                                                               │
│  [生成大纲骨架]                                               │
└─────────────────────────────────────────────────────────────┘
```

#### 阶段 2: 显示骨架（点击"生成大纲骨架"后）
```
┌─────────────────────────────────────────────────────────────┐
│  生成访谈大纲                                    [重新生成骨架] │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ✅ 骨架已生成 - 请 Review 并编辑                             │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  ① Session 1: 破冰与背景建立              [编辑] [删除] │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │  🎯 Session 目标:                                       │ │
│  │  建立访谈关系并收集用户英语学习背景...                 │ │
│  │                                                         │ │
│  │  📚 背景信息 (4 条) ▼                    [展开编辑]     │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ • 法国主要英语考试包括TOEIC...                   │ │ │
│  │  │ • 法国学生英语实际应用能力普遍偏弱...            │ │ │
│  │  │ • 英语能力存在显著地域差异...                    │ │ │
│  │  │ • 用户偏好严肃专业的学习工具...   [+ 添加背景]  │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  ② Session 2: 深入探索学习痛点            [编辑] [删除] │ │
│  │  ...                                                    │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                               │
│  [+ 添加新 Session]                                           │
│                                                               │
│  [上一步]                    [确认并生成完整大纲]             │
└─────────────────────────────────────────────────────────────┘
```

#### 阶段 3: 生成完整大纲（点击"确认并生成完整大纲"后）
```
显示 Loading 状态 → 生成完整大纲 → 跳转到编辑大纲页面
```

### 关键交互逻辑

**1. 生成骨架按钮**
```typescript
const handleGenerateSkeleton = async () => {
  setIsGenerating(true);

  try {
    const response = await apiClient.post('/api/outlines/skeleton', {
      interview_id: interviewId,
      session_count: numQuestions,
      duration_minutes: duration,
      draft_language: localOutlineDebugLanguage
    });

    setOutlineSkeleton(response.data.skeleton);
    setOutlineGenerationStatus('skeleton_generated');
    toast.success("骨架生成成功！请 Review 并编辑");
  } catch (error) {
    toast.error("生成骨架失败");
  } finally {
    setIsGenerating(false);
  }
};
```

**2. 编辑骨架**
```typescript
const handleEditSession = async (sessionIndex: number, updates: Partial<SkeletonSession>) => {
  const updatedSkeleton = {
    ...outlineSkeleton,
    sessions: outlineSkeleton.sessions.map((s, i) =>
      i === sessionIndex ? { ...s, ...updates } : s
    )
  };

  setOutlineSkeleton(updatedSkeleton);

  // 自动保存到后端
  await apiClient.patch(`/api/outlines/${interviewId}/skeleton`, {
    skeleton: updatedSkeleton
  });
};
```

**3. 确认并生成完整大纲**
```typescript
const handleConfirmAndGenerate = async () => {
  setIsGenerating(true);

  try {
    // 1. 确认骨架
    await apiClient.post(`/api/outlines/${interviewId}/confirm-skeleton`);

    // 2. 生成完整大纲
    const response = await apiClient.post(`/api/outlines/${interviewId}/full-outline`);

    setDraftQuestions(response.data.draft_outline);
    setOutlineGenerationStatus('draft_generated');

    // 3. 跳转到编辑大纲页面
    router.push('/dashboard/create-interview/edit-outline');
  } catch (error) {
    toast.error("生成完整大纲失败");
  } finally {
    setIsGenerating(false);
  }
};
```

---

## 🔄 向后兼容性

### 数据迁移

```sql
-- 为现有数据设置默认状态
UPDATE interview 
SET outline_generation_status = 'draft_generated',
    draft_generated_at = created_at
WHERE draft_outline IS NOT NULL 
  AND outline_generation_status IS NULL;
```

### 前端兼容逻辑

```typescript
// 检查是否使用新流程
const useNewFlow = interview.outline_skeleton !== null;

if (useNewFlow) {
  // 使用两步生成流程
} else {
  // 使用旧流程（直接生成完整大纲）
}
```

---

## 📋 实施计划

### Phase 1: 数据库和类型定义
- [ ] 创建迁移脚本
- [ ] 更新 TypeScript 类型
- [ ] 测试向后兼容性

### Phase 2: Backend Prompts
- [ ] 创建 Step 1 Prompt（生成骨架）
- [ ] 创建 Step 2 Prompt（生成完整大纲）
- [ ] 测试 Prompt 质量

### Phase 3: Backend API
- [ ] 实现 4 个新 Endpoint
- [ ] 测试 API 功能

### Phase 4: Frontend UI
- [ ] 创建 SessionCard 组件
- [ ] 修改生成大纲页面
- [ ] 实现骨架编辑逻辑
- [ ] 测试完整流程

### Phase 5: 测试和优化
- [ ] 端到端测试
- [ ] 性能优化
- [ ] 用户体验优化

---

**维护者**: Userology 开发团队  
**最后更新**: 2025-10-28

