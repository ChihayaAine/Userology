# Userology 技术架构

> **版本**: 1.4.5
> **最后更新**: 2025-10-31

---

## 📋 技术栈概览

### 前端技术栈

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **框架** | Next.js | 14.2.4 | React 应用框架 |
| **语言** | TypeScript | 5.x | 类型安全 |
| **UI 库** | Radix UI | - | 无障碍组件库 |
| | Shadcn/ui | - | UI 组件集合 |
| | NextUI | 2.4.6 | React UI 组件 |
| | Tailwind CSS | 3.3.0 | CSS 框架 |
| **状态管理** | React Context | - | 全局状态 |
| | TanStack Query | 5.17.15 | 服务端状态 |
| **认证** | Clerk | 5.1.5 | 用户认证 |
| **HTTP 客户端** | Axios | 1.6.7 | API 请求 |
| **表单** | React Hook Form | 7.49.0 | 表单管理 |
| | Zod | 3.22.4 | 表单验证 |
| **其他** | Framer Motion | 11.3.21 | 动画 |
| | Lucide React | 0.294.0 | 图标 |
| | Sonner | 1.4.41 | Toast 通知 |

**端口**: 8089

---

### 后端技术栈

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **框架** | Express.js | 4.18.2 | Web 框架 |
| **语言** | TypeScript | 5.x | 类型安全 |
| **数据库** | Supabase | 2.48.1 | PostgreSQL 云服务 |
| **认证** | Clerk | - | 服务端验证 |
| **AI 服务** | OpenAI | 4.6.0 | GPT-4o API |
| | Retell SDK | 4.50.0 | 语音对话 |
| **工具库** | Axios | 1.6.7 | HTTP 请求 |
| | Nanoid | 5.0.4 | ID 生成 |
| | UUID | 10.0.0 | UUID 生成 |
| | Zod | 3.22.4 | 数据验证 |
| **中间件** | CORS | 2.8.5 | 跨域支持 |
| | Helmet | 7.1.0 | 安全头 |
| | Morgan | 1.10.0 | 日志 |

**端口**: 8090

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户浏览器 (Browser)                      │
│                  https://userology.xin                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  前端 (Next.js - Port 8089)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 访谈创建界面 │  │ 访谈执行界面 │  │ 数据分析界面 │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────────────────────────────────────────┐      │
│  │ React Context + TanStack Query (状态管理)        │      │
│  └──────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓ Axios HTTP
┌─────────────────────────────────────────────────────────────┐
│                 后端 API (Express - Port 8090)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 访谈管理 API │  │ 大纲生成 API │  │ 分析 API     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Controllers  │  │ Services     │  │ Lib/Prompts  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   Supabase   │  │  OpenAI API  │  │  Retell AI   │
│  (PostgreSQL)│  │  (GPT-4o)    │  │  (语音交互)  │
│              │  │              │  │              │
│ - interview  │  │ - 问题生成   │  │ - 语音识别   │
│ - response   │  │ - 大纲本地化 │  │ - 语音合成   │
│ - analytics  │  │ - 访谈分析   │  │ - 实时对话   │
└──────────────┘  └──────────────┘  └──────────────┘
```

---

## 📂 项目结构

### 前端结构

```
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── dashboard/          # 仪表板页面
│   │   ├── call/[interviewId]/ # 访谈执行页面
│   │   └── layout.tsx          # 根布局
│   ├── components/             # React 组件
│   │   ├── dashboard/          # 仪表板组件
│   │   │   ├── interview/      # 访谈相关组件
│   │   │   │   ├── create-popup/  # 创建访谈弹窗
│   │   │   │   ├── editInterview.tsx  # 编辑界面
│   │   │   │   └── interviewCard.tsx  # 访谈卡片
│   │   │   └── analytics/      # 分析组件
│   │   └── ui/                 # 通用 UI 组件
│   ├── contexts/               # React Context
│   │   └── interviews.context.tsx
│   ├── services/               # API 服务
│   │   ├── api.ts              # Axios 配置
│   │   └── interviews.service.ts
│   └── lib/                    # 工具函数
│       └── utils.ts
├── public/                     # 静态资源
│   └── interviewers/           # 面试官头像
├── next.config.js              # Next.js 配置
└── package.json
```

### 后端结构

```
backend/
├── src/
│   ├── controllers/            # 控制器层
│   │   ├── interviews.controller.ts
│   │   ├── questions.controller.ts
│   │   ├── analytics.controller.ts
│   │   └── call.controller.ts
│   ├── services/               # 服务层
│   │   ├── interview.service.ts
│   │   ├── response.service.ts
│   │   └── analytics.service.ts
│   ├── lib/                    # 工具库
│   │   └── prompts/            # AI Prompts
│   │       ├── localize-outline.ts
│   │       └── generate-questions.ts
│   ├── config/                 # 配置
│   │   ├── database.ts         # Supabase 配置
│   │   ├── openai.ts           # OpenAI 配置
│   │   └── retell.ts           # Retell 配置
│   ├── routes/                 # 路由
│   │   ├── interviews.routes.ts
│   │   ├── questions.routes.ts
│   │   └── call.routes.ts
│   ├── types/                  # TypeScript 类型
│   │   └── index.ts
│   └── index.ts                # 入口文件
├── migrations/                 # 数据库迁移
└── package.json
```

---

## 🔌 API 架构

### API 路由设计

| 路由前缀 | 功能 | 主要端点 |
|---------|------|---------|
| `/api/interviews` | 访谈管理 | GET, POST, PUT, DELETE |
| `/api/interviewers` | 面试官管理 | GET |
| `/api/responses` | 访谈响应 | GET, POST |
| `/api/analytics` | 数据分析 | GET, POST |
| `/api/call` | 通话管理 | GET, POST |
| `/api/questions` | 问题生成 | POST |
| `/api` | 其他 | 客户端、反馈等 |

### 核心 API 端点

#### 访谈管理

```typescript
// 获取所有访谈
GET /api/interviews

// 创建访谈
POST /api/interviews

// 更新访谈
PUT /api/interviews/:id

// 删除访谈
DELETE /api/interviews/:id
```

#### 大纲生成

**两步大纲生成系统** (v1.4.0+):

```typescript
// Step 1: 生成骨架
POST /api/outlines/skeleton
Body: {
  name, objective, context, session_count,
  duration_minutes, draft_language, researchType,
  manualSessions
}

// Step 2: 更新骨架（使用通用 API）
PUT /api/interviews/:id
Body: {
  outline_skeleton: OutlineSkeleton
}

// Step 3: 生成完整大纲
POST /api/outlines/:id/full-outline

// 本地化大纲
POST /api/questions/localize-outline
Body: {
  draftOutline, targetLanguage,
  researchObjective, studyName, description
}
```

**传统模式** (向后兼容):

```typescript
// 生成访谈问题 (Lisa/Bob)
POST /api/generate-interview-questions
Body: {
  name, objective, number, context,
  researchType, interviewerId
}

// 生成访谈 sessions (David)
POST /api/generate-interview-sessions
Body: {
  name, objective, number, context,
  researchType, interviewerId
}
```

#### 访谈执行

```typescript
// 注册通话
POST /api/call/register
Body: { interviewId, userId }

// 获取通话数据
GET /api/call/:callId
POST /api/get-call
Body: { id: callId }
```

---

## 🔐 认证架构

### Clerk 认证流程

```
┌─────────────┐
│   用户登录   │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────┐
│  Clerk 认证 (前端)          │
│  - 获取 JWT Token           │
│  - 存储在 Cookie/LocalStorage│
└──────┬──────────────────────┘
       │
       ↓ 携带 Token
┌─────────────────────────────┐
│  后端 API 请求              │
│  - Header: Authorization    │
└──────┬──────────────────────┘
       │
       ↓
┌─────────────────────────────┐
│  Clerk 验证 (后端)          │
│  - 验证 Token 有效性        │
│  - 提取用户信息             │
└──────┬──────────────────────┘
       │
       ↓
┌─────────────────────────────┐
│  业务逻辑处理               │
└─────────────────────────────┘
```

---

## 🗄️ 数据库架构

### Supabase 配置

```typescript
// 前端配置
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);

// 后端配置
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);
```

详见: [数据库设计文档](./02-数据库设计.md)

---

## 🤖 AI 服务架构

### OpenAI 配置

```typescript
const openaiClient = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  baseURL: "https://api.tu-zi.com/v1",  // 代理地址
  maxRetries: 5,
});
```

### Retell AI 配置

```typescript
const retellClient = new Retell({
  apiKey: process.env.RETELL_API_KEY,
});
```

---

## 🚀 部署架构

### 开发环境

```bash
# 前端
cd frontend
npm run dev  # Port 8089

# 后端
cd backend
npm run dev  # Port 8090
```

### 生产环境

- **前端**: Vercel 部署
  - 域名: https://userology.xin
  - 自动部署（Git push）
  
- **后端**: 云服务器部署
  - API: https://userology.xin/api
  - PM2 进程管理
  
- **数据库**: Supabase 云服务
  - 自动备份
  - 高可用性

---

## 📦 依赖管理

### 包管理器

- **前端**: npm/yarn
- **后端**: npm/yarn
- **推荐**: yarn（更快的依赖安装）

### 关键依赖版本

```json
{
  "next": "^14.2.4",
  "react": "^18",
  "express": "^4.18.2",
  "openai": "^4.6.0",
  "retell-sdk": "^4.50.0",
  "@supabase/supabase-js": "^2.48.1",
  "@clerk/nextjs": "5.1.5"
}
```

---

## 🔧 环境变量

### 前端环境变量

```bash
NEXT_PUBLIC_API_URL=http://localhost:8090/api
NEXT_PUBLIC_LIVE_URL=http://localhost:8089
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_key
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_key
CLERK_SECRET_KEY=your_clerk_secret
```

### 后端环境变量

```bash
PORT=8090
NODE_ENV=development
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
OPENAI_API_KEY=your_openai_key
OPENAI_API_BASE=https://api.tu-zi.com/v1
RETELL_API_KEY=your_retell_key
FRONTEND_URL=https://userology.xin
```

---

**维护者**: Userology 开发团队
**最后更新**: 2025-10-31

