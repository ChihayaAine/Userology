# 访谈分析系统

> **版本**: 1.3.5  
> **最后更新**: 2025-10-24

---

## 📖 系统概述

访谈分析系统负责对完成的访谈进行深度分析，提取关键洞察和重要引用。系统采用两阶段分析架构：

1. **基础分析** (Analytics)：问题总结 + 访谈总结
2. **深度总结** (Summary)：关键洞察 + 重要引用

---

## 🏗️ 系统架构

### 两阶段分析流程

```
访谈结束
    ↓
获取 Transcript (Retell API)
    ↓
┌─────────────────────────────────┐
│  阶段 1: 基础分析 (Analytics)    │
│  - 问题总结 (Question Summaries) │
│  - 访谈总结 (Call Summary)       │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  阶段 2: 深度总结 (Summary)      │
│  - 关键洞察 (Key Insights)       │
│  - 重要引用 (Important Quotes)   │
└─────────────────────────────────┘
    ↓
保存到数据库
```

### 核心组件

- **Analytics Controller**: 分析流程控制
- **Analytics Service**: 基础分析逻辑
- **Interview Summary Service**: 深度总结逻辑
- **OpenAI GPT-4o**: AI 分析引擎

---

## 🎯 功能模块

### 模块 1: 基础分析 (Analytics)

**目的**: 为每个问题生成总结，并生成整体访谈总结

**API 端点**:
```
POST /api/analytics/generate
```

**请求参数**:
```typescript
{
  callId: string;
  interviewId: string;
  transcript: string;
}
```

**响应格式**:
```typescript
{
  analytics: {
    questionSummaries: Array<{
      question: string;
      summary: string;
    }>;
    callSummary: string;
  }
}
```

**实现文件**:
- Controller: `backend/src/controllers/analytics.controller.ts`
- Service: `backend/src/services/analytics.service.ts`
- Prompt: `backend/src/lib/prompts/analytics.ts`

---

### 模块 2: 深度总结 (Summary)

**目的**: 提取关键洞察和重要引用，支持证据链

**数据结构**:
```typescript
{
  insights_with_evidence: Array<{
    content: string;           // 洞察内容
    category: string;          // 类别
    supporting_quotes: Array<{
      quote: string;           // 引用文本
      timestamp: number;       // 时间戳
      speaker: 'user' | 'agent';
    }>;
  }>;
}
```

**实现文件**:
- Service: `backend/src/services/interview-summary.service.ts`
- Prompt: `backend/src/lib/prompts/generate-interview-summary.ts`

---

## 🔧 实现细节

### Analytics Controller

**文件**: `backend/src/controllers/analytics.controller.ts`

**核心函数**: `generateAnalytics`

```typescript
export const generateAnalytics = async (req: Request, res: Response) => {
  const { callId, interviewId, transcript } = req.body;
  
  // 1. 生成基础分析
  const analyticsResult = await generateInterviewAnalytics({
    callId, interviewId, transcript
  });
  
  // 2. 生成深度总结
  const summaryResult = await InterviewSummaryService.generateInterviewSummary({
    callId, interviewId, transcript
  });
  
  // 3. 返回结果
  return res.status(200).json({
    analytics: analyticsResult.analytics,
    summary: summaryResult.summary
  });
};
```

---

### Analytics Service

**文件**: `backend/src/services/analytics.service.ts`

**核心函数**: `generateInterviewAnalytics`

```typescript
export const generateInterviewAnalytics = async (payload) => {
  const { callId, interviewId, transcript } = payload;
  
  // 1. 获取访谈数据
  const response = await ResponseService.getResponseByCallId(callId);
  const interview = await InterviewService.getInterviewById(interviewId);
  
  // 2. 检查缓存
  if (response.analytics) {
    return { analytics: response.analytics, status: 200 };
  }
  
  // 3. 构建 Prompt
  const questions = interview?.questions || [];
  const studyObjective = interview?.objective || '';
  const language = interview?.language || 'en-US';
  
  const prompt = getInterviewAnalyticsPrompt(
    transcript,
    mainInterviewQuestions,
    studyObjective,
    language
  );
  
  // 4. 调用 OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: "gpt-4o",
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: prompt }
    ],
    response_format: { type: "json_object" }
  });
  
  // 5. 解析并保存
  const analyticsResponse = JSON.parse(content);
  await ResponseService.saveResponse({ analytics: analyticsResponse }, callId);
  
  return { analytics: analyticsResponse, status: 200 };
};
```

---

### Interview Summary Service

**文件**: `backend/src/services/interview-summary.service.ts`

**核心函数**: `generateInterviewSummary`

```typescript
export const generateInterviewSummary = async (payload) => {
  const { callId, interviewId, transcript } = payload;
  
  // 1. 检查缓存
  if (response.insights_with_evidence) {
    return { summary: { insights_with_evidence: response.insights_with_evidence }, status: 200 };
  }
  
  // 2. 构建 Prompt
  const studyObjective = interview.objective || '';
  const language = interview.language || 'en-US';
  const questionTexts = questions.map(q => q.question);
  
  const prompt = getInterviewSummaryPrompt(
    transcript,
    studyObjective,
    questionTexts,
    language
  );
  
  // 3. 调用 OpenAI
  const completion = await openaiClient.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: INTERVIEW_SUMMARY_SYSTEM_PROMPT },
      { role: 'user', content: prompt }
    ],
    response_format: { type: 'json_object' },
    temperature: 0.7
  });
  
  // 4. 解析并保存
  const summaryData = JSON.parse(content);
  await ResponseService.saveResponse({
    insights_with_evidence: summaryData.insights_with_evidence
  }, callId);
  
  return { summary: summaryData, status: 200 };
};
```

---

## 📝 Prompt 工程

### Analytics Prompt

**System Prompt**:
```
You are an expert in analyzing user research interview transcripts. 
Focus on extracting insights that help understand user needs, behaviors, and pain points.
```

**User Prompt 结构**:
```
Analyze the following user research interview transcript:

## Study Objective
${studyObjective}

## Interview Questions
${mainInterviewQuestions}

## Transcript
${transcript}

---

Generate:
1. Question Summaries (for each question)
2. Overall Call Summary

**Language**: ${language}
```

---

### Interview Summary Prompt

**System Prompt**:
```
You are an expert user researcher specializing in extracting actionable insights 
from user interviews. Focus on specific, actionable insights rather than generic observations.
```

**User Prompt 结构**:
```
Analyze this user research interview and extract key insights and important quotes.

## Study Objective
${studyObjective}

## Interview Questions
${questions}

## Interview Transcript
${transcript}

---

Generate:
- KEY INSIGHTS WITH EVIDENCE (3-5 insights)
  - Each insight must have 2-3 supporting quotes
  - Categories: need, pain_point, behavior, preference, mental_model, unexpected

**Language**: ${language}
```

---

## 🌐 多语言支持

### 语言参数

系统根据 `interview.language` 自动调整输出语言：

```typescript
const languageInstruction = language === 'zh-CN'
  ? '\n\n**IMPORTANT: Please write ALL summaries in Chinese (简体中文).**'
  : language === 'ja-JP'
  ? '\n\n**IMPORTANT: Please write ALL summaries in Japanese (日本語).**'
  : '\n\n**IMPORTANT: Please write ALL summaries in English.**';
```

### 引用处理

- **洞察内容**: 使用访谈语言
- **引用文本**: 保持原始语言（用户说的话）

---

## 🔄 数据流

### 完整分析流程

```
1. 访谈结束
   ↓
2. Call Controller 触发分析
   POST /api/call/:callId
   ↓
3. 获取 Transcript (Retell API)
   ↓
4. 调用 Analytics Controller
   POST /api/analytics/generate
   ↓
5. 生成基础分析
   - Question Summaries
   - Call Summary
   ↓
6. 生成深度总结
   - Key Insights
   - Supporting Quotes
   ↓
7. 保存到数据库
   response.analytics
   response.insights_with_evidence
   ↓
8. 返回前端显示
```

---

## 💾 数据存储

### Response 表字段

```sql
-- 基础分析
analytics JSONB

-- 深度总结（新格式）
insights_with_evidence JSONB

-- 旧格式（已废弃）
key_insights JSONB
important_quotes JSONB
```

### 数据迁移

系统支持从旧格式自动迁移到新格式：

```typescript
// 检查旧格式
if (response.key_insights && response.important_quotes) {
  // 转换为新格式
  const insights_with_evidence = mergeOldFormat(
    response.key_insights,
    response.important_quotes
  );
}
```

---

## 🔄 重新生成功能

### API 端点

```
POST /api/analytics/regenerate
```

### 实现逻辑

```typescript
export const regenerateInterviewSummary = async (callId, interviewId, transcript) => {
  // 1. 清除现有总结
  await ResponseService.saveResponse({
    insights_with_evidence: null,
    key_insights: null,
    important_quotes: null
  }, callId);
  
  // 2. 重新生成
  return await generateInterviewSummary({ callId, interviewId, transcript });
};
```

---

## 🎨 前端集成

### 显示分析结果

**文件**: `frontend/src/app/interviews/[interviewId]/page.tsx`

**组件**:
- Question Summaries 卡片
- Call Summary 卡片
- Key Insights 卡片
- Important Quotes 卡片

### 重新生成按钮

```typescript
const handleRegenerate = async () => {
  await apiClient.post('/analytics/regenerate', {
    callId, interviewId, transcript
  });
  // 刷新数据...
};
```

---

## 🚀 性能优化

### 缓存策略

1. **检查现有分析**: 避免重复生成
2. **分阶段生成**: 基础分析 → 深度总结
3. **异步处理**: 不阻塞访谈结束流程

### 错误处理

```typescript
try {
  // 生成分析...
} catch (error) {
  console.error('❌ [Analytics] Error:', error);
  // 基础分析失败不影响深度总结
  // 深度总结失败不影响基础分析
}
```

---

## 📊 质量保证

### 洞察质量标准

1. **具体性**: 避免泛泛而谈
2. **可操作性**: 能指导产品决策
3. **证据支持**: 每个洞察有 2-3 个引用
4. **相关性**: 与研究目标直接相关

### 引用质量标准

1. **准确性**: 逐字引用
2. **完整性**: 包含上下文
3. **时间戳**: 便于回溯
4. **说话人**: 区分用户和 AI

---

## 📚 相关文档

- [跨访谈洞察生成](./07-跨访谈洞察生成.md)
- [数据库设计](./02-数据库设计.md)
- [技术架构](./01-技术架构.md)

---

**维护者**: Userology 开发团队  
**最后更新**: 2025-10-24

