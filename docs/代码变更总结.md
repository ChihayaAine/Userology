# FoloUp 代码变更总结

> 更新时间：2025-01-20  
> 变更范围：Study创建流程优化 + 访谈总结模块  
> 状态：代码完成，待数据库Migration和测试

---

## 📋 变更概览

本次变更包含两大核心功能：

### 1. Study创建流程优化（已完成并测试）
- 添加访谈类型选择（产品调研 vs 需求调研）
- 添加访谈语言本地化（支持10+语言）
- 添加个性化备注功能（Custom Instructions）
- 优化UI提示和示例展示

### 2. 访谈总结模块（代码完成，待Migration）
- 单访谈深度总结：自动提取Key Insights和Important Quotes
- Study级别综合总结：跨访谈分析，生成Executive Summary和可交付成果
- 完全动态的deliverables系统：根据Study Objective自动提取期待产出

**核心价值**：将FoloUp从"访谈记录工具"升级为"用户研究洞察平台"

---

## 🗂️ 主要代码变更

### Part 1: Study创建流程优化

#### 前端修改
**`frontend/src/components/dashboard/interview/create-popup/details.tsx`** (769行)
- 添加访谈类型选择器（产品调研/需求调研）
- 添加语言选择器（支持10+语言）
- 添加Custom Instructions输入框
- 优化Objective和Document的提示信息
- 添加示例展示功能
- 根据访谈类型显示不同的placeholder和示例

**关键功能**：
```typescript
// 访谈类型
const [researchType, setResearchType] = useState<'product' | 'market'>('product');

// 语言选择
const [selectedLanguage, setSelectedLanguage] = useState<LanguageCode>('en-US');

// 个性化备注
const [customInstructions, setCustomInstructions] = useState("");

// 生成问题时传递参数
const data = {
  name, objective, number: numQuestions,
  context: uploadedDocumentContext,
  researchType,      // 新增
  language,          // 新增
  customInstructions // 新增
};
```

#### 后端修改
**`backend/src/lib/prompts/generate-product-research-sessions.ts`** (80行修改)
**`backend/src/lib/prompts/generate-market-research-sessions.ts`** (80行修改)
- 优化prompt，支持语言本地化
- 支持Custom Instructions
- 区分产品调研和需求调研的生成逻辑

---

### Part 2: 访谈总结模块

#### 新增文件

##### 后端核心
1. **AI Prompt系统**
   - `backend/src/lib/prompts/generate-interview-summary.ts` (166行)
   - `backend/src/lib/prompts/generate-study-summary.ts` (316行)

2. **Service层**
   - `backend/src/services/interview-summary.service.ts` (187行)
   - `backend/src/services/study-summary.service.ts` (251行)

3. **数据库Migration**
   - `backend/migrations/001_add_summary_fields.sql` (75行)
   - 添加6个新字段：key_insights, important_quotes, executive_summary等

4. **辅助脚本**
   - `backend/src/scripts/find-and-backfill.ts` (254行)

##### 前端UI
1. **单访谈页面组件**
   - `frontend/src/components/call/KeyInsightsCard.tsx` (113行)
   - `frontend/src/components/call/ImportantQuotesCard.tsx` (95行)
   - `frontend/src/components/ui/badge.tsx` (37行)

2. **Study页面组件**
   - `frontend/src/components/dashboard/interview/StudySummaryCard.tsx` (266行)

##### 类型定义
- `backend/src/types/response.ts` (+21行)
- `backend/src/types/interview.ts` (+28行)
- `frontend/src/types/response.ts` (+21行)
- `frontend/src/types/interview.ts` (+28行)

#### 修改的现有文件

##### 后端
1. `backend/src/controllers/analytics.controller.ts` (+156行)
   - 新增4个API endpoints
   - 集成自动生成interview summary

2. `backend/src/routes/analytics.routes.ts` (+13行)

3. `backend/src/services/analytics.service.ts` (+22行)
   - 优化Question Summary和Call Summary
   - 删除招聘相关评分

4. `backend/src/lib/prompts/analytics.ts` (+80行修改)

##### 前端
1. `frontend/src/components/call/callInfo.tsx` (重构)
   - 删除招聘导向UI
   - 集成KeyInsightsCard和ImportantQuotesCard

2. `frontend/src/components/dashboard/interview/summaryInfo.tsx` (重构)
   - 添加Tabs切换（Overview / Study Insights）
   - 集成StudySummaryCard

3. `frontend/src/components/dashboard/interview/dataTable.tsx` (简化)

4. `frontend/src/app/page.tsx` (+6行)
   - 添加根路径重定向

---

## 📊 数据库Schema变更

### response表（单访谈级别）
```sql
ALTER TABLE response 
ADD COLUMN IF NOT EXISTS key_insights JSONB DEFAULT '[]'::jsonb,
ADD COLUMN IF NOT EXISTS important_quotes JSONB DEFAULT '[]'::jsonb;
```

### interview表（Study级别）
```sql
ALTER TABLE interview 
ADD COLUMN IF NOT EXISTS executive_summary TEXT,
ADD COLUMN IF NOT EXISTS objective_deliverables JSONB DEFAULT '{}'::jsonb,
ADD COLUMN IF NOT EXISTS cross_interview_insights JSONB DEFAULT '[]'::jsonb,
ADD COLUMN IF NOT EXISTS evidence_bank JSONB DEFAULT '[]'::jsonb;
```

**Migration文件**: `backend/migrations/001_add_summary_fields.sql`

---

## 🎯 核心设计原则

### Study创建流程
1. **类型区分**：产品调研 vs 需求调研，生成不同风格的问题
2. **语言本地化**：支持10+语言，自动调整prompt
3. **个性化**：Custom Instructions允许用户添加特殊要求

### 访谈总结模块
1. **不预设Objective类型**：从Study Objective中动态提取deliverables
2. **两层总结系统**：单访谈 + Study级别
3. **自动缓存**：避免重复生成，节省成本
4. **可编辑**：用户可修正AI生成的内容
5. **深度优先**：少而精的洞察（3-5条）

---

## 📁 文件位置索引

### Study创建流程
```
frontend/src/components/dashboard/interview/create-popup/
└── details.tsx                    # 主要修改文件

backend/src/lib/prompts/
├── generate-product-research-sessions.ts
└── generate-market-research-sessions.ts
```

### 访谈总结模块
```
backend/
├── migrations/
│   └── 001_add_summary_fields.sql
├── src/
│   ├── controllers/analytics.controller.ts
│   ├── services/
│   │   ├── interview-summary.service.ts
│   │   └── study-summary.service.ts
│   ├── lib/prompts/
│   │   ├── generate-interview-summary.ts
│   │   └── generate-study-summary.ts
│   └── scripts/
│       └── find-and-backfill.ts

frontend/src/
├── components/
│   ├── call/
│   │   ├── KeyInsightsCard.tsx
│   │   ├── ImportantQuotesCard.tsx
│   │   └── callInfo.tsx
│   └── dashboard/interview/
│       ├── StudySummaryCard.tsx
│       └── summaryInfo.tsx
└── types/
    ├── response.ts
    └── interview.ts
```

---

## 🔍 技术亮点

### Study创建流程
1. **动态placeholder**：根据访谈类型显示不同提示
2. **示例展示**：点击Info图标显示详细示例
3. **语言本地化**：自动更新Retell Agent配置

### 访谈总结模块
1. **两阶段AI生成**：先提取deliverables类型，再生成内容
2. **完全动态的数据结构**：JSONB类型，支持任意结构
3. **从Retell API获取transcript**：实时获取，不依赖数据库
4. **放宽验证规则**：支持短访谈（1-5 insights, 2-10 quotes）
5. **shadcn/ui组件**：现代化UI，保持设计一致性

---

## 📈 代码统计

| 模块 | 新增文件 | 修改文件 | 新增代码 | 删除代码 | 净增加 |
|------|---------|---------|---------|---------|--------|
| Study创建流程 | 0 | 3 | ~300 | ~50 | +250 |
| 访谈总结模块 | 13 | 11 | ~2,900 | ~720 | +2,180 |
| **总计** | **13** | **14** | **~3,200** | **~770** | **+2,430** |

---

## 🚀 下一步

详见 `docs/技术交接_TODO.md`

---

**文档版本**: v1.0  
**最后更新**: 2025-01-20

