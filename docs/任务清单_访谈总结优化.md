# 任务清单：访谈总结功能优化

## 背景
当前访谈总结功能继承自开源招聘软件，逻辑简单且不够个性化。需要参考`素材L - AI总结Prompt.txt`的逻辑，实现针对性的、高质量的访谈总结生成。

## 核心目标
实现个性化的访谈总结，根据用户在创建访谈时填写的Study Objective，有针对性地生成总结报告。例如：
- 用户提到希望提取"3个最普遍的痛点和action plans" → 报告围绕这个展开
- 而不是"啥都cover分析但啥都不精"

## Phase 1: 现状分析 ✅

### 1.1 理解当前总结功能的产品逻辑
- [x] 分析访谈总结的触发时机
- [x] 分析总结生成的数据流
- [x] 分析总结展示的UI组件

**当前逻辑总结**：
1. **触发时机**：用户在访谈详情页点击"Generate Insights"按钮
2. **数据流**：
   - Frontend调用`/generate-insights` API
   - Backend从数据库获取所有访谈responses的`call_summary`
   - 使用简单的prompt生成3条insights（每条≤25字）
   - 存储到interview表的`insights`字段
3. **展示**：在SummaryInfo组件中显示insights列表

**当前问题**：
- Prompt过于简单，只生成3条25字以内的insights
- 没有利用用户填写的Research Objective
- 没有区分产品调研和需求调研
- 没有生成结构化的CSV数据表
- 没有提供决策建议和行动计划

### 1.2 分析当前prompt的局限性
- [x] 查看`backend/src/lib/prompts/generate-insights.ts`
- [x] 对比`素材L - AI总结Prompt.txt`的要求

**当前prompt局限**：
```typescript
// 当前只是简单地要求生成3条insights
"Give 3 insights from the call summaries that highlights user feedback. 
Only output the insights. Do not include user names in the insights.
Make sure each insight is 25 words or less."
```

**素材L的要求**：
- 生成结构化CSV数据表（覆盖必须收集项）
- 生成简洁总结文件（核心决策建议、关键发现、下一步行动）
- 基于四维专家判断框架（战略重要性、领域专业性、市场差异化、用户真实性）
- 根据Research Objective动态调整输出结构

### 1.3 分析数据库schema
- [x] 查看interview表的insights字段类型
- [x] 确认是否需要扩展字段存储更丰富的总结数据

**当前schema**：
- `insights`: JSON类型，当前只存储简单的insights数组
- 可以扩展为更复杂的JSON结构，包含：
  - `summary`: 总结文本（Markdown格式）
  - `csv_data`: 结构化数据表
  - `decision_recommendation`: 决策建议
  - `key_findings`: 关键发现
  - `action_plans`: 行动计划

## Phase 2: 设计新的总结生成逻辑

### 2.1 设计新的prompt结构
- [ ] 创建`generate-research-insights.ts`（替代现有的generate-insights.ts）
- [ ] 实现动态prompt生成逻辑：
  - [ ] 根据`researchType`（product/market）选择不同的分析框架
  - [ ] 提取Research Objective中的必须收集项和理想产出
  - [ ] 生成针对性的分析维度

### 2.2 设计输出格式
- [ ] 定义新的insights数据结构（TypeScript interface）
- [ ] 设计CSV数据表的动态列生成逻辑
- [ ] 设计Markdown总结的模板结构

**建议的数据结构**：
```typescript
interface ResearchInsights {
  // 核心决策建议
  decision_recommendation: {
    recommendation: string; // Go/No-Go或其他决策
    reasoning: string[];
    confidence_level: 'high' | 'medium' | 'low';
  };
  
  // 关键发现（Top 3-5）
  key_findings: Array<{
    title: string;
    user_behavior: string;
    business_value: string;
    action_recommendation: string;
    priority: 'high' | 'medium' | 'low';
  }>;
  
  // 结构化数据表
  structured_data: {
    columns: string[]; // 动态列名
    rows: Array<Record<string, string>>; // 每行数据
    expert_summary_row: Record<string, string>; // 专家汇总行
  };
  
  // 下一步行动建议
  action_plans: Array<{
    action: string;
    rationale: string;
    priority: number;
    estimated_effort: string;
  }>;
  
  // 原始insights（向后兼容）
  insights: string[];
}
```

### 2.3 设计API改进
- [ ] 修改`/generate-insights` endpoint
- [ ] 添加对Research Objective的解析
- [ ] 添加对researchType的支持
- [ ] 实现更智能的call_summary聚合逻辑

## Phase 3: 实现后端逻辑

### 3.1 创建新的prompt模块
- [ ] `backend/src/lib/prompts/generate-research-insights.ts`
- [ ] 实现SYSTEM_PROMPT（专家分析框架）
- [ ] 实现createUserPrompt函数（动态生成）
- [ ] 参考素材L的四维评估框架

### 3.2 修改analytics controller
- [ ] 修改`generateInsights`函数
- [ ] 添加Research Objective解析逻辑
- [ ] 添加researchType判断
- [ ] 实现新的数据结构存储

### 3.3 添加数据验证
- [ ] 验证生成的insights符合预期格式
- [ ] 处理API调用失败的情况
- [ ] 添加日志记录

## Phase 4: 优化前端展示

### 4.1 重构SummaryInfo组件
- [ ] 设计新的总结展示UI
- [ ] 添加决策建议卡片
- [ ] 添加关键发现列表
- [ ] 添加结构化数据表展示
- [ ] 添加行动计划列表

### 4.2 添加导出功能
- [ ] 导出Markdown总结文件
- [ ] 导出CSV数据表
- [ ] 添加复制到剪贴板功能

### 4.3 改善用户体验
- [ ] 添加生成进度提示
- [ ] 添加重新生成功能
- [ ] 添加编辑和保存功能

## Phase 5: 测试和优化

### 5.1 功能测试
- [ ] 测试产品调研类型的总结生成
- [ ] 测试需求调研类型的总结生成
- [ ] 测试不同Research Objective的适配性
- [ ] 测试数据导出功能

### 5.2 质量优化
- [ ] 优化prompt以提高总结质量
- [ ] 调整专家判断框架的权重
- [ ] 优化CSV数据表的列生成逻辑

### 5.3 性能优化
- [ ] 优化API响应时间
- [ ] 添加缓存机制
- [ ] 优化大量访谈数据的处理

## 相关文件

### 后端文件
- `backend/src/controllers/analytics.controller.ts` - 总结生成controller
- `backend/src/lib/prompts/generate-insights.ts` - 当前prompt（需替换）
- `backend/src/services/analytics.service.ts` - 分析服务
- `backend/src/services/interviews.service.ts` - 访谈服务
- `backend/src/services/responses.service.ts` - 响应服务

### 前端文件
- `frontend/src/components/dashboard/interview/summaryInfo.tsx` - 总结展示组件
- `frontend/src/app/interviews/[interviewId]/page.tsx` - 访谈详情页

### 参考文件
- `8.21-9.21双盲_副本/通用AI访谈模板/素材L - AI总结Prompt.txt` - 总结prompt参考

## 注意事项
1. 保持向后兼容：现有的简单insights格式仍需支持
2. 渐进式优化：先实现核心功能，再优化细节
3. 用户体验优先：确保生成速度和质量的平衡
4. 数据安全：确保敏感信息不会泄露到总结中

