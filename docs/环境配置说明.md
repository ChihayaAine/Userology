# 环境配置说明

> **版本**: 1.3.5
> **最后更新**: 2025-10-24

---

## 📋 概述

Userology 项目支持多种部署环境，每种环境需要不同的配置。

**核心原则**：**前端的 `NEXT_PUBLIC_API_URL` 必须指向实际运行的后端地址**

⚠️ **重要**：
- 环境变量在构建时被硬编码到前端代码中
- 修改 `.env` 后必须重启前端才能生效
- 不同环境需要手动配置不同的值
- **没有自动适配**，配置错误会导致 404 或调用错误的后端

---

## 🌍 环境类型

### 1. 本地开发环境（Local Development）

**使用场景**: 在本地 Mac 上开发和测试

**配置文件**: `.env`

**关键配置**:
```bash
NEXT_PUBLIC_LIVE_URL=http://localhost:8089
FRONTEND_URL=http://localhost:8089
NEXT_PUBLIC_API_URL=http://localhost:8090/api
```

**访问地址**:
- 前端: `http://localhost:8089`
- 后端: `http://localhost:8090`

---

### 2. 服务器开发环境（Server Development）

**使用场景**: 在服务器 `47.93.101.73` 上开发和测试

**配置文件**: `.env`

**关键配置**:
```bash
NEXT_PUBLIC_LIVE_URL=http://47.93.101.73:8089
FRONTEND_URL=http://47.93.101.73:8089
NEXT_PUBLIC_API_URL=http://47.93.101.73:8090/api
```

**访问地址**:
- 前端: `http://47.93.101.73:8089`
- 后端: `http://47.93.101.73:8090`

---

### 3. 生产环境（Production）

**使用场景**: 部署到 `userology.xin` 域名

**配置文件**: `.env.production` 或 Vercel 环境变量

**关键配置**:
```bash
NEXT_PUBLIC_LIVE_URL=https://userology.xin
FRONTEND_URL=https://userology.xin
NEXT_PUBLIC_API_URL=https://userology.xin/api
```

**访问地址**:
- 前端: `https://userology.xin`
- 后端: `https://userology.xin/api`

---

## 🔧 环境变量说明

### 前端相关

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `NEXT_PUBLIC_LIVE_URL` | Clerk 认证回调地址 | `http://localhost:8089` |
| `NEXT_PUBLIC_API_URL` | 后端 API 地址 | `http://localhost:8090/api` |
| `FRONTEND_PORT` | 前端端口 | `8089` |

### 后端相关

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `FRONTEND_URL` | CORS 允许的前端地址 | `http://localhost:8089` |
| `BACKEND_PORT` | 后端端口 | `8090` |

### 认证和数据库

| 变量名 | 说明 |
|--------|------|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk 公钥 |
| `CLERK_SECRET_KEY` | Clerk 密钥 |
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase 数据库地址 |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase 匿名密钥 |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase 服务密钥 |

### AI 服务

| 变量名 | 说明 |
|--------|------|
| `OPENAI_API_KEY` | OpenAI API 密钥 |
| `OPENAI_API_BASE` | OpenAI API 基础地址 |
| `RETELL_API_KEY` | Retell AI 密钥 |

---

## 🚀 部署流程

### 本地开发 → 服务器测试

1. **在本地开发**:
   ```bash
   # .env
   NEXT_PUBLIC_API_URL=http://localhost:8090/api
   ```

2. **推送到服务器**:
   ```bash
   git add .
   git commit -m "feat: 添加新功能"
   git push origin feature-branch
   ```

3. **在服务器上拉取代码**:
   ```bash
   cd /path/to/project
   git pull origin feature-branch
   ```

4. **修改服务器的 .env**:
   ```bash
   # .env
   NEXT_PUBLIC_API_URL=http://47.93.101.73:8090/api
   ```

5. **重启服务器**:
   ```bash
   # 重启前端
   cd frontend && npm run dev
   
   # 重启后端
   cd backend && npm run dev
   ```

---

### 服务器测试 → 生产部署

1. **合并到主分支**:
   ```bash
   git checkout master
   git merge feature-branch
   git push origin master
   ```

2. **配置生产环境变量**:
   - 如果使用 Vercel，在 Vercel Dashboard 设置环境变量
   - 如果使用自建服务器，创建 `.env.production` 文件

3. **生产环境配置**:
   ```bash
   # .env.production
   NEXT_PUBLIC_API_URL=https://userology.xin/api
   NEXT_PUBLIC_LIVE_URL=https://userology.xin
   FRONTEND_URL=https://userology.xin
   ```

---

## ⚠️ 常见问题

### 问题 1: 前端调用后端 404

**症状**: 前端显示 `POST /api/xxx 404 (Not Found)`

**原因**: `NEXT_PUBLIC_API_URL` 配置错误

**解决**:
1. 检查 `.env` 文件中的 `NEXT_PUBLIC_API_URL`
2. 确保后端服务器正在运行
3. 重启前端（修改 `.env` 后必须重启）

---

### 问题 2: Clerk 认证失败

**症状**: 登录后跳转到错误页面

**原因**: `NEXT_PUBLIC_LIVE_URL` 与 Clerk Dashboard 配置不一致

**解决**:
1. 检查 `.env` 文件中的 `NEXT_PUBLIC_LIVE_URL`
2. 在 Clerk Dashboard 中添加对应的域名
3. 重启前端

---

### 问题 3: CORS 错误

**症状**: 浏览器控制台显示 CORS 错误

**原因**: 后端 `FRONTEND_URL` 配置错误

**解决**:
1. 检查后端 `.env` 文件中的 `FRONTEND_URL`
2. 确保与前端访问地址一致
3. 重启后端

---

## 📝 最佳实践

### 1. 使用 .env.example 作为模板

```bash
# 复制模板
cp .env.example .env

# 填入实际配置
vim .env
```

### 2. 不要提交 .env 文件到 Git

```bash
# .gitignore 中已包含
.env
.env.local
.env.production
```

### 3. 修改 .env 后必须重启服务

```bash
# 前端
cd frontend && npm run dev

# 后端
cd backend && npm run dev
```

### 4. 使用环境变量验证

在代码中添加日志验证配置：

```typescript
// frontend/src/services/api.ts
console.log('🔗 API Base URL:', API_BASE_URL);
console.log('🔗 Environment API URL:', process.env.NEXT_PUBLIC_API_URL);
```

---

## 🔍 调试技巧

### 检查前端配置

打开浏览器控制台，查找：
```
🔗 API Base URL: http://localhost:8090/api
🔗 Environment API URL: http://localhost:8090/api
```

### 检查后端配置

查看后端启动日志：
```
🚀 Backend server running on port 8090
🔗 Frontend URL: http://localhost:8089
```

### 检查环境变量是否生效

```bash
# 前端
cd frontend && npm run dev

# 查看启动日志中的配置信息
```

---

**维护者**: Userology 开发团队  
**最后更新**: 2025-10-24

