# Userology 数据库设计

> **版本**: 1.1.5  
> **最后更新**: 2025-10-23

---

## 📋 数据库概览

### 数据库类型

- **数据库**: PostgreSQL (通过 Supabase)
- **ORM**: 直接使用 Supabase Client
- **迁移**: SQL 迁移脚本 (`backend/migrations/`)

### 核心表

1. **organization** - 组织/客户信息
2. **user** - 用户信息
3. **interviewer** - 面试官配置
4. **interview** - 访谈/研究配置
5. **response** - 访谈响应记录
6. **feedback** - 用户反馈

---

## 📊 表结构详解

### 1. organization (组织表)

**用途**: 存储客户组织信息和订阅计划

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | TEXT | 组织 ID | PRIMARY KEY |
| name | TEXT | 组织名称 | |
| plan | ENUM | 订阅计划 | 'free', 'pro', 'free_trial_over' |
| allowed_responses_count | INTEGER | 允许的访谈数量 | |
| image_url | TEXT | 组织 Logo | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |

**关系**:
- 一对多: organization → user
- 一对多: organization → interview

---

### 2. user (用户表)

**用途**: 存储用户基本信息

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | TEXT | 用户 ID (Clerk) | PRIMARY KEY |
| email | TEXT | 用户邮箱 | |
| organization_id | TEXT | 所属组织 | FOREIGN KEY → organization |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |

**关系**:
- 多对一: user → organization
- 一对多: user → interview

---

### 3. interviewer (面试官表)

**用途**: 存储 AI 面试官配置

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | SERIAL | 面试官 ID | PRIMARY KEY |
| name | TEXT | 面试官名称 | NOT NULL |
| agent_id | TEXT | Retell AI Agent ID | |
| description | TEXT | 面试官描述 | NOT NULL |
| image | TEXT | 头像 URL | NOT NULL |
| audio | TEXT | 音频样本 URL | |
| empathy | INTEGER | 共情能力 (1-10) | NOT NULL |
| exploration | INTEGER | 探索能力 (1-10) | NOT NULL |
| rapport | INTEGER | 亲和力 (1-10) | NOT NULL |
| speed | INTEGER | 语速 (1-10) | NOT NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |

**预设面试官**:
- **Explorer Lisa**: 探索型面试官（问题列表模式）
- **Empathetic Bob**: 共情型面试官（问题列表模式）
- **Deep Dive David**: 深度访谈面试官（Session 模式）

**关系**:
- 一对多: interviewer → interview

---

### 4. interview (访谈/研究表) ⭐

**用途**: 存储访谈配置和元数据

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | TEXT | 访谈 ID (nanoid) | PRIMARY KEY |
| name | TEXT | 研究名称 | |
| objective | TEXT | 研究目标 | |
| description | TEXT | 参与者看到的描述 | |
| user_id | TEXT | 创建者 ID | FOREIGN KEY → user |
| organization_id | TEXT | 所属组织 | FOREIGN KEY → organization |
| interviewer_id | INTEGER | 面试官 ID | FOREIGN KEY → interviewer |
| questions | JSONB | 问题列表 | |
| question_count | INTEGER | 问题数量 | |
| time_duration | TEXT | 预计时长 | |
| is_active | BOOLEAN | 是否激活 | DEFAULT true |
| is_anonymous | BOOLEAN | 是否匿名 | DEFAULT false |
| is_archived | BOOLEAN | 是否归档 | DEFAULT false |
| url | TEXT | 访谈链接 | |
| readable_slug | TEXT | 可读 URL | |
| theme_color | TEXT | 主题颜色 | |
| logo_url | TEXT | Logo URL | |
| respondents | TEXT[] | 受访者列表 | |
| response_count | INTEGER | 响应数量 | |
| insights | TEXT[] | 洞察列表 (旧) | |
| quotes | JSONB[] | 引用列表 (旧) | |
| executive_summary | TEXT | 研究级总结 | |
| objective_deliverables | JSONB | 目标交付物 | |
| cross_interview_insights | JSONB | 跨访谈洞察 | |
| **draft_outline** | JSONB | **初稿大纲** | v1.1.0+ |
| **localized_outline** | JSONB | **本地化大纲** | v1.1.0+ |
| **outline_debug_language** | TEXT | **调试语言** | v1.1.0+ |
| **outline_interview_language** | TEXT | **访谈语言** | v1.1.0+ |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |

#### questions 字段结构

```typescript
{
  id: string;              // 问题 ID
  question: string;        // 问题内容
  follow_up_count: number; // 追问次数
}[]
```

#### 大纲本地化字段 (v1.1.0+)

| 字段 | 说明 | 示例 |
|------|------|------|
| draft_outline | 初稿大纲（调试语言版本） | 中文问题列表 |
| localized_outline | 本地化大纲（访谈语言版本） | 英文问题列表 |
| outline_debug_language | 调试语言代码 | 'zh-CN', 'en-US' |
| outline_interview_language | 访谈语言代码 | 'en-US', 'ja-JP' |

**使用场景**:
1. 研究员用中文创建和调试大纲 → 存储在 `draft_outline`
2. 一键本地化到英文 → 存储在 `localized_outline`
3. 访谈时使用 `questions` 字段（可选择初稿或本地化版本）

详见: [大纲本地化功能文档](./03-大纲本地化功能.md)

**关系**:
- 多对一: interview → user
- 多对一: interview → organization
- 多对一: interview → interviewer
- 一对多: interview → response

---

### 5. response (访谈响应表)

**用途**: 存储访谈响应和分析结果

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | SERIAL | 响应 ID | PRIMARY KEY |
| interview_id | TEXT | 访谈 ID | FOREIGN KEY → interview |
| name | TEXT | 受访者姓名 | |
| email | TEXT | 受访者邮箱 | |
| call_id | TEXT | Retell 通话 ID | |
| duration | INTEGER | 通话时长（秒） | |
| details | JSONB | 通话详情 | 包含 transcript |
| analytics | JSONB | 访谈分析结果 | |
| is_analysed | BOOLEAN | 是否已分析 | DEFAULT false |
| is_ended | BOOLEAN | 是否已结束 | DEFAULT false |
| is_viewed | BOOLEAN | 是否已查看 | DEFAULT false |
| candidate_status | TEXT | 候选人状态 | 'SELECTED', 'NOT_SELECTED' |
| tab_switch_count | INTEGER | 切换标签次数 | |
| key_insights | JSONB | 关键洞察 (旧) | 向后兼容 |
| important_quotes | JSONB | 重要引用 (旧) | 向后兼容 |
| insights_with_evidence | JSONB | 洞察+证据 (新) | v1.0.5+ |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |

#### analytics 字段结构

```typescript
{
  softSkillSummary: string;
  questionSummaries: Array<{
    question: string;
    summary: string;
  }>;
  mainInterviewQuestions?: string[];
}
```

#### insights_with_evidence 字段结构 (v1.0.5+)

```typescript
{
  id: string;
  content: string;
  category: string;
  evidence: Array<{
    quote: string;
    timestamp: number;
    context: string;
  }>;
}[]
```

**关系**:
- 多对一: response → interview

---

### 6. feedback (反馈表)

**用途**: 存储用户反馈

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | SERIAL | 反馈 ID | PRIMARY KEY |
| interview_id | TEXT | 访谈 ID | FOREIGN KEY → interview |
| email | TEXT | 反馈者邮箱 | |
| feedback | TEXT | 反馈内容 | |
| satisfaction | INTEGER | 满意度 (1-5) | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |

**关系**:
- 多对一: feedback → interview

---

## 🔗 数据库关系图

```
┌─────────────────┐
│  organization   │
│  (组织表)       │
└────────┬────────┘
         │ 1:N
         ├──────────────────┐
         │                  │
         ↓                  ↓
┌─────────────────┐  ┌─────────────────┐
│      user       │  │   interview     │
│    (用户表)     │  │   (访谈表)      │
└────────┬────────┘  └────────┬────────┘
         │ 1:N                │ 1:N
         └────────────────────┤
                              │
                              ↓
                     ┌─────────────────┐
                     │    response     │
                     │   (响应表)      │
                     └─────────────────┘

┌─────────────────┐
│  interviewer    │
│  (面试官表)     │
└────────┬────────┘
         │ 1:N
         ↓
┌─────────────────┐
│   interview     │
│   (访谈表)      │
└─────────────────┘
```

---

## 📝 数据库迁移

### 迁移脚本位置

```
backend/migrations/
├── 001_add_summary_fields.sql
├── 002_add_localization_fields.sql
└── ...
```

### 重要迁移

#### v1.0.5 - 添加洞察证据字段

```sql
ALTER TABLE response 
ADD COLUMN IF NOT EXISTS insights_with_evidence JSONB DEFAULT '[]'::jsonb;
```

#### v1.1.0 - 添加大纲本地化字段

```sql
ALTER TABLE interview 
ADD COLUMN IF NOT EXISTS draft_outline JSONB,
ADD COLUMN IF NOT EXISTS localized_outline JSONB,
ADD COLUMN IF NOT EXISTS outline_debug_language TEXT,
ADD COLUMN IF NOT EXISTS outline_interview_language TEXT;
```

---

## 🔍 常用查询

### 获取访谈及其响应

```sql
SELECT 
  i.*,
  COUNT(r.id) as response_count,
  AVG(r.duration) as avg_duration
FROM interview i
LEFT JOIN response r ON i.id = r.interview_id
WHERE i.user_id = 'user_xxx'
GROUP BY i.id;
```

### 获取已分析的响应

```sql
SELECT * FROM response
WHERE interview_id = 'interview_xxx'
AND is_analysed = true
ORDER BY created_at DESC;
```

---

**维护者**: Userology 开发团队  
**最后更新**: 2025-10-23

