# Userology æ•°æ®åº“è®¾è®¡

> **ç‰ˆæœ¬**: 1.1.5  
> **æœ€åæ›´æ–°**: 2025-10-23

---

## ğŸ“‹ æ•°æ®åº“æ¦‚è§ˆ

### æ•°æ®åº“ç±»å‹

- **æ•°æ®åº“**: PostgreSQL (é€šè¿‡ Supabase)
- **ORM**: ç›´æ¥ä½¿ç”¨ Supabase Client
- **è¿ç§»**: SQL è¿ç§»è„šæœ¬ (`backend/migrations/`)

### æ ¸å¿ƒè¡¨

1. **organization** - ç»„ç»‡/å®¢æˆ·ä¿¡æ¯
2. **user** - ç”¨æˆ·ä¿¡æ¯
3. **interviewer** - é¢è¯•å®˜é…ç½®
4. **interview** - è®¿è°ˆ/ç ”ç©¶é…ç½®
5. **response** - è®¿è°ˆå“åº”è®°å½•
6. **feedback** - ç”¨æˆ·åé¦ˆ

---

## ğŸ“Š è¡¨ç»“æ„è¯¦è§£

### 1. organization (ç»„ç»‡è¡¨)

**ç”¨é€”**: å­˜å‚¨å®¢æˆ·ç»„ç»‡ä¿¡æ¯å’Œè®¢é˜…è®¡åˆ’

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | TEXT | ç»„ç»‡ ID | PRIMARY KEY |
| name | TEXT | ç»„ç»‡åç§° | |
| plan | ENUM | è®¢é˜…è®¡åˆ’ | 'free', 'pro', 'free_trial_over' |
| allowed_responses_count | INTEGER | å…è®¸çš„è®¿è°ˆæ•°é‡ | |
| image_url | TEXT | ç»„ç»‡ Logo | |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT NOW() |

**å…³ç³»**:
- ä¸€å¯¹å¤š: organization â†’ user
- ä¸€å¯¹å¤š: organization â†’ interview

---

### 2. user (ç”¨æˆ·è¡¨)

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | TEXT | ç”¨æˆ· ID (Clerk) | PRIMARY KEY |
| email | TEXT | ç”¨æˆ·é‚®ç®± | |
| organization_id | TEXT | æ‰€å±ç»„ç»‡ | FOREIGN KEY â†’ organization |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT NOW() |

**å…³ç³»**:
- å¤šå¯¹ä¸€: user â†’ organization
- ä¸€å¯¹å¤š: user â†’ interview

---

### 3. interviewer (é¢è¯•å®˜è¡¨)

**ç”¨é€”**: å­˜å‚¨ AI é¢è¯•å®˜é…ç½®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | SERIAL | é¢è¯•å®˜ ID | PRIMARY KEY |
| name | TEXT | é¢è¯•å®˜åç§° | NOT NULL |
| agent_id | TEXT | Retell AI Agent ID | |
| description | TEXT | é¢è¯•å®˜æè¿° | NOT NULL |
| image | TEXT | å¤´åƒ URL | NOT NULL |
| audio | TEXT | éŸ³é¢‘æ ·æœ¬ URL | |
| empathy | INTEGER | å…±æƒ…èƒ½åŠ› (1-10) | NOT NULL |
| exploration | INTEGER | æ¢ç´¢èƒ½åŠ› (1-10) | NOT NULL |
| rapport | INTEGER | äº²å’ŒåŠ› (1-10) | NOT NULL |
| speed | INTEGER | è¯­é€Ÿ (1-10) | NOT NULL |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT NOW() |

**é¢„è®¾é¢è¯•å®˜**:
- **Explorer Lisa**: æ¢ç´¢å‹é¢è¯•å®˜ï¼ˆé—®é¢˜åˆ—è¡¨æ¨¡å¼ï¼‰
- **Empathetic Bob**: å…±æƒ…å‹é¢è¯•å®˜ï¼ˆé—®é¢˜åˆ—è¡¨æ¨¡å¼ï¼‰
- **Deep Dive David**: æ·±åº¦è®¿è°ˆé¢è¯•å®˜ï¼ˆSession æ¨¡å¼ï¼‰

**å…³ç³»**:
- ä¸€å¯¹å¤š: interviewer â†’ interview

---

### 4. interview (è®¿è°ˆ/ç ”ç©¶è¡¨) â­

**ç”¨é€”**: å­˜å‚¨è®¿è°ˆé…ç½®å’Œå…ƒæ•°æ®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | TEXT | è®¿è°ˆ ID (nanoid) | PRIMARY KEY |
| name | TEXT | ç ”ç©¶åç§° | |
| objective | TEXT | ç ”ç©¶ç›®æ ‡ | |
| description | TEXT | å‚ä¸è€…çœ‹åˆ°çš„æè¿° | |
| user_id | TEXT | åˆ›å»ºè€… ID | FOREIGN KEY â†’ user |
| organization_id | TEXT | æ‰€å±ç»„ç»‡ | FOREIGN KEY â†’ organization |
| interviewer_id | INTEGER | é¢è¯•å®˜ ID | FOREIGN KEY â†’ interviewer |
| questions | JSONB | é—®é¢˜åˆ—è¡¨ | |
| question_count | INTEGER | é—®é¢˜æ•°é‡ | |
| time_duration | TEXT | é¢„è®¡æ—¶é•¿ | |
| is_active | BOOLEAN | æ˜¯å¦æ¿€æ´» | DEFAULT true |
| is_anonymous | BOOLEAN | æ˜¯å¦åŒ¿å | DEFAULT false |
| is_archived | BOOLEAN | æ˜¯å¦å½’æ¡£ | DEFAULT false |
| url | TEXT | è®¿è°ˆé“¾æ¥ | |
| readable_slug | TEXT | å¯è¯» URL | |
| theme_color | TEXT | ä¸»é¢˜é¢œè‰² | |
| logo_url | TEXT | Logo URL | |
| respondents | TEXT[] | å—è®¿è€…åˆ—è¡¨ | |
| response_count | INTEGER | å“åº”æ•°é‡ | |
| insights | TEXT[] | æ´å¯Ÿåˆ—è¡¨ (æ—§) | |
| quotes | JSONB[] | å¼•ç”¨åˆ—è¡¨ (æ—§) | |
| executive_summary | TEXT | ç ”ç©¶çº§æ€»ç»“ | |
| objective_deliverables | JSONB | ç›®æ ‡äº¤ä»˜ç‰© | |
| cross_interview_insights | JSONB | è·¨è®¿è°ˆæ´å¯Ÿ | |
| **draft_outline** | JSONB | **åˆç¨¿å¤§çº²** | v1.1.0+ |
| **localized_outline** | JSONB | **æœ¬åœ°åŒ–å¤§çº²** | v1.1.0+ |
| **outline_debug_language** | TEXT | **è°ƒè¯•è¯­è¨€** | v1.1.0+ |
| **outline_interview_language** | TEXT | **è®¿è°ˆè¯­è¨€** | v1.1.0+ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT NOW() |

#### questions å­—æ®µç»“æ„

```typescript
{
  id: string;              // é—®é¢˜ ID
  question: string;        // é—®é¢˜å†…å®¹
  follow_up_count: number; // è¿½é—®æ¬¡æ•°
}[]
```

#### å¤§çº²æœ¬åœ°åŒ–å­—æ®µ (v1.1.0+)

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| draft_outline | åˆç¨¿å¤§çº²ï¼ˆè°ƒè¯•è¯­è¨€ç‰ˆæœ¬ï¼‰ | ä¸­æ–‡é—®é¢˜åˆ—è¡¨ |
| localized_outline | æœ¬åœ°åŒ–å¤§çº²ï¼ˆè®¿è°ˆè¯­è¨€ç‰ˆæœ¬ï¼‰ | è‹±æ–‡é—®é¢˜åˆ—è¡¨ |
| outline_debug_language | è°ƒè¯•è¯­è¨€ä»£ç  | 'zh-CN', 'en-US' |
| outline_interview_language | è®¿è°ˆè¯­è¨€ä»£ç  | 'en-US', 'ja-JP' |

**ä½¿ç”¨åœºæ™¯**:
1. ç ”ç©¶å‘˜ç”¨ä¸­æ–‡åˆ›å»ºå’Œè°ƒè¯•å¤§çº² â†’ å­˜å‚¨åœ¨ `draft_outline`
2. ä¸€é”®æœ¬åœ°åŒ–åˆ°è‹±æ–‡ â†’ å­˜å‚¨åœ¨ `localized_outline`
3. è®¿è°ˆæ—¶ä½¿ç”¨ `questions` å­—æ®µï¼ˆå¯é€‰æ‹©åˆç¨¿æˆ–æœ¬åœ°åŒ–ç‰ˆæœ¬ï¼‰

è¯¦è§: [å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½æ–‡æ¡£](./03-å¤§çº²æœ¬åœ°åŒ–åŠŸèƒ½.md)

**å…³ç³»**:
- å¤šå¯¹ä¸€: interview â†’ user
- å¤šå¯¹ä¸€: interview â†’ organization
- å¤šå¯¹ä¸€: interview â†’ interviewer
- ä¸€å¯¹å¤š: interview â†’ response

---

### 5. response (è®¿è°ˆå“åº”è¡¨)

**ç”¨é€”**: å­˜å‚¨è®¿è°ˆå“åº”å’Œåˆ†æç»“æœ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | SERIAL | å“åº” ID | PRIMARY KEY |
| interview_id | TEXT | è®¿è°ˆ ID | FOREIGN KEY â†’ interview |
| name | TEXT | å—è®¿è€…å§“å | |
| email | TEXT | å—è®¿è€…é‚®ç®± | |
| call_id | TEXT | Retell é€šè¯ ID | |
| duration | INTEGER | é€šè¯æ—¶é•¿ï¼ˆç§’ï¼‰ | |
| details | JSONB | é€šè¯è¯¦æƒ… | åŒ…å« transcript |
| analytics | JSONB | è®¿è°ˆåˆ†æç»“æœ | |
| is_analysed | BOOLEAN | æ˜¯å¦å·²åˆ†æ | DEFAULT false |
| is_ended | BOOLEAN | æ˜¯å¦å·²ç»“æŸ | DEFAULT false |
| is_viewed | BOOLEAN | æ˜¯å¦å·²æŸ¥çœ‹ | DEFAULT false |
| candidate_status | TEXT | å€™é€‰äººçŠ¶æ€ | 'SELECTED', 'NOT_SELECTED' |
| tab_switch_count | INTEGER | åˆ‡æ¢æ ‡ç­¾æ¬¡æ•° | |
| key_insights | JSONB | å…³é”®æ´å¯Ÿ (æ—§) | å‘åå…¼å®¹ |
| important_quotes | JSONB | é‡è¦å¼•ç”¨ (æ—§) | å‘åå…¼å®¹ |
| insights_with_evidence | JSONB | æ´å¯Ÿ+è¯æ® (æ–°) | v1.0.5+ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT NOW() |

#### analytics å­—æ®µç»“æ„

```typescript
{
  softSkillSummary: string;
  questionSummaries: Array<{
    question: string;
    summary: string;
  }>;
  mainInterviewQuestions?: string[];
}
```

#### insights_with_evidence å­—æ®µç»“æ„ (v1.0.5+)

```typescript
{
  id: string;
  content: string;
  category: string;
  evidence: Array<{
    quote: string;
    timestamp: number;
    context: string;
  }>;
}[]
```

**å…³ç³»**:
- å¤šå¯¹ä¸€: response â†’ interview

---

### 6. feedback (åé¦ˆè¡¨)

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·åé¦ˆ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | SERIAL | åé¦ˆ ID | PRIMARY KEY |
| interview_id | TEXT | è®¿è°ˆ ID | FOREIGN KEY â†’ interview |
| email | TEXT | åé¦ˆè€…é‚®ç®± | |
| feedback | TEXT | åé¦ˆå†…å®¹ | |
| satisfaction | INTEGER | æ»¡æ„åº¦ (1-5) | |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT NOW() |

**å…³ç³»**:
- å¤šå¯¹ä¸€: feedback â†’ interview

---

## ğŸ”— æ•°æ®åº“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  organization   â”‚
â”‚  (ç»„ç»‡è¡¨)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:N
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚
         â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      user       â”‚  â”‚   interview     â”‚
â”‚    (ç”¨æˆ·è¡¨)     â”‚  â”‚   (è®¿è°ˆè¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:N                â”‚ 1:N
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â”‚
                              â†“
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    response     â”‚
                     â”‚   (å“åº”è¡¨)      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  interviewer    â”‚
â”‚  (é¢è¯•å®˜è¡¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1:N
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   interview     â”‚
â”‚   (è®¿è°ˆè¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ•°æ®åº“è¿ç§»

### è¿ç§»è„šæœ¬ä½ç½®

```
backend/migrations/
â”œâ”€â”€ 001_add_summary_fields.sql
â”œâ”€â”€ 002_add_localization_fields.sql
â””â”€â”€ ...
```

### é‡è¦è¿ç§»

#### v1.0.5 - æ·»åŠ æ´å¯Ÿè¯æ®å­—æ®µ

```sql
ALTER TABLE response 
ADD COLUMN IF NOT EXISTS insights_with_evidence JSONB DEFAULT '[]'::jsonb;
```

#### v1.1.0 - æ·»åŠ å¤§çº²æœ¬åœ°åŒ–å­—æ®µ

```sql
ALTER TABLE interview 
ADD COLUMN IF NOT EXISTS draft_outline JSONB,
ADD COLUMN IF NOT EXISTS localized_outline JSONB,
ADD COLUMN IF NOT EXISTS outline_debug_language TEXT,
ADD COLUMN IF NOT EXISTS outline_interview_language TEXT;
```

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢

### è·å–è®¿è°ˆåŠå…¶å“åº”

```sql
SELECT 
  i.*,
  COUNT(r.id) as response_count,
  AVG(r.duration) as avg_duration
FROM interview i
LEFT JOIN response r ON i.id = r.interview_id
WHERE i.user_id = 'user_xxx'
GROUP BY i.id;
```

### è·å–å·²åˆ†æçš„å“åº”

```sql
SELECT * FROM response
WHERE interview_id = 'interview_xxx'
AND is_analysed = true
ORDER BY created_at DESC;
```

---

**ç»´æŠ¤è€…**: Userology å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-23

