# 跨访谈洞察生成系统

> **版本**: 1.4.5
> **最后更新**: 2025-10-31

---

## 📖 系统概述

跨访谈洞察生成系统 (Study Summary) 负责从多个访谈中提取综合洞察，识别模式和趋势。系统采用两阶段 AI 生成架构：

1. **阶段 1**: 分析研究目标，提取预期交付物类型
2. **阶段 2**: 根据交付物类型生成定制化内容

---

## 🏗️ 系统架构

### 两阶段生成流程

```
多个访谈数据
    ↓
┌─────────────────────────────────────┐
│  阶段 1: 分析研究目标                │
│  - 识别交付物类型                    │
│  - 提取关键维度                      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  阶段 2: 生成定制化内容              │
│  - Executive Summary                │
│  - Objective Deliverables           │
│  - Cross-Interview Insights         │
└─────────────────────────────────────┘
    ↓
保存到 interview 表
```

### 核心组件

- **Study Summary Service**: 跨访谈分析逻辑
- **OpenAI GPT-4o**: AI 分析引擎
- **Prompt Engineering**: 两阶段 Prompt 设计

---

## 🎯 数据结构

### Study Summary 完整结构

```typescript
{
  executive_summary: string;           // 执行摘要
  objective_deliverables: {            // 目标交付物
    type: string;                      // 类型
    content: any;                      // 动态内容
  };
  cross_interview_insights: Array<{    // 跨访谈洞察
    id: string;
    title: string;
    description: string;
    category: 'consensus' | 'divergent' | 'unexpected' | 'critical';
    importance: 'high' | 'medium' | 'low';
    user_count: string;                // "4 out of 5 users"
    supporting_quotes: Array<{
      user: string;
      quote: string;
      interview_id: string;
      timestamp: number;
    }>;
  }>;
}
```

---

## 🔧 实现细节

### Study Summary Service

**文件**: `backend/src/services/study-summary.service.ts`

**核心函数**: `generateStudySummary`

```typescript
export const generateStudySummary = async (payload: {
  interviewId: string;
  selectedCallIds?: string[];
  regenerate?: boolean;
}) => {
  const { interviewId, selectedCallIds, regenerate = false } = payload;
  
  // 1. 获取访谈数据
  const interview = await InterviewService.getInterviewById(interviewId);
  
  // 2. 检查缓存
  if (!regenerate && interview.executive_summary && interview.cross_interview_insights) {
    return { summary: { ... }, status: 200 };
  }
  
  // 3. 获取所有 responses
  let responses = await ResponseService.getAllResponses(interviewId);
  
  // 4. 过滤有效 responses
  if (selectedCallIds && selectedCallIds.length > 0) {
    responses = responses.filter(r => selectedCallIds.includes(r.call_id));
  }
  
  responses = responses.filter(r => 
    r.analytics && 
    r.candidate_status !== 'NOT_SELECTED' && 
    r.is_ended === true
  );
  
  // 5. 阶段 1: 分析研究目标
  const deliverableAnalysis = await analyzeStudyObjective(studyObjective);
  
  // 6. 阶段 2: 生成内容
  const studySummary = await generateStudyContent({
    studyObjective,
    deliverableType: deliverableAnalysis.type,
    responses,
    interview
  });
  
  // 7. 保存到数据库
  await InterviewService.updateInterview({
    executive_summary: studySummary.executive_summary,
    objective_deliverables: studySummary.objective_deliverables,
    cross_interview_insights: studySummary.cross_interview_insights
  }, interviewId);
  
  return { summary: studySummary, status: 200 };
};
```

---

### 阶段 1: 分析研究目标

**目的**: 识别研究目标期望的交付物类型

**Prompt 文件**: `backend/src/lib/prompts/generate-study-summary.ts`

**System Prompt**:
```
You are an expert research analyst specializing in identifying research objectives 
and expected deliverables from user research studies.
```

**User Prompt**:
```
Analyze this research objective and identify the expected deliverables:

## Study Objective
${studyObjective}

---

Identify:
1. Deliverable Type: action_plans, pricing_analysis, pain_points, general
2. Key Dimensions: What aspects to analyze
3. Priority Areas: What matters most
```

**响应格式**:
```typescript
{
  type: 'action_plans' | 'pricing_analysis' | 'pain_points' | 'general';
  dimensions: string[];
  priorities: string[];
}
```

---

### 阶段 2: 生成定制化内容

**目的**: 根据交付物类型生成对应的内容结构

#### 类型 1: Action Plans (行动计划)

**适用场景**: 产品优化、功能改进

**内容结构**:
```typescript
{
  type: "action_plans",
  content: {
    immediate_actions: Array<{
      action: string;
      rationale: string;
      priority: 'high' | 'medium' | 'low';
      effort: 'low' | 'medium' | 'high';
      impact: 'low' | 'medium' | 'high';
    }>;
    long_term_recommendations: Array<{
      recommendation: string;
      rationale: string;
    }>;
  }
}
```

---

#### 类型 2: Pricing Analysis (定价分析)

**适用场景**: 定价策略研究

**内容结构**:
```typescript
{
  type: "pricing_analysis",
  content: {
    price_sensitivity: {
      acceptable_range: string;
      sweet_spot: string;
      resistance_points: string[];
    };
    value_perception: {
      perceived_value: string;
      comparison_to_competitors: string;
    };
    willingness_to_pay: {
      segments: Array<{
        segment: string;
        willingness: string;
        rationale: string;
      }>;
    };
  }
}
```

---

#### 类型 3: Pain Points (痛点分析)

**适用场景**: 问题发现、需求挖掘

**内容结构**:
```typescript
{
  type: "pain_points",
  content: {
    critical_pain_points: Array<{
      pain_point: string;
      severity: 'high' | 'medium' | 'low';
      frequency: string;
      user_count: string;
    }>;
    underlying_causes: Array<{
      cause: string;
      related_pain_points: string[];
    }>;
  }
}
```

---

#### 类型 4: General (通用分析)

**适用场景**: 综合性研究

**内容结构**:
```typescript
{
  type: "general",
  content: {
    key_findings: string[];
    patterns: string[];
    recommendations: string[];
  }
}
```

---

### Cross-Interview Insights

**目的**: 提取跨访谈的共性洞察

**洞察类别**:

1. **consensus**: 多数用户一致的观点
2. **divergent**: 用户间存在分歧的观点
3. **unexpected**: 意外发现
4. **critical**: 关键洞察

**生成逻辑**:
```typescript
// 1. 收集所有访谈的 insights
const allInsights = responses.flatMap(r => r.insights_with_evidence || []);

// 2. 聚类相似洞察
const clusteredInsights = clusterSimilarInsights(allInsights);

// 3. 提取跨访谈模式
const crossInterviewInsights = extractPatterns(clusteredInsights);

// 4. 添加支持引用
crossInterviewInsights.forEach(insight => {
  insight.supporting_quotes = findSupportingQuotes(insight, responses);
  insight.user_count = calculateUserCount(insight, responses);
});
```

---

## 📝 Prompt 工程

### Executive Summary Prompt

```
Based on ${responses.length} user interviews, generate an executive summary.

## Study Objective
${studyObjective}

## Deliverable Type
${deliverableType}

## Interview Data
${interviewSummaries}

---

Generate:
1. Executive Summary (2-3 paragraphs)
   - Key findings
   - Main patterns
   - Critical insights

2. Objective Deliverables (based on type: ${deliverableType})
   - Structured content matching the deliverable type

3. Cross-Interview Insights (5-8 insights)
   - Category: consensus, divergent, unexpected, critical
   - Importance: high, medium, low
   - Supporting quotes from multiple users
```

---

## 🔄 数据流

### 完整生成流程

```
1. 用户点击 "Generate Study Insights"
   ↓
2. 前端调用 API
   POST /api/analytics/study-summary
   Body: { interviewId, selectedCallIds }
   ↓
3. 后端获取所有 responses
   - 过滤有效数据
   - 提取 analytics 和 insights
   ↓
4. 阶段 1: 分析研究目标
   - 调用 OpenAI
   - 识别交付物类型
   ↓
5. 阶段 2: 生成内容
   - 调用 OpenAI
   - 生成 Executive Summary
   - 生成 Objective Deliverables
   - 生成 Cross-Interview Insights
   ↓
6. 保存到数据库
   interview.executive_summary
   interview.objective_deliverables
   interview.cross_interview_insights
   ↓
7. 返回前端显示
```

---

## 💾 数据存储

### Interview 表字段

```sql
-- 执行摘要
executive_summary TEXT

-- 目标交付物
objective_deliverables JSONB

-- 跨访谈洞察
cross_interview_insights JSONB

-- 旧字段（已废弃）
evidence_bank JSONB
```

---

## 🔄 重新生成功能

### API 端点

```
POST /api/analytics/study-summary/regenerate
```

### 实现逻辑

```typescript
export const regenerateStudySummary = async (interviewId, selectedCallIds) => {
  // 1. 清除现有总结
  await InterviewService.updateInterview({
    executive_summary: null,
    objective_deliverables: null,
    cross_interview_insights: null,
    evidence_bank: null
  }, interviewId);
  
  // 2. 重新生成
  return await generateStudySummary({ interviewId, selectedCallIds });
};
```

---

## 🎨 前端集成

### Study Insights 页面

**文件**: `frontend/src/app/interviews/[interviewId]/page.tsx`

**组件**:
- Executive Summary 卡片
- Objective Deliverables 卡片
- Cross-Interview Insights 列表
- Supporting Quotes 展示

### 生成按钮

```typescript
const handleGenerateStudyInsights = async () => {
  setLoading(true);
  
  await apiClient.post('/analytics/study-summary', {
    interviewId,
    selectedCallIds: selectedResponses.map(r => r.call_id)
  });
  
  // 刷新数据...
  setLoading(false);
};
```

---

## 🚀 性能优化

### 批量处理

- 一次性获取所有 responses
- 批量提取 insights
- 单次 AI 调用生成所有内容

### 缓存策略

- 检查现有总结，避免重复生成
- 支持增量更新（新增访谈后重新生成）

---

## 📊 质量保证

### 洞察质量标准

1. **跨访谈性**: 至少来自 2 个以上访谈
2. **证据充分**: 每个洞察有 2-4 个引用
3. **用户覆盖**: 标注影响的用户数量
4. **分类准确**: 正确识别 consensus/divergent/unexpected/critical

### 交付物质量标准

1. **类型匹配**: 与研究目标一致
2. **结构完整**: 包含所有必需字段
3. **可操作性**: 提供具体建议
4. **优先级明确**: 标注重要性和紧急性

---

## 📚 相关文档

- [访谈分析系统](./05-访谈分析系统.md)
- [数据库设计](./02-数据库设计.md)
- [技术架构](./01-技术架构.md)

---

**维护者**: Userology 开发团队
**最后更新**: 2025-10-31

